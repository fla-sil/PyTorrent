{"info": {"author": "Explosion", "author_email": "contact@explosion.ai", "bugtrack_url": null, "classifiers": ["Development Status :: 4 - Beta", "Environment :: Console", "Intended Audience :: Developers", "Intended Audience :: Science/Research", "License :: OSI Approved :: MIT License", "Operating System :: MacOS :: MacOS X", "Operating System :: Microsoft :: Windows", "Operating System :: POSIX :: Linux", "Programming Language :: Python :: 3", "Programming Language :: Python :: 3.6", "Programming Language :: Python :: 3.7", "Topic :: Scientific/Engineering", "Topic :: Scientific/Engineering :: Artificial Intelligence"], "description": "<a href=\"https://explosion.ai\"><img src=\"https://explosion.ai/assets/img/logo.svg\" width=\"125\" height=\"125\" align=\"right\" /></a>\n\n# spacy-transformers\n\nThis package (previously `spacy-pytorch-transformers`) provides\n[spaCy](https://github.com/explosion/spaCy) model pipelines that wrap\n[Hugging Face's `transformers`](https://github.com/huggingface/transformers)\npackage, so you can use them in spaCy. The result is convenient access to\nstate-of-the-art transformer architectures, such as BERT, GPT-2, XLNet, etc. For\nmore details and background, check out\n[our blog post](https://explosion.ai/blog/spacy-transformers).\n\n[![Azure Pipelines](https://img.shields.io/azure-devops/build/explosion-ai/public/11/master.svg?logo=azure-pipelines&style=flat-square)](https://dev.azure.com/explosion-ai/public/_build?definitionId=11)\n[![PyPi](https://img.shields.io/pypi/v/spacy-transformers.svg?style=flat-square&logo=pypi&logoColor=white)](https://pypi.python.org/pypi/spacy-transformers)\n[![GitHub](https://img.shields.io/github/release/explosion/spacy-transformers/all.svg?style=flat-square&logo=github)](https://github.com/explosion/spacy-transformers/releases)\n[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg?style=flat-square)](https://github.com/ambv/black)\n[![Open demo in Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/explosion/spacy-transformers/blob/master/examples/Spacy_Transformers_Demo.ipynb)\n\n## Features\n\n-   Use **BERT**, **RoBERTa**, **XLNet** and **GPT-2** directly in your spaCy\n    pipeline.\n-   **Fine-tune** pretrained transformer models on your task using spaCy's API.\n-   Custom component for **text classification** using transformer features.\n-   Automatic **alignment** of wordpieces and outputs to linguistic tokens.\n-   Process multi-sentence documents with intelligent **per-sentence\n    prediction**.\n-   Built-in hooks for **context-sensitive vectors** and similarity.\n-   Out-of-the-box serialization and model packaging.\n\n## \ud83d\ude80 Quickstart\n\nInstalling the package from pip will automatically install all dependencies,\nincluding PyTorch and spaCy. Make sure you install this package **before** you\ninstall the models. Also note that this package requires **Python 3.6+** and the\nlatest version of spaCy,\n[v2.2.1](https://github.com/explosion/spaCy/releases/tag/v2.2.1) or above.\n\n```bash\npip install spacy-transformers\n```\n\nFor GPU installation, find your CUDA version using `nvcc --version` and add the\n[version in brackets](https://spacy.io/usage/#gpu), e.g.\n`spacy-transformers[cuda92]` for CUDA9.2 or `spacy-transformers[cuda100]` for\nCUDA10.0.\n\nWe've also pre-packaged some of the pretrained models as spaCy model packages.\nYou can either use the `spacy download` command or download the packages from\nthe [model releases](https://github.com/explosion/spacy-models/releases).\n\n| Package name                      | Pretrained model          | Language | Author                                                                      |  Size |                                               Release                                               |\n| --------------------------------- | ------------------------- | -------- | --------------------------------------------------------------------------- | ----: | :-------------------------------------------------------------------------------------------------: |\n| `en_trf_bertbaseuncased_lg`       | `bert-base-uncased`       | English  | [Google Research](https://github.com/google-research/bert)                  | 387MB |    [\ud83d\udce6\ufe0f](https://github.com/explosion/spacy-models/releases/tag/en_trf_bertbaseuncased_lg-2.2.0)    |\n| `de_trf_bertbasecased_lg`         | `bert-base-german-cased`  | German   | [deepset](https://deepset.ai/german-bert)                                   | 386MB |     [\ud83d\udce6\ufe0f](https://github.com/explosion/spacy-models/releases/tag/de_trf_bertbasecased_lg-2.2.0)     |\n| `en_trf_xlnetbasecased_lg`        | `xlnet-base-cased`        | English  | [CMU/Google Brain](https://github.com/zihangdai/xlnet/)                     | 413MB |    [\ud83d\udce6\ufe0f](https://github.com/explosion/spacy-models/releases/tag/en_trf_xlnetbasecased_lg-2.2.0)     |\n| `en_trf_robertabase_lg`           | `roberta-base`            | English  | [Facebook](https://github.com/pytorch/fairseq/tree/master/examples/roberta) | 278MB |      [\ud83d\udce6\ufe0f](https://github.com/explosion/spacy-models/releases/tag/en_trf_robertabase_lg-2.2.0)      |\n| `en_trf_distilbertbaseuncased_lg` | `distilbert-base-uncased` | English  | [Hugging Face](https://medium.com/huggingface/distilbert-8cf3380435b5)      | 233MB | [\ud83d\udce6\ufe0f](https://github.com/explosion/spacy-models/releases/tag/en_trf_distilbertbaseuncased_lg-2.2.0) |\n\n```bash\npython -m spacy download en_trf_bertbaseuncased_lg\npython -m spacy download de_trf_bertbasecased_lg\npython -m spacy download en_trf_xlnetbasecased_lg\npython -m spacy download en_trf_robertabase_lg\npython -m spacy download en_trf_distilbertbaseuncased_lg\n```\n\nOnce the model is installed, you can load it in spaCy like any other model\npackage.\n\n```python\nimport spacy\n\nnlp = spacy.load(\"en_trf_bertbaseuncased_lg\")\ndoc = nlp(\"Apple shares rose on the news. Apple pie is delicious.\")\nprint(doc[0].similarity(doc[7]))\nprint(doc._.trf_last_hidden_state.shape)\n```\n\n> \ud83d\udca1 If you're seeing an error like `No module named 'spacy.lang.trf'`,\n> double-check that `spacy-transformers` is installed. It needs to be available\n> so it can register its language entry points. Also make sure that you're\n> running spaCy v2.2.1 or higher.\n\n## \ud83d\udcd6 Usage\n\n> \u26a0\ufe0f **Important note:** This package was previously called\n> `spacy-pytorch-transformers` and used attributes and pipeline components\n> prefixed with `pytt`. It's now called `spacy-transformers` and uses the prefix\n> `trf`.\n\n### Transfer learning\n\nThe main use case for pretrained transformer models is transfer learning. You\nload in a large generic model pretrained on lots of text, and start training on\nyour smaller dataset with labels specific to your problem. This package has\ncustom pipeline components that make this especially easy. We provide an example\ncomponent for text categorization. Development of analogous components for other\ntasks should be quite straight-forward.\n\nThe `trf_textcat` component is based on spaCy's built-in\n[`TextCategorizer`](https://spacy.io/api/textcategorizer) and supports using the\nfeatures assigned by the `transformers` models, via the `trf_tok2vec` component.\nThis lets you use a model like BERT to predict contextual token representations,\nand then learn a text categorizer on top as a task-specific \"head\". The API is\nthe same as any other spaCy pipeline:\n\n```python\nTRAIN_DATA = [\n    (\"text1\", {\"cats\": {\"POSITIVE\": 1.0, \"NEGATIVE\": 0.0}})\n]\n```\n\n```python\nimport spacy\nfrom spacy.util import minibatch\nimport random\nimport torch\n\nis_using_gpu = spacy.prefer_gpu()\nif is_using_gpu:\n    torch.set_default_tensor_type(\"torch.cuda.FloatTensor\")\n\nnlp = spacy.load(\"en_trf_bertbaseuncased_lg\")\nprint(nlp.pipe_names) # [\"sentencizer\", \"trf_wordpiecer\", \"trf_tok2vec\"]\ntextcat = nlp.create_pipe(\"trf_textcat\", config={\"exclusive_classes\": True})\nfor label in (\"POSITIVE\", \"NEGATIVE\"):\n    textcat.add_label(label)\nnlp.add_pipe(textcat)\n\noptimizer = nlp.resume_training()\nfor i in range(10):\n    random.shuffle(TRAIN_DATA)\n    losses = {}\n    for batch in minibatch(TRAIN_DATA, size=8):\n        texts, cats = zip(*batch)\n        nlp.update(texts, cats, sgd=optimizer, losses=losses)\n    print(i, losses)\nnlp.to_disk(\"/bert-textcat\")\n```\n\nFor a full example, see the\n[`examples/train_textcat.py` script](examples/train_textcat.py).\n\n### Vectors and similarity\n\nThe `TransformersTok2Vec` component of the model sets custom hooks that override\nthe default behaviour of the `.vector` attribute and `.similarity` method of the\n`Token`, `Span` and `Doc` objects. By default, these usually refer to the word\nvectors table at `nlp.vocab.vectors`. Naturally, in the transformer models we'd\nrather use the `doc.tensor` attribute, since it holds a much more informative\ncontext-sensitive representation.\n\n```python\napple1 = nlp(\"Apple shares rose on the news.\")\napple2 = nlp(\"Apple sold fewer iPhones this quarter.\")\napple3 = nlp(\"Apple pie is delicious.\")\nprint(apple1[0].similarity(apple2[0]))\nprint(apple1[0].similarity(apple3[0]))\n```\n\n### Serialization\n\nSaving and loading pretrained transformer models and packaging them as spaCy\nmodels \u2728just works \u2728 (at least, it should). The wrapper and components follow\nspaCy's API, so when you save and load the `nlp` object, it...\n\n-   Writes the pretrained weights to disk / bytes and loads them back in.\n-   Adds `\"lang_factory\": \"trf\"` in the `meta.json` so spaCy knows how to\n    initialize the `Language` class when you load the model.\n-   Adds this package and its version to the `\"requirements\"` in the\n    `meta.json`, so when you run\n    [`spacy package`](https://spacy.io/api/cli#package) to create an installable\n    Python package it's automatically added to the setup's `install_requires`.\n\nFor example, if you've trained your own text classifier, you can package it like\nthis:\n\n```bash\npython -m spacy package /bert-textcat /output\ncd /output/en_trf_bertbaseuncased_lg-1.0.0\npython setup.py sdist\npip install dist/en_trf_bertbaseuncased_lg-1.0.0.tar.gz\n```\n\n### Extension attributes\n\nThis wrapper sets the following\n[custom extension attributes](https://spacy.io/usage/processing-pipelines#custom-components-attributes)\non the `Doc`, `Span` and `Token` objects:\n\n| Name                         | Type              | Description                                                                                                                                                   |\n| ---------------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `._.trf_alignment`           | `List[List[int]]` | Alignment between wordpieces and spaCy tokens. Contains lists of wordpiece token indices (one per spaCy token) or a list of indices (if called on a `Token`). |\n| `._.trf_word_pieces`         | `List[int]`       | The wordpiece IDs.                                                                                                                                            |\n| `._.trf_word_pieces_`        | `List[str]`       | The string forms of the wordpiece IDs.                                                                                                                        |\n| `._.trf_last_hidden_state`   | `ndarray`         | The `last_hidden_state` output from the `transformers` model.                                                                                                 |\n| `._.trf_pooler_output`       | `List[ndarray]`   | The `pooler_output` output from the `transformers` model.                                                                                                     |\n| `._.trf_all_hidden_states`   | `List[ndarray]`   | The `all_hidden_states` output from the `transformers` model.                                                                                                 |\n| `._.all_attentions`          | `List[ndarray]`   | The `all_attentions` output from the `transformers` model.                                                                                                    |\n| `._.trf_d_last_hidden_state` | `ndarray`         | The gradient of the `last_hidden_state` output from the `transformers` model.                                                                                 |\n| `._.trf_d_pooler_output`     | `List[ndarray]`   | The gradient of the `pooler_output` output from the `transformers` model.                                                                                     |\n| `._.trf_d_all_hidden_states` | `List[ndarray]`   | The gradient of the `all_hidden_states` output from the `transformers` model.                                                                                 |\n| `._.trf_d_all_attentions`    | `List[ndarray]`   | The gradient of the `all_attentions` output from the `transformers` model.                                                                                    |\n\nThe values can be accessed via the `._` attribute. For example:\n\n```python\ndoc = nlp(\"This is a text.\")\nprint(doc._.trf_word_pieces_)\n```\n\n### Setting up the pipeline\n\nIn order to run, the `nlp` object created using `TransformersLanguage` requires\na few components to run in order: a component that assigns sentence boundaries\n(e.g. spaCy's built-in\n[`Sentencizer`](https://spacy.io/usage/linguistic-features#sbd-component)), the\n`TransformersWordPiecer`, which assigns the wordpiece tokens and the\n`TransformersTok2Vec`, which assigns the token vectors. The `trf_name` argument\ndefines the name of the pretrained model to use. The `from_pretrained` methods\nload the pretrained model via `transformers`.\n\n```python\nfrom spacy_transformers import TransformersLanguage, TransformersWordPiecer, TransformersTok2Vec\n\nname = \"bert-base-uncased\"\nnlp = TransformersLanguage(trf_name=name, meta={\"lang\": \"en\"})\nnlp.add_pipe(nlp.create_pipe(\"sentencizer\"))\nnlp.add_pipe(TransformersWordPiecer.from_pretrained(nlp.vocab, name))\nnlp.add_pipe(TransformersTok2Vec.from_pretrained(nlp.vocab, name))\nprint(nlp.pipe_names)  # ['sentencizer', 'trf_wordpiecer', 'trf_tok2vec']\n```\n\nYou can also use the [`init_model.py`](examples/init_model.py) script in the\nexamples.\n\n#### Loading models from a path\n\n`transformers` models can also be loaded from a file path instead of just a\nname. For instance, let's say you want to use Allen AI's\n[`scibert`](https://github.com/allenai/scibert). First, download the PyTorch\nmodel files, unpack them them, unpack the `weights.tar`, rename the\n`bert_config.json` to `config.json` and put everything into one directory. Your\ndirectory should now have a `pytorch_model.bin`, `vocab.txt` and `config.json`.\nAlso make sure that your path **includes the name of the model**. You can then\ninitialize the `nlp` object like this:\n\n```python\nfrom spacy_transformers import TransformersLanguage, TransformersWordPiecer, TransformersTok2Vec\n\nname = \"scibert-scivocab-uncased\"\npath = \"/path/to/scibert-scivocab-uncased\"\n\nnlp = TransformersLanguage(trf_name=name, meta={\"lang\": \"en\"})\nnlp.add_pipe(nlp.create_pipe(\"sentencizer\"))\nnlp.add_pipe(TransformersWordPiecer.from_pretrained(nlp.vocab, path))\nnlp.add_pipe(TransformersTok2Vec.from_pretrained(nlp.vocab, path))\n```\n\n### Tokenization alignment\n\nTransformer models are usually trained on text preprocessed with the \"wordpiece\"\nalgorithm, which limits the number of distinct token-types the model needs to\nconsider. Wordpiece is convenient for training neural networks, but it doesn't\nproduce segmentations that match up to any linguistic notion of a \"word\". Most\nrare words will map to multiple wordpiece tokens, and occasionally the alignment\nwill be many-to-many. `spacy-transformers` calculates this alignment, which you\ncan access at `doc._.trf_alignment`. It's a list of length equal to the number\nof spaCy tokens. Each value in the list is a list of consecutive integers, which\nare indexes into the wordpieces list.\n\nIf you can work on representations that aren't aligned to actual words, it's\nbest to use the raw outputs of the transformer, which can be accessed at\n`doc._.trf_last_hidden_state`. This variable gives you a tensor with one row per\nwordpiece token.\n\nIf you're working on token-level tasks such as part-of-speech tagging or\nspelling correction, you'll want to work on the token-aligned features, which\nare stored in the `doc.tensor` variable.\n\nWe've taken care to calculate the aligned `doc.tensor` representation as\nfaithfully as possible, with priority given to avoid information loss. The\nalignment has been calculated such that\n`doc.tensor.sum(axis=1) == doc._.trf_last_hidden_state.sum(axis=1)`. To make\nthis work, each row of the `doc.tensor` (which corresponds to a spaCy token) is\nset to a weighted sum of the rows of the `last_hidden_state` tensor that the\ntoken is aligned to, where the weighting is proportional to the number of other\nspaCy tokens aligned to that row. To include the information from the (often\nimportant --- see Clark et al., 2019) boundary tokens, we imagine that these are\nalso \"aligned\" to all of the tokens in the sentence.\n\n### Batching, padding and per-sentence processing\n\nTransformer models have cubic runtime and memory complexity with respect to\nsequence length. This means that longer texts need to be divided into sentences\nin order to achieve reasonable efficiency.\n\n`spacy-transformers` handles this internally, and requires that sort of\nsentence-boundary detection component has been added to the pipeline. We\nrecommend:\n\n```python\nsentencizer = nlp.create_pipe(\"sentencizer\")\nnlp.add_pipe(sentencizer, first=True)\n```\n\nInternally, the transformer model will predict over sentences, and the resulting\ntensor features will be reconstructed to produce document-level annotations.\n\nIn order to further improve efficiency and reduce memory requirements,\n`spacy-transformers` also performs length-based subbatching internally. The\nsubbatching regroups the batched sentences by sequence length, to minimise the\namount of padding required. The configuration option `words_per_batch` controls\nthis behaviour. You can set it to 0 to disable the subbatching, or set it to an\ninteger to require a maximum limit on the number of words (including padding)\nper subbatch. The default value of 3000 words works reasonably well on a Tesla\nV100.\n\nMany of the pretrained transformer models have a maximum sequence length. If a\nsentence is longer than the maximum, it is truncated and the affected ending\ntokens will receive zeroed vectors.\n\n## \ud83c\udf9b API\n\n### <kbd>class</kbd> `TransformersLanguage`\n\nA subclass of [`Language`](https://spacy.io/api/language) that holds a\nTransformers pipeline. Transformers pipelines work only slightly differently\nfrom spaCy's default pipelines. Specifically, we introduce a new pipeline\ncomponent at the start of the pipeline, `TransformersTok2Vec`. We then modify\nthe [`nlp.update`](https://spacy.io/api/language#update) function to run the\n`TransformersTok2Vec` before the other pipeline components, and backprop it\nafter the other components are done.\n\n#### <kbd>staticmethod</kbd> `TransformersLanguage.install_extensions`\n\nRegister the\n[custom extension attributes](https://spacy.io/usage/processing-pipelines#custom-components-attributes)\non the `Doc`, `Span` and `Token` objects. If the extensions have already been\nregistered, spaCy will raise an error. [See here](#extension-attributes) for the\nextension attributes that will be set. You shouldn't have to call this method\nyourself \u2013 it already runs when you import the package.\n\n#### <kbd>method</kbd> `TransformersLanguage.__init__`\n\nSee [`Language.__init__`](https://spacy.io/api/language#init). Expects either a\n`trf_name` setting in the `meta` or as a keyword argument, specifying the\npretrained model name. This is used to set up the model-specific tokenizer.\n\n#### <kbd>method</kbd> `TransformersLanguage.update`\n\nUpdate the models in the pipeline.\n\n| Name            | Type     | Description                                                                                                                                |\n| --------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------ |\n| `docs`          | iterable | A batch of `Doc` objects or unicode. If unicode, a `Doc` object will be created from the text.                                             |\n| `golds`         | iterable | A batch of `GoldParse` objects or dictionaries. Dictionaries will be used to create [`GoldParse`](https://spacy.io/api/goldparse) objects. |\n| `drop`          | float    | The dropout rate.                                                                                                                          |\n| `sgd`           | callable | An optimizer.                                                                                                                              |\n| `losses`        | dict     | Dictionary to update with the loss, keyed by pipeline component.                                                                           |\n| `component_cfg` | dict     | Config parameters for specific pipeline components, keyed by component name.                                                               |\n\n### <kbd>class</kbd> `TransformersWordPiecer`\n\nspaCy pipeline component to assign Transformers wordpiece tokenization to the\nDoc, which can then be used by the token vector encoder. Note that this\ncomponent doesn't modify spaCy's tokenization. It only sets extension attributes\n`trf_word_pieces_`, `trf_word_pieces` and `trf_alignment` (alignment between\nwordpiece tokens and spaCy tokens).\n\nThe component is available as `trf_wordpiecer` and registered via an entry\npoint, so it can also be created using\n[`nlp.create_pipe`](https://spacy.io/api/language#create_pipe):\n\n```python\nwordpiecer = nlp.create_pipe(\"trf_wordpiecer\")\n```\n\n#### Config\n\nThe component can be configured with the following settings, usually passed in\nas the `**cfg`.\n\n| Name       | Type    | Description                                           |\n| ---------- | ------- | ----------------------------------------------------- |\n| `trf_name` | unicode | Name of pretrained model, e.g. `\"bert-base-uncased\"`. |\n\n#### <kbd>classmethod</kbd> `TransformersWordPiecer.from_nlp`\n\nFactory to add to `Language.factories` via entry point.\n\n| Name        | Type                      | Description                                     |\n| ----------- | ------------------------- | ----------------------------------------------- |\n| `nlp`       | `spacy.language.Language` | The `nlp` object the component is created with. |\n| `**cfg`     | -                         | Optional config parameters.                     |\n| **RETURNS** | `TransformersWordPiecer`  | The wordpiecer.                                 |\n\n#### <kbd>method</kbd> `TransformersWordPiecer.__init__`\n\nInitialize the component.\n\n| Name        | Type                     | Description                                           |\n| ----------- | ------------------------ | ----------------------------------------------------- |\n| `vocab`     | `spacy.vocab.Vocab`      | The spaCy vocab to use.                               |\n| `name`      | unicode                  | Name of pretrained model, e.g. `\"bert-base-uncased\"`. |\n| `**cfg`     | -                        | Optional config parameters.                           |\n| **RETURNS** | `TransformersWordPiecer` | The wordpiecer.                                       |\n\n#### <kbd>method</kbd> `TransformersWordPiecer.predict`\n\nRun the wordpiece tokenizer on a batch of docs and return the extracted strings.\n\n| Name        | Type     | Description                                                                      |\n| ----------- | -------- | -------------------------------------------------------------------------------- |\n| `docs`      | iterable | A batch of `Doc`s to process.                                                    |\n| **RETURNS** | tuple    | A `(strings, None)` tuple. The strings are lists of strings, one list per `Doc`. |\n\n#### <kbd>method</kbd> `TransformersWordPiecer.set_annotations`\n\nAssign the extracted tokens and IDs to the `Doc` objects.\n\n| Name      | Type     | Description               |\n| --------- | -------- | ------------------------- |\n| `docs`    | iterable | A batch of `Doc` objects. |\n| `outputs` | iterable | A batch of outputs.       |\n\n### <kbd>class</kbd> `TransformersTok2Vec`\n\nspaCy pipeline component to use `transformers` models. The component assigns the\noutput of the transformer to extension attributes. We also calculate an\nalignment between the wordpiece tokens and the spaCy tokenization, so that we\ncan use the last hidden states to set the `doc.tensor` attribute. When multiple\nwordpiece tokens align to the same spaCy token, the spaCy token receives the sum\nof their values.\n\nThe component is available as `trf_tok2vec` and registered via an entry point,\nso it can also be created using\n[`nlp.create_pipe`](https://spacy.io/api/language#create_pipe):\n\n```python\ntok2vec = nlp.create_pipe(\"trf_tok2vec\")\n```\n\n#### Config\n\nThe component can be configured with the following settings, usually passed in\nas the `**cfg`.\n\n| Name              | Type    | Description                                                                                                                                                                                                                 |\n| ----------------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `trf_name`        | unicode | Name of pretrained model, e.g. `\"bert-base-uncased\"`.                                                                                                                                                                       |\n| `words_per_batch` | int     | Group sentences into subbatches of max `words_per_batch` in size. For instance, a batch with one 100 word sentence and one 10 word sentence will have size 200 (due to padding). Set to `0` to disable. Defaults to `2000`. |\n\n#### <kbd>classmethod</kbd> `TransformersTok2Vec.from_nlp`\n\nFactory to add to `Language.factories` via entry point.\n\n| Name        | Type                      | Description                                     |\n| ----------- | ------------------------- | ----------------------------------------------- |\n| `nlp`       | `spacy.language.Language` | The `nlp` object the component is created with. |\n| `**cfg`     | -                         | Optional config parameters.                     |\n| **RETURNS** | `TransformersTok2Vec`     | The token vector encoder.                       |\n\n#### <kbd>classmethod</kbd> `TransformersTok2Vec.from_pretrained`\n\nCreate a `TransformersTok2Vec` instance using pretrained weights from a\n`transformers` model, even if it's not installed as a spaCy package.\n\n```python\nfrom spacy_transformers import TransformersTok2Vec\nfrom spacy.tokens import Vocab\ntok2vec = TransformersTok2Vec.from_pretrained(Vocab(), \"bert-base-uncased\")\n```\n\n| Name        | Type                  | Description                                           |\n| ----------- | --------------------- | ----------------------------------------------------- |\n| `vocab`     | `spacy.vocab.Vocab`   | The spaCy vocab to use.                               |\n| `name`      | unicode               | Name of pretrained model, e.g. `\"bert-base-uncased\"`. |\n| `**cfg`     | -                     | Optional config parameters.                           |\n| **RETURNS** | `TransformersTok2Vec` | The token vector encoder.                             |\n\n#### <kbd>classmethod</kbd> `TransformersTok2Vec.Model`\n\nCreate an instance of `TransformersWrapper`, which holds the `transformers`\nmodel.\n\n| Name        | Type                 | Description                                           |\n| ----------- | -------------------- | ----------------------------------------------------- |\n| `name`      | unicode              | Name of pretrained model, e.g. `\"bert-base-uncased\"`. |\n| `**cfg`     | -                    | Optional config parameters.                           |\n| **RETURNS** | `thinc.neural.Model` | The wrapped model.                                    |\n\n#### <kbd>method</kbd> `TransformersTok2Vec.__init__`\n\nInitialize the component.\n\n| Name        | Type                          | Description                                             |\n| ----------- | ----------------------------- | ------------------------------------------------------- |\n| `vocab`     | `spacy.vocab.Vocab`           | The spaCy vocab to use.                                 |\n| `model`     | `thinc.neural.Model` / `True` | The component's model or `True` if not initialized yet. |\n| `**cfg`     | -                             | Optional config parameters.                             |\n| **RETURNS** | `TransformersTok2Vec`         | The token vector encoder.                               |\n\n#### <kbd>method</kbd> `TransformersTok2Vec.__call__`\n\nProcess a `Doc` and assign the extracted features.\n\n| Name        | Type               | Description           |\n| ----------- | ------------------ | --------------------- |\n| `doc`       | `spacy.tokens.Doc` | The `Doc` to process. |\n| **RETURNS** | `spacy.tokens.Doc` | The processed `Doc`.  |\n\n#### <kbd>method</kbd> `TransformersTok2Vec.pipe`\n\nProcess `Doc` objects as a stream and assign the extracted features.\n\n| Name         | Type               | Description                                       |\n| ------------ | ------------------ | ------------------------------------------------- |\n| `stream`     | iterable           | A stream of `Doc` objects.                        |\n| `batch_size` | int                | The number of texts to buffer. Defaults to `128`. |\n| **YIELDS**   | `spacy.tokens.Doc` | Processed `Doc`s in order.                        |\n\n#### <kbd>method</kbd> `TransformersTok2Vec.predict`\n\nRun the transformer model on a batch of docs and return the extracted features.\n\n| Name        | Type         | Description                         |\n| ----------- | ------------ | ----------------------------------- |\n| `docs`      | iterable     | A batch of `Doc`s to process.       |\n| **RETURNS** | `namedtuple` | Named tuple containing the outputs. |\n\n#### <kbd>method</kbd> `TransformersTok2Vec.set_annotations`\n\nAssign the extracted features to the Doc objects and overwrite the vector and\nsimilarity hooks.\n\n| Name      | Type     | Description               |\n| --------- | -------- | ------------------------- |\n| `docs`    | iterable | A batch of `Doc` objects. |\n| `outputs` | iterable | A batch of outputs.       |\n\n### <kbd>class</kbd> `TransformersTextCategorizer`\n\nSubclass of spaCy's built-in\n[`TextCategorizer`](https://spacy.io/api/textcategorizer) component that\nsupports using the features assigned by the `transformers` models via the token\nvector encoder. It requires the `TransformersTok2Vec` to run before it in the\npipeline.\n\nThe component is available as `trf_textcat` and registered via an entry point,\nso it can also be created using\n[`nlp.create_pipe`](https://spacy.io/api/language#create_pipe):\n\n```python\ntextcat = nlp.create_pipe(\"trf_textcat\")\n```\n\n#### <kbd>classmethod</kbd> `TransformersTextCategorizer.from_nlp`\n\nFactory to add to `Language.factories` via entry point.\n\n| Name        | Type                          | Description                                     |\n| ----------- | ----------------------------- | ----------------------------------------------- |\n| `nlp`       | `spacy.language.Language`     | The `nlp` object the component is created with. |\n| `**cfg`     | -                             | Optional config parameters.                     |\n| **RETURNS** | `TransformersTextCategorizer` | The text categorizer.                           |\n\n#### <kbd>classmethod</kbd> `TransformersTextCategorizer.Model`\n\nCreate a text classification model using a `transformers` model for token vector\nencoding.\n\n| Name                | Type                 | Description                                              |\n| ------------------- | -------------------- | -------------------------------------------------------- |\n| `nr_class`          | int                  | Number of classes.                                       |\n| `width`             | int                  | The width of the tensors being assigned.                 |\n| `exclusive_classes` | bool                 | Make categories mutually exclusive. Defaults to `False`. |\n| `**cfg`             | -                    | Optional config parameters.                              |\n| **RETURNS**         | `thinc.neural.Model` | The model.                                               |\n\n### <kbd>dataclass</kbd> `Activations`\n\nDataclass to hold the features produced by `transformers`.\n\n| Attribute           | Type   | Description |\n| ------------------- | ------ | ----------- |\n| `last_hidden_state` | object |             |\n| `pooler_output`     | object |             |\n| `all_hidden_states` | object |             |\n| `all_attentions`    | object |             |\n| `is_grad`           | bool   |             |\n\n### Entry points\n\nThis package exposes several\n[entry points](https://spacy.io/usage/saving-loading#entry-points) that tell\nspaCy how to initialize its components. If `spacy-transformers` and spaCy are\ninstalled in the same environment, you'll be able to run the following and it'll\nwork as expected:\n\n```python\ntok2vec = nlp.create_pipe(\"trf_tok2vec\")\n```\n\nThis also means that your custom models can ship a `trf_tok2vec` component and\ndefine `\"trf_tok2vec\"` in their pipelines, and spaCy will know how to create\nthose components when you deserialize the model. The following entry points are\nset:\n\n| Name             | Target                        | Type              | Description                      |\n| ---------------- | ----------------------------- | ----------------- | -------------------------------- |\n| `trf_wordpiecer` | `TransformersWordPiecer`      | `spacy_factories` | Factory to create the component. |\n| `trf_tok2vec`    | `TransformersTok2Vec`         | `spacy_factories` | Factory to create the component. |\n| `trf_textcat`    | `TransformersTextCategorizer` | `spacy_factories` | Factory to create the component. |\n| `trf`            | `TransformersLanguage`        | `spacy_languages` | Custom `Language` subclass.      |", "description_content_type": "text/markdown", "docs_url": null, "download_url": "", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://spacy.io", "keywords": "", "license": "MIT", "maintainer": "", "maintainer_email": "", "name": "spacy-transformers", "package_url": "https://pypi.org/project/spacy-transformers/", "platform": "", "project_url": "https://pypi.org/project/spacy-transformers/", "project_urls": {"Homepage": "https://spacy.io"}, "release_url": "https://pypi.org/project/spacy-transformers/0.5.1/", "requires_dist": null, "requires_python": ">=3.6", "summary": "spaCy pipelines for pre-trained BERT and other transformers", "version": "0.5.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <p><a href=\"https://explosion.ai\" rel=\"nofollow\"><img align=\"right\" height=\"125\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/657dbf4006ad44b146bd59acc7f61d67177af1a5/68747470733a2f2f6578706c6f73696f6e2e61692f6173736574732f696d672f6c6f676f2e737667\" width=\"125\"></a></p>\n<h1>spacy-transformers</h1>\n<p>This package (previously <code>spacy-pytorch-transformers</code>) provides\n<a href=\"https://github.com/explosion/spaCy\" rel=\"nofollow\">spaCy</a> model pipelines that wrap\n<a href=\"https://github.com/huggingface/transformers\" rel=\"nofollow\">Hugging Face's <code>transformers</code></a>\npackage, so you can use them in spaCy. The result is convenient access to\nstate-of-the-art transformer architectures, such as BERT, GPT-2, XLNet, etc. For\nmore details and background, check out\n<a href=\"https://explosion.ai/blog/spacy-transformers\" rel=\"nofollow\">our blog post</a>.</p>\n<p><a href=\"https://dev.azure.com/explosion-ai/public/_build?definitionId=11\" rel=\"nofollow\"><img alt=\"Azure Pipelines\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/b8e0462e76a99722efa598313a919dbaa2ce7b2e/68747470733a2f2f696d672e736869656c64732e696f2f617a7572652d6465766f70732f6275696c642f6578706c6f73696f6e2d61692f7075626c69632f31312f6d61737465722e7376673f6c6f676f3d617a7572652d706970656c696e6573267374796c653d666c61742d737175617265\"></a>\n<a href=\"https://pypi.python.org/pypi/spacy-transformers\" rel=\"nofollow\"><img alt=\"PyPi\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/ef5485aa0f437b0ed219c65f04d1b876ef9ba839/68747470733a2f2f696d672e736869656c64732e696f2f707970692f762f73706163792d7472616e73666f726d6572732e7376673f7374796c653d666c61742d737175617265266c6f676f3d70797069266c6f676f436f6c6f723d7768697465\"></a>\n<a href=\"https://github.com/explosion/spacy-transformers/releases\" rel=\"nofollow\"><img alt=\"GitHub\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/ee4a1f97d32688f1edd1f6e7330309d677d931d1/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f72656c656173652f6578706c6f73696f6e2f73706163792d7472616e73666f726d6572732f616c6c2e7376673f7374796c653d666c61742d737175617265266c6f676f3d676974687562\"></a>\n<a href=\"https://github.com/ambv/black\" rel=\"nofollow\"><img alt=\"Code style: black\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/1c326c58e924b9f3508f32a8ac6b3ee91f40b090/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f636f64652532307374796c652d626c61636b2d3030303030302e7376673f7374796c653d666c61742d737175617265\"></a>\n<a href=\"https://colab.research.google.com/github/explosion/spacy-transformers/blob/master/examples/Spacy_Transformers_Demo.ipynb\" rel=\"nofollow\"><img alt=\"Open demo in Colab\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/74d996556a82b2f1dd5252d2fd8bead60f9e9d21/68747470733a2f2f636f6c61622e72657365617263682e676f6f676c652e636f6d2f6173736574732f636f6c61622d62616467652e737667\"></a></p>\n<h2>Features</h2>\n<ul>\n<li>Use <strong>BERT</strong>, <strong>RoBERTa</strong>, <strong>XLNet</strong> and <strong>GPT-2</strong> directly in your spaCy\npipeline.</li>\n<li><strong>Fine-tune</strong> pretrained transformer models on your task using spaCy's API.</li>\n<li>Custom component for <strong>text classification</strong> using transformer features.</li>\n<li>Automatic <strong>alignment</strong> of wordpieces and outputs to linguistic tokens.</li>\n<li>Process multi-sentence documents with intelligent <strong>per-sentence\nprediction</strong>.</li>\n<li>Built-in hooks for <strong>context-sensitive vectors</strong> and similarity.</li>\n<li>Out-of-the-box serialization and model packaging.</li>\n</ul>\n<h2>\ud83d\ude80 Quickstart</h2>\n<p>Installing the package from pip will automatically install all dependencies,\nincluding PyTorch and spaCy. Make sure you install this package <strong>before</strong> you\ninstall the models. Also note that this package requires <strong>Python 3.6+</strong> and the\nlatest version of spaCy,\n<a href=\"https://github.com/explosion/spaCy/releases/tag/v2.2.1\" rel=\"nofollow\">v2.2.1</a> or above.</p>\n<pre>pip install spacy-transformers\n</pre>\n<p>For GPU installation, find your CUDA version using <code>nvcc --version</code> and add the\n<a href=\"https://spacy.io/usage/#gpu\" rel=\"nofollow\">version in brackets</a>, e.g.\n<code>spacy-transformers[cuda92]</code> for CUDA9.2 or <code>spacy-transformers[cuda100]</code> for\nCUDA10.0.</p>\n<p>We've also pre-packaged some of the pretrained models as spaCy model packages.\nYou can either use the <code>spacy download</code> command or download the packages from\nthe <a href=\"https://github.com/explosion/spacy-models/releases\" rel=\"nofollow\">model releases</a>.</p>\n<table>\n<thead>\n<tr>\n<th>Package name</th>\n<th>Pretrained model</th>\n<th>Language</th>\n<th>Author</th>\n<th align=\"right\">Size</th>\n<th align=\"center\">Release</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>en_trf_bertbaseuncased_lg</code></td>\n<td><code>bert-base-uncased</code></td>\n<td>English</td>\n<td><a href=\"https://github.com/google-research/bert\" rel=\"nofollow\">Google Research</a></td>\n<td align=\"right\">387MB</td>\n<td align=\"center\"><a href=\"https://github.com/explosion/spacy-models/releases/tag/en_trf_bertbaseuncased_lg-2.2.0\" rel=\"nofollow\">\ud83d\udce6\ufe0f</a></td>\n</tr>\n<tr>\n<td><code>de_trf_bertbasecased_lg</code></td>\n<td><code>bert-base-german-cased</code></td>\n<td>German</td>\n<td><a href=\"https://deepset.ai/german-bert\" rel=\"nofollow\">deepset</a></td>\n<td align=\"right\">386MB</td>\n<td align=\"center\"><a href=\"https://github.com/explosion/spacy-models/releases/tag/de_trf_bertbasecased_lg-2.2.0\" rel=\"nofollow\">\ud83d\udce6\ufe0f</a></td>\n</tr>\n<tr>\n<td><code>en_trf_xlnetbasecased_lg</code></td>\n<td><code>xlnet-base-cased</code></td>\n<td>English</td>\n<td><a href=\"https://github.com/zihangdai/xlnet/\" rel=\"nofollow\">CMU/Google Brain</a></td>\n<td align=\"right\">413MB</td>\n<td align=\"center\"><a href=\"https://github.com/explosion/spacy-models/releases/tag/en_trf_xlnetbasecased_lg-2.2.0\" rel=\"nofollow\">\ud83d\udce6\ufe0f</a></td>\n</tr>\n<tr>\n<td><code>en_trf_robertabase_lg</code></td>\n<td><code>roberta-base</code></td>\n<td>English</td>\n<td><a href=\"https://github.com/pytorch/fairseq/tree/master/examples/roberta\" rel=\"nofollow\">Facebook</a></td>\n<td align=\"right\">278MB</td>\n<td align=\"center\"><a href=\"https://github.com/explosion/spacy-models/releases/tag/en_trf_robertabase_lg-2.2.0\" rel=\"nofollow\">\ud83d\udce6\ufe0f</a></td>\n</tr>\n<tr>\n<td><code>en_trf_distilbertbaseuncased_lg</code></td>\n<td><code>distilbert-base-uncased</code></td>\n<td>English</td>\n<td><a href=\"https://medium.com/huggingface/distilbert-8cf3380435b5\" rel=\"nofollow\">Hugging Face</a></td>\n<td align=\"right\">233MB</td>\n<td align=\"center\"><a href=\"https://github.com/explosion/spacy-models/releases/tag/en_trf_distilbertbaseuncased_lg-2.2.0\" rel=\"nofollow\">\ud83d\udce6\ufe0f</a></td>\n</tr></tbody></table>\n<pre>python -m spacy download en_trf_bertbaseuncased_lg\npython -m spacy download de_trf_bertbasecased_lg\npython -m spacy download en_trf_xlnetbasecased_lg\npython -m spacy download en_trf_robertabase_lg\npython -m spacy download en_trf_distilbertbaseuncased_lg\n</pre>\n<p>Once the model is installed, you can load it in spaCy like any other model\npackage.</p>\n<pre><span class=\"kn\">import</span> <span class=\"nn\">spacy</span>\n\n<span class=\"n\">nlp</span> <span class=\"o\">=</span> <span class=\"n\">spacy</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"s2\">\"en_trf_bertbaseuncased_lg\"</span><span class=\"p\">)</span>\n<span class=\"n\">doc</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"p\">(</span><span class=\"s2\">\"Apple shares rose on the news. Apple pie is delicious.\"</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">doc</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">similarity</span><span class=\"p\">(</span><span class=\"n\">doc</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]))</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">doc</span><span class=\"o\">.</span><span class=\"n\">_</span><span class=\"o\">.</span><span class=\"n\">trf_last_hidden_state</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n</pre>\n<blockquote>\n<p>\ud83d\udca1 If you're seeing an error like <code>No module named 'spacy.lang.trf'</code>,\ndouble-check that <code>spacy-transformers</code> is installed. It needs to be available\nso it can register its language entry points. Also make sure that you're\nrunning spaCy v2.2.1 or higher.</p>\n</blockquote>\n<h2>\ud83d\udcd6 Usage</h2>\n<blockquote>\n<p>\u26a0\ufe0f <strong>Important note:</strong> This package was previously called\n<code>spacy-pytorch-transformers</code> and used attributes and pipeline components\nprefixed with <code>pytt</code>. It's now called <code>spacy-transformers</code> and uses the prefix\n<code>trf</code>.</p>\n</blockquote>\n<h3>Transfer learning</h3>\n<p>The main use case for pretrained transformer models is transfer learning. You\nload in a large generic model pretrained on lots of text, and start training on\nyour smaller dataset with labels specific to your problem. This package has\ncustom pipeline components that make this especially easy. We provide an example\ncomponent for text categorization. Development of analogous components for other\ntasks should be quite straight-forward.</p>\n<p>The <code>trf_textcat</code> component is based on spaCy's built-in\n<a href=\"https://spacy.io/api/textcategorizer\" rel=\"nofollow\"><code>TextCategorizer</code></a> and supports using the\nfeatures assigned by the <code>transformers</code> models, via the <code>trf_tok2vec</code> component.\nThis lets you use a model like BERT to predict contextual token representations,\nand then learn a text categorizer on top as a task-specific \"head\". The API is\nthe same as any other spaCy pipeline:</p>\n<pre><span class=\"n\">TRAIN_DATA</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n    <span class=\"p\">(</span><span class=\"s2\">\"text1\"</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s2\">\"cats\"</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">\"POSITIVE\"</span><span class=\"p\">:</span> <span class=\"mf\">1.0</span><span class=\"p\">,</span> <span class=\"s2\">\"NEGATIVE\"</span><span class=\"p\">:</span> <span class=\"mf\">0.0</span><span class=\"p\">}})</span>\n<span class=\"p\">]</span>\n</pre>\n<pre><span class=\"kn\">import</span> <span class=\"nn\">spacy</span>\n<span class=\"kn\">from</span> <span class=\"nn\">spacy.util</span> <span class=\"kn\">import</span> <span class=\"n\">minibatch</span>\n<span class=\"kn\">import</span> <span class=\"nn\">random</span>\n<span class=\"kn\">import</span> <span class=\"nn\">torch</span>\n\n<span class=\"n\">is_using_gpu</span> <span class=\"o\">=</span> <span class=\"n\">spacy</span><span class=\"o\">.</span><span class=\"n\">prefer_gpu</span><span class=\"p\">()</span>\n<span class=\"k\">if</span> <span class=\"n\">is_using_gpu</span><span class=\"p\">:</span>\n    <span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">set_default_tensor_type</span><span class=\"p\">(</span><span class=\"s2\">\"torch.cuda.FloatTensor\"</span><span class=\"p\">)</span>\n\n<span class=\"n\">nlp</span> <span class=\"o\">=</span> <span class=\"n\">spacy</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"s2\">\"en_trf_bertbaseuncased_lg\"</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">pipe_names</span><span class=\"p\">)</span> <span class=\"c1\"># [\"sentencizer\", \"trf_wordpiecer\", \"trf_tok2vec\"]</span>\n<span class=\"n\">textcat</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"trf_textcat\"</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">\"exclusive_classes\"</span><span class=\"p\">:</span> <span class=\"kc\">True</span><span class=\"p\">})</span>\n<span class=\"k\">for</span> <span class=\"n\">label</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">\"POSITIVE\"</span><span class=\"p\">,</span> <span class=\"s2\">\"NEGATIVE\"</span><span class=\"p\">):</span>\n    <span class=\"n\">textcat</span><span class=\"o\">.</span><span class=\"n\">add_label</span><span class=\"p\">(</span><span class=\"n\">label</span><span class=\"p\">)</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">textcat</span><span class=\"p\">)</span>\n\n<span class=\"n\">optimizer</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">resume_training</span><span class=\"p\">()</span>\n<span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">):</span>\n    <span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">shuffle</span><span class=\"p\">(</span><span class=\"n\">TRAIN_DATA</span><span class=\"p\">)</span>\n    <span class=\"n\">losses</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"k\">for</span> <span class=\"n\">batch</span> <span class=\"ow\">in</span> <span class=\"n\">minibatch</span><span class=\"p\">(</span><span class=\"n\">TRAIN_DATA</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">8</span><span class=\"p\">):</span>\n        <span class=\"n\">texts</span><span class=\"p\">,</span> <span class=\"n\">cats</span> <span class=\"o\">=</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">batch</span><span class=\"p\">)</span>\n        <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">texts</span><span class=\"p\">,</span> <span class=\"n\">cats</span><span class=\"p\">,</span> <span class=\"n\">sgd</span><span class=\"o\">=</span><span class=\"n\">optimizer</span><span class=\"p\">,</span> <span class=\"n\">losses</span><span class=\"o\">=</span><span class=\"n\">losses</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">losses</span><span class=\"p\">)</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">to_disk</span><span class=\"p\">(</span><span class=\"s2\">\"/bert-textcat\"</span><span class=\"p\">)</span>\n</pre>\n<p>For a full example, see the\n<a href=\"examples/train_textcat.py\" rel=\"nofollow\"><code>examples/train_textcat.py</code> script</a>.</p>\n<h3>Vectors and similarity</h3>\n<p>The <code>TransformersTok2Vec</code> component of the model sets custom hooks that override\nthe default behaviour of the <code>.vector</code> attribute and <code>.similarity</code> method of the\n<code>Token</code>, <code>Span</code> and <code>Doc</code> objects. By default, these usually refer to the word\nvectors table at <code>nlp.vocab.vectors</code>. Naturally, in the transformer models we'd\nrather use the <code>doc.tensor</code> attribute, since it holds a much more informative\ncontext-sensitive representation.</p>\n<pre><span class=\"n\">apple1</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"p\">(</span><span class=\"s2\">\"Apple shares rose on the news.\"</span><span class=\"p\">)</span>\n<span class=\"n\">apple2</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"p\">(</span><span class=\"s2\">\"Apple sold fewer iPhones this quarter.\"</span><span class=\"p\">)</span>\n<span class=\"n\">apple3</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"p\">(</span><span class=\"s2\">\"Apple pie is delicious.\"</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">apple1</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">similarity</span><span class=\"p\">(</span><span class=\"n\">apple2</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]))</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">apple1</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">similarity</span><span class=\"p\">(</span><span class=\"n\">apple3</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]))</span>\n</pre>\n<h3>Serialization</h3>\n<p>Saving and loading pretrained transformer models and packaging them as spaCy\nmodels \u2728just works \u2728 (at least, it should). The wrapper and components follow\nspaCy's API, so when you save and load the <code>nlp</code> object, it...</p>\n<ul>\n<li>Writes the pretrained weights to disk / bytes and loads them back in.</li>\n<li>Adds <code>\"lang_factory\": \"trf\"</code> in the <code>meta.json</code> so spaCy knows how to\ninitialize the <code>Language</code> class when you load the model.</li>\n<li>Adds this package and its version to the <code>\"requirements\"</code> in the\n<code>meta.json</code>, so when you run\n<a href=\"https://spacy.io/api/cli#package\" rel=\"nofollow\"><code>spacy package</code></a> to create an installable\nPython package it's automatically added to the setup's <code>install_requires</code>.</li>\n</ul>\n<p>For example, if you've trained your own text classifier, you can package it like\nthis:</p>\n<pre>python -m spacy package /bert-textcat /output\n<span class=\"nb\">cd</span> /output/en_trf_bertbaseuncased_lg-1.0.0\npython setup.py sdist\npip install dist/en_trf_bertbaseuncased_lg-1.0.0.tar.gz\n</pre>\n<h3>Extension attributes</h3>\n<p>This wrapper sets the following\n<a href=\"https://spacy.io/usage/processing-pipelines#custom-components-attributes\" rel=\"nofollow\">custom extension attributes</a>\non the <code>Doc</code>, <code>Span</code> and <code>Token</code> objects:</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>._.trf_alignment</code></td>\n<td><code>List[List[int]]</code></td>\n<td>Alignment between wordpieces and spaCy tokens. Contains lists of wordpiece token indices (one per spaCy token) or a list of indices (if called on a <code>Token</code>).</td>\n</tr>\n<tr>\n<td><code>._.trf_word_pieces</code></td>\n<td><code>List[int]</code></td>\n<td>The wordpiece IDs.</td>\n</tr>\n<tr>\n<td><code>._.trf_word_pieces_</code></td>\n<td><code>List[str]</code></td>\n<td>The string forms of the wordpiece IDs.</td>\n</tr>\n<tr>\n<td><code>._.trf_last_hidden_state</code></td>\n<td><code>ndarray</code></td>\n<td>The <code>last_hidden_state</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_pooler_output</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The <code>pooler_output</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_all_hidden_states</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The <code>all_hidden_states</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.all_attentions</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The <code>all_attentions</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_d_last_hidden_state</code></td>\n<td><code>ndarray</code></td>\n<td>The gradient of the <code>last_hidden_state</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_d_pooler_output</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The gradient of the <code>pooler_output</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_d_all_hidden_states</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The gradient of the <code>all_hidden_states</code> output from the <code>transformers</code> model.</td>\n</tr>\n<tr>\n<td><code>._.trf_d_all_attentions</code></td>\n<td><code>List[ndarray]</code></td>\n<td>The gradient of the <code>all_attentions</code> output from the <code>transformers</code> model.</td>\n</tr></tbody></table>\n<p>The values can be accessed via the <code>._</code> attribute. For example:</p>\n<pre><span class=\"n\">doc</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"p\">(</span><span class=\"s2\">\"This is a text.\"</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">doc</span><span class=\"o\">.</span><span class=\"n\">_</span><span class=\"o\">.</span><span class=\"n\">trf_word_pieces_</span><span class=\"p\">)</span>\n</pre>\n<h3>Setting up the pipeline</h3>\n<p>In order to run, the <code>nlp</code> object created using <code>TransformersLanguage</code> requires\na few components to run in order: a component that assigns sentence boundaries\n(e.g. spaCy's built-in\n<a href=\"https://spacy.io/usage/linguistic-features#sbd-component\" rel=\"nofollow\"><code>Sentencizer</code></a>), the\n<code>TransformersWordPiecer</code>, which assigns the wordpiece tokens and the\n<code>TransformersTok2Vec</code>, which assigns the token vectors. The <code>trf_name</code> argument\ndefines the name of the pretrained model to use. The <code>from_pretrained</code> methods\nload the pretrained model via <code>transformers</code>.</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">spacy_transformers</span> <span class=\"kn\">import</span> <span class=\"n\">TransformersLanguage</span><span class=\"p\">,</span> <span class=\"n\">TransformersWordPiecer</span><span class=\"p\">,</span> <span class=\"n\">TransformersTok2Vec</span>\n\n<span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s2\">\"bert-base-uncased\"</span>\n<span class=\"n\">nlp</span> <span class=\"o\">=</span> <span class=\"n\">TransformersLanguage</span><span class=\"p\">(</span><span class=\"n\">trf_name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">\"lang\"</span><span class=\"p\">:</span> <span class=\"s2\">\"en\"</span><span class=\"p\">})</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"sentencizer\"</span><span class=\"p\">))</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">TransformersWordPiecer</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">vocab</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">))</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">TransformersTok2Vec</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">vocab</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">))</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">pipe_names</span><span class=\"p\">)</span>  <span class=\"c1\"># ['sentencizer', 'trf_wordpiecer', 'trf_tok2vec']</span>\n</pre>\n<p>You can also use the <a href=\"examples/init_model.py\" rel=\"nofollow\"><code>init_model.py</code></a> script in the\nexamples.</p>\n<h4>Loading models from a path</h4>\n<p><code>transformers</code> models can also be loaded from a file path instead of just a\nname. For instance, let's say you want to use Allen AI's\n<a href=\"https://github.com/allenai/scibert\" rel=\"nofollow\"><code>scibert</code></a>. First, download the PyTorch\nmodel files, unpack them them, unpack the <code>weights.tar</code>, rename the\n<code>bert_config.json</code> to <code>config.json</code> and put everything into one directory. Your\ndirectory should now have a <code>pytorch_model.bin</code>, <code>vocab.txt</code> and <code>config.json</code>.\nAlso make sure that your path <strong>includes the name of the model</strong>. You can then\ninitialize the <code>nlp</code> object like this:</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">spacy_transformers</span> <span class=\"kn\">import</span> <span class=\"n\">TransformersLanguage</span><span class=\"p\">,</span> <span class=\"n\">TransformersWordPiecer</span><span class=\"p\">,</span> <span class=\"n\">TransformersTok2Vec</span>\n\n<span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s2\">\"scibert-scivocab-uncased\"</span>\n<span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"s2\">\"/path/to/scibert-scivocab-uncased\"</span>\n\n<span class=\"n\">nlp</span> <span class=\"o\">=</span> <span class=\"n\">TransformersLanguage</span><span class=\"p\">(</span><span class=\"n\">trf_name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">\"lang\"</span><span class=\"p\">:</span> <span class=\"s2\">\"en\"</span><span class=\"p\">})</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"sentencizer\"</span><span class=\"p\">))</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">TransformersWordPiecer</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">vocab</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">))</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">TransformersTok2Vec</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">vocab</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">))</span>\n</pre>\n<h3>Tokenization alignment</h3>\n<p>Transformer models are usually trained on text preprocessed with the \"wordpiece\"\nalgorithm, which limits the number of distinct token-types the model needs to\nconsider. Wordpiece is convenient for training neural networks, but it doesn't\nproduce segmentations that match up to any linguistic notion of a \"word\". Most\nrare words will map to multiple wordpiece tokens, and occasionally the alignment\nwill be many-to-many. <code>spacy-transformers</code> calculates this alignment, which you\ncan access at <code>doc._.trf_alignment</code>. It's a list of length equal to the number\nof spaCy tokens. Each value in the list is a list of consecutive integers, which\nare indexes into the wordpieces list.</p>\n<p>If you can work on representations that aren't aligned to actual words, it's\nbest to use the raw outputs of the transformer, which can be accessed at\n<code>doc._.trf_last_hidden_state</code>. This variable gives you a tensor with one row per\nwordpiece token.</p>\n<p>If you're working on token-level tasks such as part-of-speech tagging or\nspelling correction, you'll want to work on the token-aligned features, which\nare stored in the <code>doc.tensor</code> variable.</p>\n<p>We've taken care to calculate the aligned <code>doc.tensor</code> representation as\nfaithfully as possible, with priority given to avoid information loss. The\nalignment has been calculated such that\n<code>doc.tensor.sum(axis=1) == doc._.trf_last_hidden_state.sum(axis=1)</code>. To make\nthis work, each row of the <code>doc.tensor</code> (which corresponds to a spaCy token) is\nset to a weighted sum of the rows of the <code>last_hidden_state</code> tensor that the\ntoken is aligned to, where the weighting is proportional to the number of other\nspaCy tokens aligned to that row. To include the information from the (often\nimportant --- see Clark et al., 2019) boundary tokens, we imagine that these are\nalso \"aligned\" to all of the tokens in the sentence.</p>\n<h3>Batching, padding and per-sentence processing</h3>\n<p>Transformer models have cubic runtime and memory complexity with respect to\nsequence length. This means that longer texts need to be divided into sentences\nin order to achieve reasonable efficiency.</p>\n<p><code>spacy-transformers</code> handles this internally, and requires that sort of\nsentence-boundary detection component has been added to the pipeline. We\nrecommend:</p>\n<pre><span class=\"n\">sentencizer</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"sentencizer\"</span><span class=\"p\">)</span>\n<span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">add_pipe</span><span class=\"p\">(</span><span class=\"n\">sentencizer</span><span class=\"p\">,</span> <span class=\"n\">first</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</pre>\n<p>Internally, the transformer model will predict over sentences, and the resulting\ntensor features will be reconstructed to produce document-level annotations.</p>\n<p>In order to further improve efficiency and reduce memory requirements,\n<code>spacy-transformers</code> also performs length-based subbatching internally. The\nsubbatching regroups the batched sentences by sequence length, to minimise the\namount of padding required. The configuration option <code>words_per_batch</code> controls\nthis behaviour. You can set it to 0 to disable the subbatching, or set it to an\ninteger to require a maximum limit on the number of words (including padding)\nper subbatch. The default value of 3000 words works reasonably well on a Tesla\nV100.</p>\n<p>Many of the pretrained transformer models have a maximum sequence length. If a\nsentence is longer than the maximum, it is truncated and the affected ending\ntokens will receive zeroed vectors.</p>\n<h2>\ud83c\udf9b API</h2>\n<h3><kbd>class</kbd> <code>TransformersLanguage</code></h3>\n<p>A subclass of <a href=\"https://spacy.io/api/language\" rel=\"nofollow\"><code>Language</code></a> that holds a\nTransformers pipeline. Transformers pipelines work only slightly differently\nfrom spaCy's default pipelines. Specifically, we introduce a new pipeline\ncomponent at the start of the pipeline, <code>TransformersTok2Vec</code>. We then modify\nthe <a href=\"https://spacy.io/api/language#update\" rel=\"nofollow\"><code>nlp.update</code></a> function to run the\n<code>TransformersTok2Vec</code> before the other pipeline components, and backprop it\nafter the other components are done.</p>\n<h4><kbd>staticmethod</kbd> <code>TransformersLanguage.install_extensions</code></h4>\n<p>Register the\n<a href=\"https://spacy.io/usage/processing-pipelines#custom-components-attributes\" rel=\"nofollow\">custom extension attributes</a>\non the <code>Doc</code>, <code>Span</code> and <code>Token</code> objects. If the extensions have already been\nregistered, spaCy will raise an error. <a href=\"#extension-attributes\" rel=\"nofollow\">See here</a> for the\nextension attributes that will be set. You shouldn't have to call this method\nyourself \u2013 it already runs when you import the package.</p>\n<h4><kbd>method</kbd> <code>TransformersLanguage.__init__</code></h4>\n<p>See <a href=\"https://spacy.io/api/language#init\" rel=\"nofollow\"><code>Language.__init__</code></a>. Expects either a\n<code>trf_name</code> setting in the <code>meta</code> or as a keyword argument, specifying the\npretrained model name. This is used to set up the model-specific tokenizer.</p>\n<h4><kbd>method</kbd> <code>TransformersLanguage.update</code></h4>\n<p>Update the models in the pipeline.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docs</code></td>\n<td>iterable</td>\n<td>A batch of <code>Doc</code> objects or unicode. If unicode, a <code>Doc</code> object will be created from the text.</td>\n</tr>\n<tr>\n<td><code>golds</code></td>\n<td>iterable</td>\n<td>A batch of <code>GoldParse</code> objects or dictionaries. Dictionaries will be used to create <a href=\"https://spacy.io/api/goldparse\" rel=\"nofollow\"><code>GoldParse</code></a> objects.</td>\n</tr>\n<tr>\n<td><code>drop</code></td>\n<td>float</td>\n<td>The dropout rate.</td>\n</tr>\n<tr>\n<td><code>sgd</code></td>\n<td>callable</td>\n<td>An optimizer.</td>\n</tr>\n<tr>\n<td><code>losses</code></td>\n<td>dict</td>\n<td>Dictionary to update with the loss, keyed by pipeline component.</td>\n</tr>\n<tr>\n<td><code>component_cfg</code></td>\n<td>dict</td>\n<td>Config parameters for specific pipeline components, keyed by component name.</td>\n</tr></tbody></table>\n<h3><kbd>class</kbd> <code>TransformersWordPiecer</code></h3>\n<p>spaCy pipeline component to assign Transformers wordpiece tokenization to the\nDoc, which can then be used by the token vector encoder. Note that this\ncomponent doesn't modify spaCy's tokenization. It only sets extension attributes\n<code>trf_word_pieces_</code>, <code>trf_word_pieces</code> and <code>trf_alignment</code> (alignment between\nwordpiece tokens and spaCy tokens).</p>\n<p>The component is available as <code>trf_wordpiecer</code> and registered via an entry\npoint, so it can also be created using\n<a href=\"https://spacy.io/api/language#create_pipe\" rel=\"nofollow\"><code>nlp.create_pipe</code></a>:</p>\n<pre><span class=\"n\">wordpiecer</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"trf_wordpiecer\"</span><span class=\"p\">)</span>\n</pre>\n<h4>Config</h4>\n<p>The component can be configured with the following settings, usually passed in\nas the <code>**cfg</code>.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>trf_name</code></td>\n<td>unicode</td>\n<td>Name of pretrained model, e.g. <code>\"bert-base-uncased\"</code>.</td>\n</tr></tbody></table>\n<h4><kbd>classmethod</kbd> <code>TransformersWordPiecer.from_nlp</code></h4>\n<p>Factory to add to <code>Language.factories</code> via entry point.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>nlp</code></td>\n<td><code>spacy.language.Language</code></td>\n<td>The <code>nlp</code> object the component is created with.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersWordPiecer</code></td>\n<td>The wordpiecer.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersWordPiecer.__init__</code></h4>\n<p>Initialize the component.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>vocab</code></td>\n<td><code>spacy.vocab.Vocab</code></td>\n<td>The spaCy vocab to use.</td>\n</tr>\n<tr>\n<td><code>name</code></td>\n<td>unicode</td>\n<td>Name of pretrained model, e.g. <code>\"bert-base-uncased\"</code>.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersWordPiecer</code></td>\n<td>The wordpiecer.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersWordPiecer.predict</code></h4>\n<p>Run the wordpiece tokenizer on a batch of docs and return the extracted strings.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docs</code></td>\n<td>iterable</td>\n<td>A batch of <code>Doc</code>s to process.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td>tuple</td>\n<td>A <code>(strings, None)</code> tuple. The strings are lists of strings, one list per <code>Doc</code>.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersWordPiecer.set_annotations</code></h4>\n<p>Assign the extracted tokens and IDs to the <code>Doc</code> objects.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docs</code></td>\n<td>iterable</td>\n<td>A batch of <code>Doc</code> objects.</td>\n</tr>\n<tr>\n<td><code>outputs</code></td>\n<td>iterable</td>\n<td>A batch of outputs.</td>\n</tr></tbody></table>\n<h3><kbd>class</kbd> <code>TransformersTok2Vec</code></h3>\n<p>spaCy pipeline component to use <code>transformers</code> models. The component assigns the\noutput of the transformer to extension attributes. We also calculate an\nalignment between the wordpiece tokens and the spaCy tokenization, so that we\ncan use the last hidden states to set the <code>doc.tensor</code> attribute. When multiple\nwordpiece tokens align to the same spaCy token, the spaCy token receives the sum\nof their values.</p>\n<p>The component is available as <code>trf_tok2vec</code> and registered via an entry point,\nso it can also be created using\n<a href=\"https://spacy.io/api/language#create_pipe\" rel=\"nofollow\"><code>nlp.create_pipe</code></a>:</p>\n<pre><span class=\"n\">tok2vec</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"trf_tok2vec\"</span><span class=\"p\">)</span>\n</pre>\n<h4>Config</h4>\n<p>The component can be configured with the following settings, usually passed in\nas the <code>**cfg</code>.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>trf_name</code></td>\n<td>unicode</td>\n<td>Name of pretrained model, e.g. <code>\"bert-base-uncased\"</code>.</td>\n</tr>\n<tr>\n<td><code>words_per_batch</code></td>\n<td>int</td>\n<td>Group sentences into subbatches of max <code>words_per_batch</code> in size. For instance, a batch with one 100 word sentence and one 10 word sentence will have size 200 (due to padding). Set to <code>0</code> to disable. Defaults to <code>2000</code>.</td>\n</tr></tbody></table>\n<h4><kbd>classmethod</kbd> <code>TransformersTok2Vec.from_nlp</code></h4>\n<p>Factory to add to <code>Language.factories</code> via entry point.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>nlp</code></td>\n<td><code>spacy.language.Language</code></td>\n<td>The <code>nlp</code> object the component is created with.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersTok2Vec</code></td>\n<td>The token vector encoder.</td>\n</tr></tbody></table>\n<h4><kbd>classmethod</kbd> <code>TransformersTok2Vec.from_pretrained</code></h4>\n<p>Create a <code>TransformersTok2Vec</code> instance using pretrained weights from a\n<code>transformers</code> model, even if it's not installed as a spaCy package.</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">spacy_transformers</span> <span class=\"kn\">import</span> <span class=\"n\">TransformersTok2Vec</span>\n<span class=\"kn\">from</span> <span class=\"nn\">spacy.tokens</span> <span class=\"kn\">import</span> <span class=\"n\">Vocab</span>\n<span class=\"n\">tok2vec</span> <span class=\"o\">=</span> <span class=\"n\">TransformersTok2Vec</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"n\">Vocab</span><span class=\"p\">(),</span> <span class=\"s2\">\"bert-base-uncased\"</span><span class=\"p\">)</span>\n</pre>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>vocab</code></td>\n<td><code>spacy.vocab.Vocab</code></td>\n<td>The spaCy vocab to use.</td>\n</tr>\n<tr>\n<td><code>name</code></td>\n<td>unicode</td>\n<td>Name of pretrained model, e.g. <code>\"bert-base-uncased\"</code>.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersTok2Vec</code></td>\n<td>The token vector encoder.</td>\n</tr></tbody></table>\n<h4><kbd>classmethod</kbd> <code>TransformersTok2Vec.Model</code></h4>\n<p>Create an instance of <code>TransformersWrapper</code>, which holds the <code>transformers</code>\nmodel.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>name</code></td>\n<td>unicode</td>\n<td>Name of pretrained model, e.g. <code>\"bert-base-uncased\"</code>.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>thinc.neural.Model</code></td>\n<td>The wrapped model.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersTok2Vec.__init__</code></h4>\n<p>Initialize the component.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>vocab</code></td>\n<td><code>spacy.vocab.Vocab</code></td>\n<td>The spaCy vocab to use.</td>\n</tr>\n<tr>\n<td><code>model</code></td>\n<td><code>thinc.neural.Model</code> / <code>True</code></td>\n<td>The component's model or <code>True</code> if not initialized yet.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersTok2Vec</code></td>\n<td>The token vector encoder.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersTok2Vec.__call__</code></h4>\n<p>Process a <code>Doc</code> and assign the extracted features.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>doc</code></td>\n<td><code>spacy.tokens.Doc</code></td>\n<td>The <code>Doc</code> to process.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>spacy.tokens.Doc</code></td>\n<td>The processed <code>Doc</code>.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersTok2Vec.pipe</code></h4>\n<p>Process <code>Doc</code> objects as a stream and assign the extracted features.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>stream</code></td>\n<td>iterable</td>\n<td>A stream of <code>Doc</code> objects.</td>\n</tr>\n<tr>\n<td><code>batch_size</code></td>\n<td>int</td>\n<td>The number of texts to buffer. Defaults to <code>128</code>.</td>\n</tr>\n<tr>\n<td><strong>YIELDS</strong></td>\n<td><code>spacy.tokens.Doc</code></td>\n<td>Processed <code>Doc</code>s in order.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersTok2Vec.predict</code></h4>\n<p>Run the transformer model on a batch of docs and return the extracted features.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docs</code></td>\n<td>iterable</td>\n<td>A batch of <code>Doc</code>s to process.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>namedtuple</code></td>\n<td>Named tuple containing the outputs.</td>\n</tr></tbody></table>\n<h4><kbd>method</kbd> <code>TransformersTok2Vec.set_annotations</code></h4>\n<p>Assign the extracted features to the Doc objects and overwrite the vector and\nsimilarity hooks.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>docs</code></td>\n<td>iterable</td>\n<td>A batch of <code>Doc</code> objects.</td>\n</tr>\n<tr>\n<td><code>outputs</code></td>\n<td>iterable</td>\n<td>A batch of outputs.</td>\n</tr></tbody></table>\n<h3><kbd>class</kbd> <code>TransformersTextCategorizer</code></h3>\n<p>Subclass of spaCy's built-in\n<a href=\"https://spacy.io/api/textcategorizer\" rel=\"nofollow\"><code>TextCategorizer</code></a> component that\nsupports using the features assigned by the <code>transformers</code> models via the token\nvector encoder. It requires the <code>TransformersTok2Vec</code> to run before it in the\npipeline.</p>\n<p>The component is available as <code>trf_textcat</code> and registered via an entry point,\nso it can also be created using\n<a href=\"https://spacy.io/api/language#create_pipe\" rel=\"nofollow\"><code>nlp.create_pipe</code></a>:</p>\n<pre><span class=\"n\">textcat</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"trf_textcat\"</span><span class=\"p\">)</span>\n</pre>\n<h4><kbd>classmethod</kbd> <code>TransformersTextCategorizer.from_nlp</code></h4>\n<p>Factory to add to <code>Language.factories</code> via entry point.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>nlp</code></td>\n<td><code>spacy.language.Language</code></td>\n<td>The <code>nlp</code> object the component is created with.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>TransformersTextCategorizer</code></td>\n<td>The text categorizer.</td>\n</tr></tbody></table>\n<h4><kbd>classmethod</kbd> <code>TransformersTextCategorizer.Model</code></h4>\n<p>Create a text classification model using a <code>transformers</code> model for token vector\nencoding.</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>nr_class</code></td>\n<td>int</td>\n<td>Number of classes.</td>\n</tr>\n<tr>\n<td><code>width</code></td>\n<td>int</td>\n<td>The width of the tensors being assigned.</td>\n</tr>\n<tr>\n<td><code>exclusive_classes</code></td>\n<td>bool</td>\n<td>Make categories mutually exclusive. Defaults to <code>False</code>.</td>\n</tr>\n<tr>\n<td><code>**cfg</code></td>\n<td>-</td>\n<td>Optional config parameters.</td>\n</tr>\n<tr>\n<td><strong>RETURNS</strong></td>\n<td><code>thinc.neural.Model</code></td>\n<td>The model.</td>\n</tr></tbody></table>\n<h3><kbd>dataclass</kbd> <code>Activations</code></h3>\n<p>Dataclass to hold the features produced by <code>transformers</code>.</p>\n<table>\n<thead>\n<tr>\n<th>Attribute</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>last_hidden_state</code></td>\n<td>object</td>\n<td></td>\n</tr>\n<tr>\n<td><code>pooler_output</code></td>\n<td>object</td>\n<td></td>\n</tr>\n<tr>\n<td><code>all_hidden_states</code></td>\n<td>object</td>\n<td></td>\n</tr>\n<tr>\n<td><code>all_attentions</code></td>\n<td>object</td>\n<td></td>\n</tr>\n<tr>\n<td><code>is_grad</code></td>\n<td>bool</td>\n<td></td>\n</tr></tbody></table>\n<h3>Entry points</h3>\n<p>This package exposes several\n<a href=\"https://spacy.io/usage/saving-loading#entry-points\" rel=\"nofollow\">entry points</a> that tell\nspaCy how to initialize its components. If <code>spacy-transformers</code> and spaCy are\ninstalled in the same environment, you'll be able to run the following and it'll\nwork as expected:</p>\n<pre><span class=\"n\">tok2vec</span> <span class=\"o\">=</span> <span class=\"n\">nlp</span><span class=\"o\">.</span><span class=\"n\">create_pipe</span><span class=\"p\">(</span><span class=\"s2\">\"trf_tok2vec\"</span><span class=\"p\">)</span>\n</pre>\n<p>This also means that your custom models can ship a <code>trf_tok2vec</code> component and\ndefine <code>\"trf_tok2vec\"</code> in their pipelines, and spaCy will know how to create\nthose components when you deserialize the model. The following entry points are\nset:</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Target</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>trf_wordpiecer</code></td>\n<td><code>TransformersWordPiecer</code></td>\n<td><code>spacy_factories</code></td>\n<td>Factory to create the component.</td>\n</tr>\n<tr>\n<td><code>trf_tok2vec</code></td>\n<td><code>TransformersTok2Vec</code></td>\n<td><code>spacy_factories</code></td>\n<td>Factory to create the component.</td>\n</tr>\n<tr>\n<td><code>trf_textcat</code></td>\n<td><code>TransformersTextCategorizer</code></td>\n<td><code>spacy_factories</code></td>\n<td>Factory to create the component.</td>\n</tr>\n<tr>\n<td><code>trf</code></td>\n<td><code>TransformersLanguage</code></td>\n<td><code>spacy_languages</code></td>\n<td>Custom <code>Language</code> subclass.</td>\n</tr></tbody></table>\n\n          </div>"}, "last_serial": 6044420, "releases": {"0.5.0": [{"comment_text": "", "digests": {"md5": "02b8f39ffa0aab8d2efac38fdbf79747", "sha256": "0b92a0392e98708b589c336e485dab43babd70bf5c6867ff1c57f70ebbbd0056"}, "downloads": -1, "filename": "spacy-transformers-0.5.0.tar.gz", "has_sig": false, "md5_digest": "02b8f39ffa0aab8d2efac38fdbf79747", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 58362, "upload_time": "2019-10-08T13:00:29", "upload_time_iso_8601": "2019-10-08T13:00:29.222784Z", "url": "https://files.pythonhosted.org/packages/f9/61/f4ee085b51a98407de5adecc9dbdc4fb9ff23d0c63342f1846b69acb5ce8/spacy-transformers-0.5.0.tar.gz", "yanked": false}], "0.5.0.dev0": [{"comment_text": "", "digests": {"md5": "406bf2ff7a36d03065442701b5e39e56", "sha256": "33227b719598e995bddfe6dd5df30f9fa6bf606206e6ba663bb1779c1f65d522"}, "downloads": -1, "filename": "spacy-transformers-0.5.0.dev0.tar.gz", "has_sig": false, "md5_digest": "406bf2ff7a36d03065442701b5e39e56", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 57482, "upload_time": "2019-10-08T00:24:32", "upload_time_iso_8601": "2019-10-08T00:24:32.071978Z", "url": "https://files.pythonhosted.org/packages/12/11/ae6d4f5f72191d73120a39d9c7735d7c9f7eb43f5e2bcea89bf5d5458dd4/spacy-transformers-0.5.0.dev0.tar.gz", "yanked": false}], "0.5.0.dev1": [{"comment_text": "", "digests": {"md5": "48087fbd0932e23c46b15e365c41dfa5", "sha256": "f3bb2ac6146bfdb54285a12e4ab1e85e7a1af11d12064279f27a8a79d162c461"}, "downloads": -1, "filename": "spacy-transformers-0.5.0.dev1.tar.gz", "has_sig": false, "md5_digest": "48087fbd0932e23c46b15e365c41dfa5", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 57578, "upload_time": "2019-10-08T10:14:08", "upload_time_iso_8601": "2019-10-08T10:14:08.894782Z", "url": "https://files.pythonhosted.org/packages/af/53/936f894418f6c3f8d273c7371ccbdc257cf588478bcda4ace8b97132d7a3/spacy-transformers-0.5.0.dev1.tar.gz", "yanked": false}], "0.5.1": [{"comment_text": "", "digests": {"md5": "57997629f6538fa978f3735ff69d41e9", "sha256": "dd4e07c20deb15e02227a05de49f9eba775b1553cd5e2b8ce35b6ac10577f2e5"}, "downloads": -1, "filename": "spacy-transformers-0.5.1.tar.gz", "has_sig": false, "md5_digest": "57997629f6538fa978f3735ff69d41e9", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 59298, "upload_time": "2019-10-28T23:14:03", "upload_time_iso_8601": "2019-10-28T23:14:03.094204Z", "url": "https://files.pythonhosted.org/packages/16/fb/5dbcf7391d6ba0003fb922737340bff5033729f9c967f08f0468259c4f6a/spacy-transformers-0.5.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "57997629f6538fa978f3735ff69d41e9", "sha256": "dd4e07c20deb15e02227a05de49f9eba775b1553cd5e2b8ce35b6ac10577f2e5"}, "downloads": -1, "filename": "spacy-transformers-0.5.1.tar.gz", "has_sig": false, "md5_digest": "57997629f6538fa978f3735ff69d41e9", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 59298, "upload_time": "2019-10-28T23:14:03", "upload_time_iso_8601": "2019-10-28T23:14:03.094204Z", "url": "https://files.pythonhosted.org/packages/16/fb/5dbcf7391d6ba0003fb922737340bff5033729f9c967f08f0468259c4f6a/spacy-transformers-0.5.1.tar.gz", "yanked": false}], "timestamp": "Fri May  8 03:06:02 2020"}