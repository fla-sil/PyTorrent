{"info": {"author": "Cloud Custodian Project", "author_email": "", "bugtrack_url": null, "classifiers": [], "description": "# c7n-trailcreator:  Retroactive Resource Creator Tagging\n\nThis script will process cloudtrail records to create a sqlite db of\nresources and their creators, and then use that sqlitedb to tag\nthe resources with their creator's name.\n\nIn processing cloudtrail it can use either Athena or S3 Select. A\nconfig file of the events and resources of interest is required.\n\n## Install\n\n```shell\n$ pip install c7n_trailcreator\n\n$ c7n-trailcreator --help\n```\n\n## Config File\n\nThe config file format here is similiar to what custodian requires\nfor lambda policies on cloudtrail api events as an event selector.\n\nFirst for each resource, the custodian resource-type is required\nto be specified, and then for each event, we need to know the\nname of the service, the event name, and a jmespath expression\nto get the resource ids.\n\nHere's a a few examples, covering iam-user, iam-role, and and an s3 bucket.\n\n\n```json\n{\n  \"resources\": [\n    {\n      \"resource\": \"iam-role\",\n      \"events\": [\n        {\n          \"event\": \"CreateRole\",\n          \"ids\": \"requestParameters.roleName\",\n          \"service\": \"iam.amazonaws.com\"\n        }\n      ]\n    },\n    {\n      \"resource\": \"s3\",\n      \"events\": [\n        {\n          \"ids\": \"requestParameters.bucketName\",\n          \"event\": \"CreateBucket\",\n          \"service\": \"s3.amazonaws.com\"\n        }\n      ]\n    },\n    {\n      \"resource\": \"iam-user\",\n      \"events\": [\n        {\n          \"event\": \"CreateUser\",\n          \"ids\": \"requestParameters.userName\",\n          \"service\": \"iam.amazonaws.com\"\n        }\n      ]\n    }]\n}\n```\n\n## Athena Usage\n\nTrail creators supports loading data from s3 using s3 select or from cloudtrail s3 using athena.\n\nNote you'll have to pre-created the athena table for cloudtrail previously per\nhttps://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html\n\nLet's use the example config file to load up data for all the roles, buckets, and users created in 2019\n\n```\nc7n-trailcreator load-athena \\\n    --region us-east-1 \\\n\t--resource-map resource_map.json \\\n\t--table cloudtrail_logs_custodian_skunk_trails \\\n\t--db \"creators.db\" \\\n\t--year 2019\n```\n\nBy default we'll use the default s3 athena output used by the console,\nand the default db and primary workgroup, you can pass all of these in\non the cli to be more explicit.\n\nYou can also specify to just process a month with `--month 2019/11` or\nan individual day with `--day 2019/02/01`\n\n```\nINFO:c7n_trailowner:Athena query:569712dc-d1e9-4474-b86f-6579c53b5b46\nINFO:c7n_trailowner:Polling athena query progress scanned:489.24 Mb qexec:28.62s\nINFO:c7n_trailowner:Polling athena query progress scanned:1.29 Gb qexec:88.96s\nINFO:c7n_trailowner:Polling athena query progress scanned:2.17 Gb qexec:141.16s\nINFO:c7n_trailowner:processing athena result page 78 records\nINFO:c7n_trailowner:Athena Processed 78 records\n```\n\nNote you can reprocess a completed query's results, by passing in `--query-id` on the cli.\n\n## Tagging\n\nIt supports this across all the resources that custodian supports.\n\n```\n$ c7n-trailcreator tag \\\n\t--db creators.db \\\n\t--creator-tag Owner \\\n\t--region us-east-1\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 13 iam-role resources users:5 population:97 not-found:84 records:124\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 5 iam-user resources users:4 population:6 not-found:1 records:18\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 9 s3 resources users:4 population:14 not-found:5 records:20\nINFO:c7n_trailowner:auto tag summary account:644160558196 region:us-east-1\n iam-role-not-found: 84\n iam-role: 13\n iam-user-not-found: 1\n iam-user: 5\n s3-not-found: 5\n s3: 9\nINFO:c7n_trailowner:Total resources tagged: 27\n```\n\nlet's break down one of these log messages\n\n```\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 13 iam-role resources users:5 population:97 not-found:84 records:124\n```\n\n- records: the count of database create events we have for this resource type.\n- users: the number of unique users for whom we have create events.\n- not-found: the number of resources for whom we do not have create events, ie created before or after our trail analysis period.\n- population: the total number of resources in the account region.\n\n## Multi Account / Multi Region\n\nc7n-trailcreator supports executing across multiple accounts and regions when tagging\nusing the same file format that c7n-org uses to denote accounts. See `tag-org` subcommand.\n\n\n\n", "description_content_type": "text/markdown", "docs_url": null, "download_url": "", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://cloudcustodian.io", "keywords": "", "license": "", "maintainer": "", "maintainer_email": "", "name": "c7n-trailcreator", "package_url": "https://pypi.org/project/c7n-trailcreator/", "platform": "", "project_url": "https://pypi.org/project/c7n-trailcreator/", "project_urls": {"Homepage": "https://cloudcustodian.io"}, "release_url": "https://pypi.org/project/c7n-trailcreator/0.2.0/", "requires_dist": ["argcomplete (==1.11.1)", "attrs (==19.3.0)", "boto3 (==1.12.47)", "botocore (==1.15.47)", "c7n (==0.9.1)", "c7n-org (==0.6.0)", "click (==7.1.2)", "docutils (==0.15.2)", "importlib-metadata (==1.6.0)", "jmespath (==0.9.5)", "jsonschema (==3.2.0)", "pyrsistent (==0.16.0)", "python-dateutil (==2.8.1)", "pyyaml (==5.3.1)", "s3transfer (==0.3.3)", "six (==1.14.0)", "tabulate (==0.8.7)", "urllib3 (==1.25.9)", "zipp (==3.1.0)"], "requires_python": ">=3.6,<4.0", "summary": "Cloud Custodian - Retroactive Tag Resource Creators from CloudTrail", "version": "0.2.0", "yanked": false, "html_description": "<div class=\"project-description\">\n            <h1>c7n-trailcreator:  Retroactive Resource Creator Tagging</h1>\n<p>This script will process cloudtrail records to create a sqlite db of\nresources and their creators, and then use that sqlitedb to tag\nthe resources with their creator's name.</p>\n<p>In processing cloudtrail it can use either Athena or S3 Select. A\nconfig file of the events and resources of interest is required.</p>\n<h2>Install</h2>\n<pre>$ pip install c7n_trailcreator\n\n$ c7n-trailcreator --help\n</pre>\n<h2>Config File</h2>\n<p>The config file format here is similiar to what custodian requires\nfor lambda policies on cloudtrail api events as an event selector.</p>\n<p>First for each resource, the custodian resource-type is required\nto be specified, and then for each event, we need to know the\nname of the service, the event name, and a jmespath expression\nto get the resource ids.</p>\n<p>Here's a a few examples, covering iam-user, iam-role, and and an s3 bucket.</p>\n<pre><span class=\"p\">{</span>\n  <span class=\"nt\">\"resources\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"resource\"</span><span class=\"p\">:</span> <span class=\"s2\">\"iam-role\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"events\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"event\"</span><span class=\"p\">:</span> <span class=\"s2\">\"CreateRole\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"ids\"</span><span class=\"p\">:</span> <span class=\"s2\">\"requestParameters.roleName\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"service\"</span><span class=\"p\">:</span> <span class=\"s2\">\"iam.amazonaws.com\"</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"resource\"</span><span class=\"p\">:</span> <span class=\"s2\">\"s3\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"events\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"ids\"</span><span class=\"p\">:</span> <span class=\"s2\">\"requestParameters.bucketName\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"event\"</span><span class=\"p\">:</span> <span class=\"s2\">\"CreateBucket\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"service\"</span><span class=\"p\">:</span> <span class=\"s2\">\"s3.amazonaws.com\"</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"resource\"</span><span class=\"p\">:</span> <span class=\"s2\">\"iam-user\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"events\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span>\n          <span class=\"nt\">\"event\"</span><span class=\"p\">:</span> <span class=\"s2\">\"CreateUser\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"ids\"</span><span class=\"p\">:</span> <span class=\"s2\">\"requestParameters.userName\"</span><span class=\"p\">,</span>\n          <span class=\"nt\">\"service\"</span><span class=\"p\">:</span> <span class=\"s2\">\"iam.amazonaws.com\"</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">}]</span>\n<span class=\"p\">}</span>\n</pre>\n<h2>Athena Usage</h2>\n<p>Trail creators supports loading data from s3 using s3 select or from cloudtrail s3 using athena.</p>\n<p>Note you'll have to pre-created the athena table for cloudtrail previously per\n<a href=\"https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html\" rel=\"nofollow\">https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html</a></p>\n<p>Let's use the example config file to load up data for all the roles, buckets, and users created in 2019</p>\n<pre><code>c7n-trailcreator load-athena \\\n    --region us-east-1 \\\n\t--resource-map resource_map.json \\\n\t--table cloudtrail_logs_custodian_skunk_trails \\\n\t--db \"creators.db\" \\\n\t--year 2019\n</code></pre>\n<p>By default we'll use the default s3 athena output used by the console,\nand the default db and primary workgroup, you can pass all of these in\non the cli to be more explicit.</p>\n<p>You can also specify to just process a month with <code>--month 2019/11</code> or\nan individual day with <code>--day 2019/02/01</code></p>\n<pre><code>INFO:c7n_trailowner:Athena query:569712dc-d1e9-4474-b86f-6579c53b5b46\nINFO:c7n_trailowner:Polling athena query progress scanned:489.24 Mb qexec:28.62s\nINFO:c7n_trailowner:Polling athena query progress scanned:1.29 Gb qexec:88.96s\nINFO:c7n_trailowner:Polling athena query progress scanned:2.17 Gb qexec:141.16s\nINFO:c7n_trailowner:processing athena result page 78 records\nINFO:c7n_trailowner:Athena Processed 78 records\n</code></pre>\n<p>Note you can reprocess a completed query's results, by passing in <code>--query-id</code> on the cli.</p>\n<h2>Tagging</h2>\n<p>It supports this across all the resources that custodian supports.</p>\n<pre><code>$ c7n-trailcreator tag \\\n\t--db creators.db \\\n\t--creator-tag Owner \\\n\t--region us-east-1\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 13 iam-role resources users:5 population:97 not-found:84 records:124\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 5 iam-user resources users:4 population:6 not-found:1 records:18\nINFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 9 s3 resources users:4 population:14 not-found:5 records:20\nINFO:c7n_trailowner:auto tag summary account:644160558196 region:us-east-1\n iam-role-not-found: 84\n iam-role: 13\n iam-user-not-found: 1\n iam-user: 5\n s3-not-found: 5\n s3: 9\nINFO:c7n_trailowner:Total resources tagged: 27\n</code></pre>\n<p>let's break down one of these log messages</p>\n<pre><code>INFO:c7n_trailowner:account:644160558196 region:us-east-1 tag 13 iam-role resources users:5 population:97 not-found:84 records:124\n</code></pre>\n<ul>\n<li>records: the count of database create events we have for this resource type.</li>\n<li>users: the number of unique users for whom we have create events.</li>\n<li>not-found: the number of resources for whom we do not have create events, ie created before or after our trail analysis period.</li>\n<li>population: the total number of resources in the account region.</li>\n</ul>\n<h2>Multi Account / Multi Region</h2>\n<p>c7n-trailcreator supports executing across multiple accounts and regions when tagging\nusing the same file format that c7n-org uses to denote accounts. See <code>tag-org</code> subcommand.</p>\n\n          </div>"}, "last_serial": 7121467, "releases": {"0.1": [{"comment_text": "", "digests": {"md5": "f6620fc7dc61ed18f58e9775cda94a92", "sha256": "ab3fbdd97180ea4953e7fe4bf0763b09015a621e6f839765c1db90c8f6fe5eec"}, "downloads": -1, "filename": "c7n_trailcreator-0.1.tar.gz", "has_sig": false, "md5_digest": "f6620fc7dc61ed18f58e9775cda94a92", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 1311, "upload_time": "2019-05-11T12:24:11", "upload_time_iso_8601": "2019-05-11T12:24:11.433023Z", "url": "https://files.pythonhosted.org/packages/b2/c4/bd130d7af5ae3e088f255f38a4c78ac2fe40537f38f96d16da8d08869cb9/c7n_trailcreator-0.1.tar.gz", "yanked": false}], "0.1.1": [{"comment_text": "", "digests": {"md5": "4ebd383ecc7e0e576c9c5142e4d7bfbb", "sha256": "5bd4e9fc1adf000e1e638ca6032df42acdf5d8164c6e2d698e5ffbbdbc9ad26f"}, "downloads": -1, "filename": "c7n_trailcreator-0.1.1.tar.gz", "has_sig": false, "md5_digest": "4ebd383ecc7e0e576c9c5142e4d7bfbb", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 2025, "upload_time": "2019-05-11T12:27:42", "upload_time_iso_8601": "2019-05-11T12:27:42.352203Z", "url": "https://files.pythonhosted.org/packages/21/7b/0b81c768c72885bfa80f507f9ded1c3945446345c25ea33dbea72e4153b5/c7n_trailcreator-0.1.1.tar.gz", "yanked": false}], "0.1.2": [{"comment_text": "", "digests": {"md5": "02917b1597eb3e31cb2250d449e6f9b7", "sha256": "aa015655dc63f002d2852757386dde979333d9db87b08a4675fdececd82520a9"}, "downloads": -1, "filename": "c7n_trailcreator-0.1.2.tar.gz", "has_sig": false, "md5_digest": "02917b1597eb3e31cb2250d449e6f9b7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 2043, "upload_time": "2019-05-14T14:59:55", "upload_time_iso_8601": "2019-05-14T14:59:55.085406Z", "url": "https://files.pythonhosted.org/packages/f0/ec/9fba246762951275d6f9556eaae4885bc52ff32c8334a46e69c33cc9b4cf/c7n_trailcreator-0.1.2.tar.gz", "yanked": false}], "0.1.4": [{"comment_text": "", "digests": {"md5": "24e03ab4c14c5224bf7c93e6443e1397", "sha256": "fd84ce3fe5c517e302caaa12f9d839ed313880213c6a954e398c1f7918c4c24e"}, "downloads": -1, "filename": "c7n_trailcreator-0.1.4.tar.gz", "has_sig": false, "md5_digest": "24e03ab4c14c5224bf7c93e6443e1397", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 10203, "upload_time": "2019-06-18T16:33:15", "upload_time_iso_8601": "2019-06-18T16:33:15.422366Z", "url": "https://files.pythonhosted.org/packages/7a/37/f7b5f536c69388b5a05b0b6f30eb007c20916f2a035969e9a243b60591be/c7n_trailcreator-0.1.4.tar.gz", "yanked": false}], "0.1.5": [{"comment_text": "", "digests": {"md5": "f56f1186401c5477c92a8d6c7dfa3561", "sha256": "b963816a4990ca14c2457e429e2e6db6c0d695954b0e18a5fd6c1748f46569e9"}, "downloads": -1, "filename": "c7n_trailcreator-0.1.5.tar.gz", "has_sig": false, "md5_digest": "f56f1186401c5477c92a8d6c7dfa3561", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 13069, "upload_time": "2020-01-09T02:25:18", "upload_time_iso_8601": "2020-01-09T02:25:18.890701Z", "url": "https://files.pythonhosted.org/packages/10/2d/94314e07098e309b246933a51af4baac9f470cdb0d7f79399268719e4846/c7n_trailcreator-0.1.5.tar.gz", "yanked": false}], "0.2.0": [{"comment_text": "", "digests": {"md5": "9006a3c8e294fb44ba9c0621b21eebc9", "sha256": "be2a2c5e70df169b3155ad470f0dc6987e8af6a3c413c3039af0be466f50d99d"}, "downloads": -1, "filename": "c7n_trailcreator-0.2.0-py3-none-any.whl", "has_sig": false, "md5_digest": "9006a3c8e294fb44ba9c0621b21eebc9", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.6,<4.0", "size": 11896, "upload_time": "2020-04-28T16:22:16", "upload_time_iso_8601": "2020-04-28T16:22:16.504095Z", "url": "https://files.pythonhosted.org/packages/08/e5/af630d81812d6e83285609c3d9ac60b1c7357f283ac76f410fe881386c48/c7n_trailcreator-0.2.0-py3-none-any.whl", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "9006a3c8e294fb44ba9c0621b21eebc9", "sha256": "be2a2c5e70df169b3155ad470f0dc6987e8af6a3c413c3039af0be466f50d99d"}, "downloads": -1, "filename": "c7n_trailcreator-0.2.0-py3-none-any.whl", "has_sig": false, "md5_digest": "9006a3c8e294fb44ba9c0621b21eebc9", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.6,<4.0", "size": 11896, "upload_time": "2020-04-28T16:22:16", "upload_time_iso_8601": "2020-04-28T16:22:16.504095Z", "url": "https://files.pythonhosted.org/packages/08/e5/af630d81812d6e83285609c3d9ac60b1c7357f283ac76f410fe881386c48/c7n_trailcreator-0.2.0-py3-none-any.whl", "yanked": false}], "timestamp": "Thu May  7 22:35:46 2020"}