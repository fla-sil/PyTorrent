{"info": {"author": "Peter Coles", "author_email": "peter@ringly.com", "bugtrack_url": null, "classifiers": ["Development Status :: 2 - Pre-Alpha", "Environment :: Web Environment", "Framework :: Django", "Intended Audience :: Developers", "License :: OSI Approved :: MIT License", "Operating System :: OS Independent", "Programming Language :: Python", "Programming Language :: Python :: 2.7", "Programming Language :: Python :: 3.3", "Programming Language :: Python :: 3.4"], "description": "django-postgres-dbdefaults\n==========================\n\n\nA clone of `django.db.backends.postgresql` that supports database defaults. For use with Django 1.9.x.\n\n\nMotivation - better support database migrations with rolling web server updates\n-------------------------------------------------------------------------------\n\nThe Django migrations (new in Django 1.7) do not insert default values into the database. I would like database defaults to allow me to update the database with new migrations while it is still running an older version of a web app. For example, the majority of my updates follow this general pattern:\n\n1.  remove one machine from my production load balancer\n2.  run the latest database migrations for the database used by all production web servers\n3.  update the code on my machine that is out of the load balancer and verify things work directly on that server\n4.  udpate the remaining web servers with the latest code\n\nThis creates a delay between the database update and the newest code, which could lead to failed database inserts during that period if a column is not null and its default is not set in the database.\n\nSome people suggest creating an additional data migration script to add the defaults by hand, which would help solve the problem, but (a) this is easy to miss and (b) I\u2019m guessing this would create a brief window of time where the column exists without a default and could still lead to a failed insert.\n\nFurthermore, some of the [existing documentation](https://docs.djangoproject.com/en/1.7/topics/migrations/#postgresql) is vague and doesn\u2019t make it clear that database defaults are not included in migrations.\n\n\nSolution\n--------\n\nFor the `django.db.backends.postgresql` module, I have noticed that it actually adds the defaults in the db when it creates columns, but then it removes them in a separate SQL statement. As a result, I have made a subclass of the module that overrides the one string that drops the default and replaces it with a no-op. (This is admittedly a hack, but appears to be the most minimal approach that will survive more updates than copy-pasting large sections of the original class.)\n\nFor example `postgresql` might generate SQL for a migration as such:\n\n::\n\n    $ python3 manage.py sqlmigrate app 0010\n    BEGIN;\n    ALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" SET DEFAULT false;\n    ALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" DROP DEFAULT;\n    COMMIT;\n\nWith this change, the same migration script turns the 2nd command into a no-op:\n\n::\n\n    $ python3 manage.py sqlmigrate app 0010\n    BEGIN;\n    ALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" SET DEFAULT false;\n    ALTER TABLE \"my_table\" DROP COLUMN IF EXISTS skip_django_drop_default_feature RESTRICT;\n    COMMIT;\n\nFurthermore, there's no need to worry about migrations that intend to do `DROP DEFAULT`, because the django migrations code already doesn't do anything in SQL for such a change, it would actually look like this:\n\n::\n\n    $ python3 manage.py sqlmigrate app 0011\n    BEGIN;\n    --\n    -- Alter field some_column on my_table\n    --\n\n    COMMIT;\n\n\nDiscussion\n----------\n\nI have been using this in production on ringly.com for over a year and safely avoided running into the issues such as a new char field with `null=False` and `default=''` from causing insert errors while some app servers are on new code and others are still on the old code.\n\nI would love to hear ideas that people have about this approach\u2014it seems like it may have been controversial in the past? In my limited use with it, it appears to solve my needs, but I haven\u2019t seen what happens in more complex scenarios such as using a callable for a default (IMO it\u2019s reasonable not to support that specific scenario).\n\nSome discussion on django-developers:\n\n*   [Defaults in the database?](https://groups.google.com/forum/#!searchin/django-developers/database$20defaults/django-developers/aQtt9fKHvjM/H59CaQycDSsJ) - Nov 13, 2006 - 0 replies\n*   [defaults in sql (postgres)](https://groups.google.com/forum/#!searchin/django-developers/database$20defaults/django-developers/fHjzttZTkzc/oXbrpBa0dHAJ) - Oct 23, 2007 - 4 replies\n\nAnother thought, it maybe adding more flags to migrations that allows deeper customization, but more flags and feature bloat are definitely dangerous things with any framework.\n\nRegardless of what I end up using, I have setup a more rigorous workflow for review migrations before developers push them into our release branch.", "description_content_type": null, "docs_url": null, "download_url": "UNKNOWN", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://github.com/ringly/django-postgres-dbdefaults", "keywords": null, "license": "UNKNOWN", "maintainer": null, "maintainer_email": null, "name": "django-postgres-dbdefaults", "package_url": "https://pypi.org/project/django-postgres-dbdefaults/", "platform": "UNKNOWN", "project_url": "https://pypi.org/project/django-postgres-dbdefaults/", "project_urls": {"Download": "UNKNOWN", "Homepage": "https://github.com/ringly/django-postgres-dbdefaults"}, "release_url": "https://pypi.org/project/django-postgres-dbdefaults/0.1.1/", "requires_dist": null, "requires_python": null, "summary": "Maintain database defaults in django sql migrations (instead of dropping them).", "version": "0.1.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <p>A clone of <cite>django.db.backends.postgresql</cite> that supports database defaults. For use with Django 1.9.x.</p>\n<div id=\"motivation-better-support-database-migrations-with-rolling-web-server-updates\">\n<h2>Motivation - better support database migrations with rolling web server updates</h2>\n<p>The Django migrations (new in Django 1.7) do not insert default values into the database. I would like database defaults to allow me to update the database with new migrations while it is still running an older version of a web app. For example, the majority of my updates follow this general pattern:</p>\n<ol>\n<li>remove one machine from my production load balancer</li>\n<li>run the latest database migrations for the database used by all production web servers</li>\n<li>update the code on my machine that is out of the load balancer and verify things work directly on that server</li>\n<li>udpate the remaining web servers with the latest code</li>\n</ol>\n<p>This creates a delay between the database update and the newest code, which could lead to failed database inserts during that period if a column is not null and its default is not set in the database.</p>\n<p>Some people suggest creating an additional data migration script to add the defaults by hand, which would help solve the problem, but (a) this is easy to miss and (b) I\u2019m guessing this would create a brief window of time where the column exists without a default and could still lead to a failed insert.</p>\n<p>Furthermore, some of the [existing documentation](<a href=\"https://docs.djangoproject.com/en/1.7/topics/migrations/#postgresql\" rel=\"nofollow\">https://docs.djangoproject.com/en/1.7/topics/migrations/#postgresql</a>) is vague and doesn\u2019t make it clear that database defaults are not included in migrations.</p>\n</div>\n<div id=\"solution\">\n<h2>Solution</h2>\n<p>For the <cite>django.db.backends.postgresql</cite> module, I have noticed that it actually adds the defaults in the db when it creates columns, but then it removes them in a separate SQL statement. As a result, I have made a subclass of the module that overrides the one string that drops the default and replaces it with a no-op. (This is admittedly a hack, but appears to be the most minimal approach that will survive more updates than copy-pasting large sections of the original class.)</p>\n<p>For example <cite>postgresql</cite> might generate SQL for a migration as such:</p>\n<pre>$ python3 manage.py sqlmigrate app 0010\nBEGIN;\nALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" SET DEFAULT false;\nALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" DROP DEFAULT;\nCOMMIT;\n</pre>\n<p>With this change, the same migration script turns the 2nd command into a no-op:</p>\n<pre>$ python3 manage.py sqlmigrate app 0010\nBEGIN;\nALTER TABLE \"my_table\" ALTER COLUMN \"some_column\" SET DEFAULT false;\nALTER TABLE \"my_table\" DROP COLUMN IF EXISTS skip_django_drop_default_feature RESTRICT;\nCOMMIT;\n</pre>\n<p>Furthermore, there\u2019s no need to worry about migrations that intend to do <cite>DROP DEFAULT</cite>, because the django migrations code already doesn\u2019t do anything in SQL for such a change, it would actually look like this:</p>\n<pre>$ python3 manage.py sqlmigrate app 0011\nBEGIN;\n--\n-- Alter field some_column on my_table\n--\n\nCOMMIT;\n</pre>\n</div>\n<div id=\"discussion\">\n<h2>Discussion</h2>\n<p>I have been using this in production on ringly.com for over a year and safely avoided running into the issues such as a new char field with <cite>null=False</cite> and <cite>default=\u2019\u2019</cite> from causing insert errors while some app servers are on new code and others are still on the old code.</p>\n<p>I would love to hear ideas that people have about this approach\u2014it seems like it may have been controversial in the past? In my limited use with it, it appears to solve my needs, but I haven\u2019t seen what happens in more complex scenarios such as using a callable for a default (IMO it\u2019s reasonable not to support that specific scenario).</p>\n<p>Some discussion on django-developers:</p>\n<ul>\n<li>[Defaults in the database?](<a href=\"https://groups.google.com/forum/#!searchin/django-developers/database%2420defaults/django-developers/aQtt9fKHvjM/H59CaQycDSsJ\" rel=\"nofollow\">https://groups.google.com/forum/#!searchin/django-developers/database$20defaults/django-developers/aQtt9fKHvjM/H59CaQycDSsJ</a>) - Nov 13, 2006 - 0 replies</li>\n<li>[defaults in sql (postgres)](<a href=\"https://groups.google.com/forum/#!searchin/django-developers/database%2420defaults/django-developers/fHjzttZTkzc/oXbrpBa0dHAJ\" rel=\"nofollow\">https://groups.google.com/forum/#!searchin/django-developers/database$20defaults/django-developers/fHjzttZTkzc/oXbrpBa0dHAJ</a>) - Oct 23, 2007 - 4 replies</li>\n</ul>\n<p>Another thought, it maybe adding more flags to migrations that allows deeper customization, but more flags and feature bloat are definitely dangerous things with any framework.</p>\n<p>Regardless of what I end up using, I have setup a more rigorous workflow for review migrations before developers push them into our release branch.</p>\n</div>\n\n          </div>"}, "last_serial": 2087307, "releases": {"0.0.1": [{"comment_text": "", "digests": {"md5": "7a54e1ecd259583d7a3e84d591b8abfa", "sha256": "ba4dad6781af37f5e283addfdfc9d56d2a09f7a02f261a97413653b4f56917c8"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.0.1.tar.gz", "has_sig": false, "md5_digest": "7a54e1ecd259583d7a3e84d591b8abfa", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 6130, "upload_time": "2014-10-30T15:40:32", "upload_time_iso_8601": "2014-10-30T15:40:32.846136Z", "url": "https://files.pythonhosted.org/packages/f2/e4/ae707ed4496cb7bb492866f9893e2d583796fe4d79d1bfd9bb06b0b403c0/django-postgres-dbdefaults-0.0.1.tar.gz", "yanked": false}], "0.0.2": [{"comment_text": "", "digests": {"md5": "35a85424eeb1365071ac427fa1692078", "sha256": "55e4474f4cfe1e086e6ec3eef50aabb4ade054a9832f91a2014947fbfb7b1d73"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.0.2.tar.gz", "has_sig": false, "md5_digest": "35a85424eeb1365071ac427fa1692078", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 7049, "upload_time": "2014-10-30T18:55:40", "upload_time_iso_8601": "2014-10-30T18:55:40.584022Z", "url": "https://files.pythonhosted.org/packages/7d/c9/9e2fc13f717a99383e85041c3509d8514453fea264d05c22519568f616e7/django-postgres-dbdefaults-0.0.2.tar.gz", "yanked": false}], "0.0.3": [{"comment_text": "", "digests": {"md5": "dd02e8b702ce8b7707bcc451424a79c5", "sha256": "f64ef580d7187e9814c1ab1f17b73a7269d952aced3489c10cb6498f58bc14e1"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.0.3.tar.gz", "has_sig": false, "md5_digest": "dd02e8b702ce8b7707bcc451424a79c5", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 7409, "upload_time": "2015-08-14T17:12:44", "upload_time_iso_8601": "2015-08-14T17:12:44.826735Z", "url": "https://files.pythonhosted.org/packages/35/7e/749a5c3512ff83eae29f748a866a518889ff043861b94b52a65971c4be39/django-postgres-dbdefaults-0.0.3.tar.gz", "yanked": false}], "0.1.0": [{"comment_text": "", "digests": {"md5": "1211ebf325790fab31240bdb263246a7", "sha256": "19eb20c89e375c0cc7ee594e4965de76a370095b1208cc20917f53bf798a2cfd"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.1.0.tar.gz", "has_sig": false, "md5_digest": "1211ebf325790fab31240bdb263246a7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 4178, "upload_time": "2016-04-27T18:10:09", "upload_time_iso_8601": "2016-04-27T18:10:09.093566Z", "url": "https://files.pythonhosted.org/packages/d1/d9/31b289f49f720b6c5099e67aba05012bd19da960bc09f2fc2ea1a9050816/django-postgres-dbdefaults-0.1.0.tar.gz", "yanked": false}], "0.1.1": [{"comment_text": "", "digests": {"md5": "2e96d9fac5909fdb4b0c924ec5179db7", "sha256": "05bfcd6339607d333acc5f0e2096b62c5aa28d8e6b3a8b2e728aae4cc4feff42"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.1.1.tar.gz", "has_sig": false, "md5_digest": "2e96d9fac5909fdb4b0c924ec5179db7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 4898, "upload_time": "2016-04-27T18:18:29", "upload_time_iso_8601": "2016-04-27T18:18:29.149015Z", "url": "https://files.pythonhosted.org/packages/5e/c8/fbfe925a34b8ad85b6de0abadc9618647a9d2c5d2bd1728940fca9e3cf14/django-postgres-dbdefaults-0.1.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "2e96d9fac5909fdb4b0c924ec5179db7", "sha256": "05bfcd6339607d333acc5f0e2096b62c5aa28d8e6b3a8b2e728aae4cc4feff42"}, "downloads": -1, "filename": "django-postgres-dbdefaults-0.1.1.tar.gz", "has_sig": false, "md5_digest": "2e96d9fac5909fdb4b0c924ec5179db7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 4898, "upload_time": "2016-04-27T18:18:29", "upload_time_iso_8601": "2016-04-27T18:18:29.149015Z", "url": "https://files.pythonhosted.org/packages/5e/c8/fbfe925a34b8ad85b6de0abadc9618647a9d2c5d2bd1728940fca9e3cf14/django-postgres-dbdefaults-0.1.1.tar.gz", "yanked": false}], "timestamp": "Fri May  8 00:54:51 2020"}