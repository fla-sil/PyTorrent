{"info": {"author": "Firefox Operations Security Team (foxsec)", "author_email": "foxsec+frost@mozilla.com", "bugtrack_url": null, "classifiers": ["License :: OSI Approved :: Mozilla Public License 2.0 (MPL 2.0)", "Natural Language :: English", "Operating System :: OS Independent", "Programming Language :: Python :: 3.6", "Programming Language :: Python :: 3.7"], "description": "# pytest-services\n\nClients and [pytest](https://docs.pytest.org/en/latest/index.html)\ntests for checking that third party services the @foxsec team uses are\nconfigured correctly.\n\nWe trust third party services to return their status correctly, but\nwant to answer questions whether they are configured properly such as:\n\n* Are our AWS DB snapshots publicly accessible?\n* Is there a dangling DNS entry in Route53?\n* Will someone get paged when an alert goes off?\n\n## Usage\n\n### Requirements\n\n* [GNU Make 3.81](https://www.gnu.org/software/make/)\n* [Python 3.6.2](https://www.python.org/downloads/)\n\nNote: other versions may work too these are the versions @g-k used for development\n\n### Installing\n\nFrom the project root run:\n\n```console\nmake install\n```\n\nThis will:\n\n* create a Python [virtualenv](https://docs.python.org/3/library/venv.html) to isolate it from other Python packages\n* install Python requirements in the virtualenv\n\n### Running\n\nActivate the venv in the project root:\n\n```console\nsource venv/bin/activate\n```\n\nTo fetch RDS resources from the cache or AWS API and check that\nbackups are enabled for DB instances for [the configured aws\nprofile](https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html)\nnamed `default` in the `us-west-2` region we can run:\n\n```console\npytest --ignore aws/s3 --ignore aws/ec2 -k test_rds_db_instance_backup_enabled -s --aws-profiles default --debug-calls\n```\n\nThe options include pytest options:\n\n* [`--ignore`](https://docs.pytest.org/en/latest/example/pythoncollection.html#ignore-paths-during-test-collection) to skip fetching resources for non-RDS resources\n* [`-k`](https://docs.pytest.org/en/latest/example/markers.html#using-k-expr-to-select-tests-based-on-their-name) for selecting tests matching the substring `test_rds_db_instance_backup_enabled` for the one test we want to run\n* [`-m`](https://docs.pytest.org/en/latest/example/markers.html#marking-test-functions-and-selecting-them-for-a-run) not used but the marker filter can be useful for selecting all tests for specific services (e.g. `-m rds`)\n* [`-s`](https://docs.pytest.org/en/latest/capture.html) to disable capturing stdout so we can see the progress fetching AWS resources\n\nand options pytest-services adds:\n\n* `--debug-calls` for printing (with `-s`) API calls we make\n* `--aws-profiles` for selecting one or more AWS profiles to fetch resources for or the AWS default profile / `AWS_PROFILE` environment variable\n* `--offline` a flag to tell HTTP clients to not make requests and return empty params\n* [`--config`](#custom-test-config) path to test custom config file\n\nand produces output like the following showing a DB instance with backups disabled:\n\n```console\n=========================================================== test session starts ===========================================================\nplatform darwin -- Python 3.6.2, pytest-3.3.2, py-1.5.2, pluggy-0.6.0\nmetadata: {'Python': '3.6.2', 'Platform': 'Darwin-15.6.0-x86_64-i386-64bit', 'Packages': {'pytest': '3.3.2', 'py': '1.5.2', 'pluggy': '0.6.\n0'}, 'Plugins': {'metadata': '1.5.1', 'json': '0.4.0', 'html': '1.16.1'}}\nrootdir: /Users/gguthe/mozilla-services/pytest-services, inifile:\nplugins: metadata-1.5.1, json-0.4.0, html-1.16.1\ncollecting 0 items                                                                                                                        c\nalling AWSAPICall(profile='default', region='us-west-2', service='rds', method='describe_db_instances', args=[], kwargs={})\ncollecting 4 items\n...\naws/rds/test_rds_db_instance_backup_enabled.py ...F                                                                                 [100%]\n\n================================================================ FAILURES =================================================================\n_______________________________________ test_rds_db_instance_backup_enabled[test-db] ________________________________________\n\nrds_db_instance = {'AllocatedStorage': 50, 'AutoMinorVersionUpgrade': True, 'AvailabilityZone': 'us-west-2c', 'BackupRetentionPeriod': 0, .\n..}\n\n    @pytest.mark.rds\n    @pytest.mark.parametrize('rds_db_instance',\n                             rds_db_instances(),\n                             ids=lambda db_instance: db_instance['DBInstanceIdentifier'])\n    def test_rds_db_instance_backup_enabled(rds_db_instance):\n>       assert rds_db_instance['BackupRetentionPeriod'] > 0, \\\n            'Backups disabled for {}'.format(rds_db_instance['DBInstanceIdentifier'])\nE       AssertionError: Backups disabled for test-db\nE       assert 0 > 0\n\naws/rds/test_rds_db_instance_backup_enabled.py:12: AssertionError\n=========================================================== 72 tests deselected ===========================================================\n============================================ 1 failed, 3 passed, 72 deselected in 3.12 seconds ============================================\n```\n\n#### IAM Policy for pytest-services\n\nThe below policy will allow you to run all AWS tests in pytest-services against all resources in your account.\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"PytestServicesReadOnly\",\n      \"Action\": [\n        \"autoscaling:DescribeLaunchConfigurations\",\n        \"cloudtrail:DescribeTrails\",\n        \"ec2:DescribeFlowLogs\",\n        \"ec2:DescribeInstances\",\n        \"ec2:DescribeSecurityGroups\",\n        \"ec2:DescribeSnapshotAttribute\",\n        \"ec2:DescribeSnapshots\",\n        \"ec2:DescribeVolumes\",\n        \"ec2:DescribeVpcs\",\n        \"elasticache:DescribeCacheClusters\",\n        \"elasticloadbalancing:DescribeLoadBalancers\",\n        \"es:DescribeElasticsearchDomains\",\n        \"es:ListDomainNames\",\n        \"iam:GenerateCredentialReport\",\n        \"iam:GetCredentialReport\",\n        \"iam:GetLoginProfile\",\n        \"iam:ListAccessKeys\",\n        \"iam:ListAttachedGroupPolicies\",\n        \"iam:ListAttachedRolePolicies\",\n        \"iam:ListAttachedUserPolicies\",\n        \"iam:ListGroupPolicies\",\n        \"iam:ListGroupsForUser\",\n        \"iam:ListMFADevices\",\n        \"iam:ListRolePolicies\",\n        \"iam:ListRoles\",\n        \"iam:ListUserPolicies\",\n        \"iam:ListUsers\",\n        \"rds:DescribeDbInstances\",\n        \"rds:DescribeDbSecurityGroups\",\n        \"rds:DescribeDbSnapshotAttributes\",\n        \"rds:DescribeDbSnapshots\",\n        \"rds:ListTagsForResource\",\n        \"redshift:DescribeClusterSecurityGroups\",\n        \"redshift:DescribeClusters\",\n        \"s3:GetBucketAcl\",\n        \"s3:GetBucketCORS\",\n        \"s3:GetBucketLogging\",\n        \"s3:GetBucketPolicy\",\n        \"s3:GetBucketVersioning\",\n        \"s3:GetBucketWebsite\",\n        \"s3:ListAllMyBuckets\",\n        \"s3:ListBucket\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": \"*\"\n    }\n  ]\n}\n```\n\n#### Setting up GCP tests\n\n##### Enabling required API's for your project\n\n```\ngcloud [--project <project name>] services enable bigquery-json.googleapis.com\ngcloud [--project <project name>] services enable cloudresourcemanager.googleapis.com\ngcloud [--project <project name>] services enable compute.googleapis.com\ngcloud [--project <project name>] services enable sqladmin.googleapis.com\n```\n\n#### Setting up GSuite tests\n\nMake sure to have an OAuth2 app created and have the `client_secret.json` file in `~/.credentials` and then run:\n```\nmake setup_gsuite\n```\n\n### Caching\n\nThe AWS client will use AWS API JSON responses when available and save them using AWS profile, region, service name, service method, [botocore](http://botocore.readthedocs.io/) args and kwargs in the cache key to filenames with the format `.cache/v/pytest_aws:<aws profile>:<aws region>:<aws service>:<service method>:<args>:<kwargs>.json` e.g.\n\n```\nhead .cache/v/pytest_aws:cloudservices-aws-stage:us-west-2:rds:describe_db_instances::.json\n{\n    \"DBInstances\": [\n        {\n            \"AllocatedStorage\": 5,\n            \"AutoMinorVersionUpgrade\": true,\n            \"AvailabilityZone\": \"us-west-2c\",\n            \"BackupRetentionPeriod\": 1,\n            \"CACertificateIdentifier\": \"rds-ca-2015\",\n            \"CopyTagsToSnapshot\": false,\n            \"DBInstanceArn\": \"arn:aws:rds:us-west-2:123456678901:db:test-db\",\n```\n\nThese files can be removed individually or all at once with [the pytest --cache-clear](https://docs.pytest.org/en/latest/cache.html#usage) option.\n\n## Custom Test Config\n\npytest-services adds a `--config` cli option for passing in a custom config file specific to tests within pytest-services.\n\nThe example config in repo (`config.yaml.example`):\n```\nexemptions:\n  - test_name: test_ec2_instance_has_required_tags\n    test_param_id: i-0123456789f014c162\n    expiration_day: 2019-01-01\n    reason: ec2 instance has no owner\n  - test_name: test_ec2_security_group_opens_specific_ports_to_all\n    test_param_id: '*HoneyPot'\n    expiration_day: 2020-01-01\n    reason: purposefully insecure security group\nseverities:\n  - test_name: test_ec2_instance_has_required_tags\n    severity: INFO\n  - test_name: '*'\n    severity: ERROR\nregressions:\n  - test_name: test_ec2_security_group_opens_all_ports_to_all\n    test_param_id: '*mycustomgroup'\n    comment: this was remediated by ops team\naws:\n  admin_groups:\n    - \"Administrators\"\n  admin_policies:\n    - \"AWSAdminRequireMFA\"\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n    created_after:\n      weeks: 1\n  access_key_expires_after:\n    years: 1\n    months: 0\n  required_tags:\n    - Name\n    - Type\n    - App\n    - Env\n  required_amis:\n    - ami-00000000000000000\n    - ami-55555555555555555\n  whitelisted_ports_global:\n    - 25\n  whitelisted_ports:\n    - test_param_id: '*bastion'\n      ports:\n        - 22\n        - 2222\ngsuite:\n  domain: 'example.com'\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\npagerduty:\n  users_with_remote_access_monitoring: 'pd_users.json'\n  bastion_users: 'hierahash/*hierahash.json'\n  alternate_usernames: 'alternate_usernames.json'\n```\n\n### Test Exemptions\n\npytest-services custom config format adds support for\nmarking test and test resource IDs as expected failures.\n\nThe keys for each exemption rule is:\n* test_name - Name of the test\n* test_param_id - test ID (usually an AWS resource ID) (prefix with `*` to turn into a regex matcher)\n* expiration_day - exception expiration day (as YYYY-MM-DD)\n* reason - exception reason\n\nThe config looks like:\n```\n...\nexemptions:\n  - test_name: test_ec2_instance_has_required_tags\n    test_param_id: i-0123456789f014c162\n    expiration_day: 2019-01-01\n    reason: ec2 instance has no owner\n  - test_name: test_ec2_security_group_opens_specific_ports_to_all\n    test_param_id: '*HoneyPot'\n    expiration_day: 2020-01-01\n    reason: purposefully insecure security group\n...\n```\n\n#### Enabling regex for test ID\n\nYou can prefix the test ID with a `*` to enable regex matching for the test ID. The `*` prefix will be stripped\noff, and the rest will be used as a regex.\n\nFor example:\n - `*foobar` becomes `foobar`\n - `*foo\\w+` becomes `foo\\w+`\n\nFor more information on Python's regex syntax see: [Regular Expression HOWTO](https://docs.python.org/3.4/howto/regex.html#regex-howto).\n\n**Note:** All regex rules are applied first. As well, the ordering of both regex and non-regex rules is top to bottom and the first one wins.\n\n\nWhen a json report is generated, the exemptions will show up in the\njson metadata as serialized markers:\n\n```json\npython -m json.tool report.json | grep -C 20 xfail\n...\n                        \"markers\": {\n                            \"ec2\": {\n                                \"name\": \"ec2\",\n                                \"args\": [],\n                                \"kwargs\": {}\n                            },\n                            \"parametrize\": {\n                                \"name\": \"parametrize\",\n                                \"args\": [\n                                    \"...skipped...\"\n                                ],\n                                \"kwargs\": [\n                                    \"...skipped...\"\n                                ]\n                            },\n                            \"xfail\": {\n                                \"name\": \"xfail\",\n                                \"args\": [],\n                                \"kwargs\": {\n                                    \"reason\": \"ec2 instance has no owner\",\n                                    \"strict\": true,\n                                    \"expiration\": \"2019-01-01\"\n                                }\n                            }\n                        },\n...\n```\n\n\n#### Test Severity\n\npytest-services custom config format adds support for marking the severity of a certain test. A severity can be `INFO`, `WARN`, or `ERROR`.\n\nThese do not modify pytest results (pass, fail, xfail, skip, etc.).\n\nThe config looks like:\n\n```\n...\nseverities:\n  - test_name: test_ec2_instance_has_required_tags\n    severity: INFO\n  - test_name: '*'\n    severity: ERROR\n...\n```\n\nAnd results in a severity and severity marker being included in the\njson metadata:\n\n```console\npytest --ignore aws/s3 --ignore aws/rds --ignore aws/iam -s --aws-profiles stage --aws-require-tags Name Type App Stack -k test_ec2_instance_has_required_tags --config config.yaml.example --json=report.json\n...\n```\n\n```json\npython -m json.tool report.json\n{\n    \"report\": {\n        \"environment\": {\n            \"Python\": \"3.6.2\",\n            \"Platform\": \"Darwin-15.6.0-x86_64-i386-64bit\"\n        },\n        \"tests\": [\n            {\n...\n                \"metadata\": [\n                    {\n...\n                    \"markers\": {\n...\n                            \"severity\": {\n                                \"name\": \"severity\",\n                                \"args\": [\n                                    \"INFO\"\n                                ],\n                                \"kwargs\": {}\n                            }\n                        },\n...\n                        \"severity\": \"INFO\",\n                        \"unparametrized_name\": \"test_ec2_instance_has_required_tags\"\n                    }\n...\n```\n\n### Test Regressions\n\npytest-services custom config format adds support for marking specific tests on specific resources as regressions.\nAs with `severity` this does not modify the pytest results, but rather adds a marker that can be used when analyzing the results.\n\nThe config looks like:\n```\n...\nregressions:\n  - test_name: test_ec2_security_group_opens_all_ports_to_all\n    test_param_id: '*mycustomgroup'\n    comment: this was remediated by ops team\n...\n```\n\n### AWS Config\n\npytest-services has a suite of AWS tests. This section of the custom config includes configuration options specific\nto these tests.\n\nThe config looks like:\n```\n...\naws:\n  # Relative time delta for test_iam_user_is_inactive. no_activity_since will be used as the failure marker,\n  # so in this example any user that hasn't had any activity for a year will be marked as a \"failure\". created_after\n  # is used as a grace period, so in this case any user that was created within the last week will be automatically\n  # pass this test.\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n    created_after:\n      weeks: 1\n  # Required tags used within the test_ec2_instance_has_required_tags test\n  required_tags:\n    - Name\n    - Type\n    - App\n    - Env\n  # Whitelsited ports for the test_ec2_security_group_opens_specific_ports_to_all\n  # test for all instances\n  whitelisted_ports_global:\n    - 25\n  # Whitelsited ports for the test_ec2_security_group_opens_specific_ports_to_all\n  # test for specific instances. In this example, we are whitelisting ports 22\n  # and 2222 for all security groups that include the word 'bastion' in them.\n  whitelisted_ports:\n    - test_param_id: '*bastion'\n      ports:\n        - 22\n        - 2222\n...\n```\n\n### GSuite Config\n\npytest-services has a suite of GSuite tests. This section of the\ncustom config includes configuration options specific to these tests.\n\n**Make sure to [setup GSuite](#setting-up-gsuite-tests) before running GSuite tests**\n\nThe config looks like:\n```\ngsuite:\n  # The specific GSuite domain to test.\n  domain: 'example.com'\n  # Relative time delta for test_admin_user_is_inactive. no_activity_since will be used as the failure marker,\n  # so in this example any user that hasn't had any activity for a year will be marked as a \"failure\".\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n```\n\n### Pagerduty Config\n\npytest-services does not query the pagerduty API, but can run tests against output from it.\n\nThe config looks like:\n```\npagerduty:\n  users_with_remote_access_monitoring: 'pd_users.json'\n  bastion_users: 'hierahash/*hierahash.json'\n  alternate_usernames: 'alternate_usernames.json'\n```\n\nWhere `users_with_remote_access_monitoring` and `bastion_users` are\nglobs for multiple files relative to the current working directory and\n`alternate_usernames` is the path to a single file.\n\nThe files have examples formats as follows:\n\n* `users_with_remote_access_monitoring`:\n\n```json\n[\n  {\n    \"avatar_url\": \"https://secure.gravatar.com/avatar/...\",\n    \"billed\": true,\n    \"color\": \"sea-green\",\n    \"contact_methods\": [],\n    \"description\": null,\n    \"email\": \"example@example.com\",\n    \"html_url\": \"https://example.pagerduty.com/users/AAA0999\",\n    \"id\": \"AAA0999\",\n    \"invitation_sent\": false,\n    \"job_title\": null,\n    \"name\": \"Example Examplerton\",\n    \"notification_rules\": [],\n    \"role\": \"user\",\n    \"self_\": \"https://api.pagerduty.com/users/AAA0999\",\n    \"summary\": \"C. Hobbes\",\n    \"teams\": [],\n    \"time_zone\": \"America/New_York\",\n    \"type\": \"user\"\n  },\n  ...\n]\n```\n\n* `bastion_users`:\n\n```json\n{\n  \"chobbes\": {\n    \"groups\": [\"\"],\n    \"root_ssh\": true\n  },\n  \"movedon\": {\n    \"ensure\": \"absent\"\n  },\n  ...\n}\n```\n\n* `alternate_usernames`:\n\n```json\n{\n  \"chobbes\": [\"calvin\", \"spacemanspiff\"]\n}\n```\n\n### Test Accuracy\n\nThere are two important things to note about `pytest-services` tests that may be different from your expectations.\n\nFirst, the focus is on \"actionable results\". This plays out as an attempt to reduce false\npositives by trying to filter out unused resources. An example of this can be seen by looking at\nany of the security group tests, where we are skipping any security groups that are not attached to a resource.\n\nSecond, there are some tests that make naive assumptions instead of trying to capture the complexities\nof the system. The current best example of this is all IAM tests that relate to \"admin\" users. How we\nare determining what an user or role is an admin is based simply off substring matching on the policies\nattached. This obviously has a high chance of false negatives.\n\n## Development\n\n### Goals\n\n1. replace one-off scripts for each check\n1. share checks with other organizations\n1. consolidate bugs in one place (i.e. one thing to update)\n1. in pytest use a known existing framework for writing checks\n1. be vendor agnostic e.g. support checks across cloud providers or in hybrid environments or competing services\n1. cache and share responses to reduce third party API usage (i.e. lots of tests check AWS security groups so fetch them once)\n1. provide a way to run a single test or subset of tests\n1. focus on actionable results (see [test accuracy](#test-accuracy) for more information)\n\n### Non-Goals\n\n1. Invent a new DSL for writing expectations (use pytest conventions)\n1. Verify how third party services or their client libraries work\n   (e.g. don't answer \"Does GET / on the CRUD1 API return 400 when\n   query param `q` is `$bad_value`?\")\n\n### Design\n\nCurrently this is a monolithic pytest package, but should eventually\n[be extracted into a pytest plugin](#3) and with [separate dependent\npytest plugins for each service](#4).\n\nAPI responses should fit on disk and in memory (i.e. don't use this\nfor log processing or checking binaries for malware), and be safe to\ncache for minutes, hours, or days (i.e. probably don't use this for\nmonitoring a streaming API) (NB: [bug for specifying data\nfreshness](#5)).\n\nAdditionally we want:\n\n* data fetching functions in a `resources.py`\n* data checking and test helpers in a `helpers.py`\n* prefix test files with `test_`\n* doctests for non test files (e.g. `helpers.py`, `resources.py`, `client.py`)\n  * tests that depend on external IO or the runtime environment (env vars, file system, HTTP) to use the prefix `meta_test_` (and probably `mock` or `pytest.monkeypatch`)\n    * JSON fixtures for anonymized cached http call in `example_cache/v/`\n* tests to have pytest markers for any services they depend on for data\n* HTTP clients should be read only and use read only credentials\n* running a test should not modify services\n\n#### File Layout\n\n```console\npytest-services\n...\n\u251c\u2500\u2500 example_cache\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 v\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 cache\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 lastfailed\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 pytest_aws:example-account:us-east-1:ec2:describe_instances::.json\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 pytest_aws:example-account:us-east-1:ec2:describe_security_groups::.json\n...\n\u251c\u2500\u2500 <third party service A>\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 client.py\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 meta_test_client.py\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 <subservice A (optional)>\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 helpers.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 resources.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ...\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 test_ec2_security_group_all_ports.py\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 <subservice b (optional)>\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 resources.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ...\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500 test_s3_bucket_web_hosting_disabled.py\n\u2514\u2500\u2500 <third party service B>\n \u00a0\u00a0 \u251c\u2500\u2500 __init__.py\n \u00a0\u00a0 \u251c\u2500\u2500 helpers.py\n \u00a0\u00a0 \u251c\u2500\u2500 resources.py\n \u00a0\u00a0 \u2514\u2500\u2500 test_user_has_escalation_policy.py\n```\n\n### Adding an example test\n\nLet's write a test to check that http://httpbin.org/ip returns an AWS IP:\n\n1. create a file `httpbin/test_httpbin_ip.py` with the contents:\n\n```python\nimport itertools\nimport ipaddress\nimport pytest\nimport json\nimport urllib.request\n\n\ndef get_httpbin_ips():\n    # IPs we always want to test\n    ips = [\n        '127.0.0.1',\n        '13.58.0.0',\n    ]\n\n    req = urllib.request.Request('http://httpbin.org/ip')\n\n    with urllib.request.urlopen(req) as response:\n        body = response.read().decode('utf-8')\n        ips.append(json.loads(body).get('origin', None))\n\n    return ips\n\n\ndef get_aws_ips():\n    req = urllib.request.Request('https://ip-ranges.amazonaws.com/ip-ranges.json')\n\n    with urllib.request.urlopen(req) as response:\n        body = response.read().decode('utf-8')\n        return json.loads(body)['prefixes']\n\n\n@pytest.mark.httpbin\n@pytest.mark.aws_ip_ranges\n@pytest.mark.parametrize(\n    ['ip', 'aws_ip_ranges'],\n    zip(get_httpbin_ips(), itertools.repeat(get_aws_ips())))\ndef test_httpbin_ip_in_aws(ip, aws_ip_ranges):\n    for aws_ip_range in aws_ip_ranges:\n        assert ipaddress.IPv4Address(ip) not in ipaddress.ip_network(aws_ip_range['ip_prefix']), \\\n          \"{0} is in AWS range {1[ip_prefix]} region {1[region]} service {1[service]}\".format(ip, aws_ip_range)\n```\n\nNotes:\n\n* we add two data fetching functions that return lists that we can zip into tuples for [the pytest parametrize decorator](https://docs.pytest.org/en/latest/parametrize.html#pytest-mark-parametrize-parametrizing-test-functions)\n* we add markers for the services we're fetching data from\n\n\n1. Running it we see that one of the IPs is an AWS IP:\n\n```console\npytest --ignore aws/\nplatform darwin -- Python 3.6.2, pytest-3.3.2, py-1.5.2, pluggy-0.6.0\nmetadata: {'Python': '3.6.2', 'Platform': 'Darwin-15.6.0-x86_64-i386-64bit', 'Packages': {'pytest': '3.3.2', 'py': '1.5.2', 'pluggy': '0.6.0'}, 'Plugins': {'metadata': '1.5.1', 'json': '0.4.0', 'html': '1.16.1'}}\nrootdir: /Users/gguthe/mozilla-services/pytest-services, inifile:\nplugins: metadata-1.5.1, json-0.4.0, html-1.16.1\ncollected 3 items\n\nhttpbin/test_httpbin_ip_in_aws.py .F.                                                                                               [100%]\n\n================================================================ FAILURES =================================================================\n____________________________________________ test_httpbin_ip_in_aws[13.58.0.0-aws_ip_ranges1] _____________________________________________\n\nip = '13.58.0.0'\naws_ip_ranges = [{'ip_prefix': '13.32.0.0/15', 'region': 'GLOBAL', 'service': 'AMAZON'}, {'ip_prefix': '13.35.0.0/16', 'region': 'GLOB...on': 'us-west-1', 'service': 'AMAZON'}, {'ip_prefix': '13.57.0.0/16', 'region': 'us-west-1', 'service': 'AMAZON'}, ...]\n\n    @pytest.mark.httpbin\n    @pytest.mark.aws_ip_ranges\n    @pytest.mark.parametrize(\n        ['ip', 'aws_ip_ranges'],\n        zip(get_httpbin_ips(), itertools.repeat(get_aws_ips())),\n        # ids=lambda ip: ip\n        )\n    def test_httpbin_ip_in_aws(ip, aws_ip_ranges):\n        for aws_ip_range in aws_ip_ranges:\n>           assert ipaddress.IPv4Address(ip) not in ipaddress.ip_network(aws_ip_range['ip_prefix']), \\\n              \"{0} is in AWS range {1[ip_prefix]} region {1[region]} service {1[service]}\".format(ip, aws_ip_range)\nE           AssertionError: 13.58.0.0 is in AWS range 13.58.0.0/15 region us-east-2 service AMAZON\nE           assert IPv4Address('13.58.0.0') not in IPv4Network('13.58.0.0/15')\nE            +  where IPv4Address('13.58.0.0') = <class 'ipaddress.IPv4Address'>('13.58.0.0')\nE            +    where <class 'ipaddress.IPv4Address'> = ipaddress.IPv4Address\nE            +  and   IPv4Network('13.58.0.0/15') = <function ip_network at 0x107cf66a8>('13.58.0.0/15')\nE            +    where <function ip_network at 0x107cf66a8> = ipaddress.ip_network\n\nhttpbin/test_httpbin_ip_in_aws.py:43: AssertionError\n=================================================== 1 failed, 2 passed in 15.69 seconds ===================================================\n```\n\nNote: marking tests as expected failures with `@pytest.mark.xfail` can hide data fetching errors\n\nTo improve this we could:\n\n1. Add parametrize ids so it's clearer which parametrize caused test failures\n1. Add directions about why it's an issue and how to fix it or what the associated risks are\n\nAs we add more tests we can:\n\n1. Move the JSON fetching functions to `<service name>/resources.py` files and import them into the test\n1. Move the fetching logic to a shared library `<service name>/client.py` and save to the pytest cache", "description_content_type": "text/markdown", "docs_url": null, "download_url": "", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://github.com/mozilla-services/pytest-services", "keywords": "", "license": "MPL2", "maintainer": "", "maintainer_email": "", "name": "frost", "package_url": "https://pypi.org/project/frost/", "platform": "", "project_url": "https://pypi.org/project/frost/", "project_urls": {"Homepage": "https://github.com/mozilla-services/pytest-services"}, "release_url": "https://pypi.org/project/frost/0.3.1/", "requires_dist": null, "requires_python": ">=3.6", "summary": "tests for checking that third party services the Firefox Operations Security or foxsec team uses are configured correctly", "version": "0.3.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <h1>pytest-services</h1>\n<p>Clients and <a href=\"https://docs.pytest.org/en/latest/index.html\" rel=\"nofollow\">pytest</a>\ntests for checking that third party services the @foxsec team uses are\nconfigured correctly.</p>\n<p>We trust third party services to return their status correctly, but\nwant to answer questions whether they are configured properly such as:</p>\n<ul>\n<li>Are our AWS DB snapshots publicly accessible?</li>\n<li>Is there a dangling DNS entry in Route53?</li>\n<li>Will someone get paged when an alert goes off?</li>\n</ul>\n<h2>Usage</h2>\n<h3>Requirements</h3>\n<ul>\n<li><a href=\"https://www.gnu.org/software/make/\" rel=\"nofollow\">GNU Make 3.81</a></li>\n<li><a href=\"https://www.python.org/downloads/\" rel=\"nofollow\">Python 3.6.2</a></li>\n</ul>\n<p>Note: other versions may work too these are the versions @g-k used for development</p>\n<h3>Installing</h3>\n<p>From the project root run:</p>\n<pre><span class=\"go\">make install</span>\n</pre>\n<p>This will:</p>\n<ul>\n<li>create a Python <a href=\"https://docs.python.org/3/library/venv.html\" rel=\"nofollow\">virtualenv</a> to isolate it from other Python packages</li>\n<li>install Python requirements in the virtualenv</li>\n</ul>\n<h3>Running</h3>\n<p>Activate the venv in the project root:</p>\n<pre><span class=\"go\">source venv/bin/activate</span>\n</pre>\n<p>To fetch RDS resources from the cache or AWS API and check that\nbackups are enabled for DB instances for <a href=\"https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html\" rel=\"nofollow\">the configured aws\nprofile</a>\nnamed <code>default</code> in the <code>us-west-2</code> region we can run:</p>\n<pre><span class=\"go\">pytest --ignore aws/s3 --ignore aws/ec2 -k test_rds_db_instance_backup_enabled -s --aws-profiles default --debug-calls</span>\n</pre>\n<p>The options include pytest options:</p>\n<ul>\n<li><a href=\"https://docs.pytest.org/en/latest/example/pythoncollection.html#ignore-paths-during-test-collection\" rel=\"nofollow\"><code>--ignore</code></a> to skip fetching resources for non-RDS resources</li>\n<li><a href=\"https://docs.pytest.org/en/latest/example/markers.html#using-k-expr-to-select-tests-based-on-their-name\" rel=\"nofollow\"><code>-k</code></a> for selecting tests matching the substring <code>test_rds_db_instance_backup_enabled</code> for the one test we want to run</li>\n<li><a href=\"https://docs.pytest.org/en/latest/example/markers.html#marking-test-functions-and-selecting-them-for-a-run\" rel=\"nofollow\"><code>-m</code></a> not used but the marker filter can be useful for selecting all tests for specific services (e.g. <code>-m rds</code>)</li>\n<li><a href=\"https://docs.pytest.org/en/latest/capture.html\" rel=\"nofollow\"><code>-s</code></a> to disable capturing stdout so we can see the progress fetching AWS resources</li>\n</ul>\n<p>and options pytest-services adds:</p>\n<ul>\n<li><code>--debug-calls</code> for printing (with <code>-s</code>) API calls we make</li>\n<li><code>--aws-profiles</code> for selecting one or more AWS profiles to fetch resources for or the AWS default profile / <code>AWS_PROFILE</code> environment variable</li>\n<li><code>--offline</code> a flag to tell HTTP clients to not make requests and return empty params</li>\n<li><a href=\"#custom-test-config\" rel=\"nofollow\"><code>--config</code></a> path to test custom config file</li>\n</ul>\n<p>and produces output like the following showing a DB instance with backups disabled:</p>\n<pre><span class=\"go\">=========================================================== test session starts ===========================================================</span>\n<span class=\"go\">platform darwin -- Python 3.6.2, pytest-3.3.2, py-1.5.2, pluggy-0.6.0</span>\n<span class=\"go\">metadata: {'Python': '3.6.2', 'Platform': 'Darwin-15.6.0-x86_64-i386-64bit', 'Packages': {'pytest': '3.3.2', 'py': '1.5.2', 'pluggy': '0.6.</span>\n<span class=\"go\">0'}, 'Plugins': {'metadata': '1.5.1', 'json': '0.4.0', 'html': '1.16.1'}}</span>\n<span class=\"go\">rootdir: /Users/gguthe/mozilla-services/pytest-services, inifile:</span>\n<span class=\"go\">plugins: metadata-1.5.1, json-0.4.0, html-1.16.1</span>\n<span class=\"go\">collecting 0 items                                                                                                                        c</span>\n<span class=\"go\">alling AWSAPICall(profile='default', region='us-west-2', service='rds', method='describe_db_instances', args=[], kwargs={})</span>\n<span class=\"go\">collecting 4 items</span>\n<span class=\"go\">...</span>\n<span class=\"go\">aws/rds/test_rds_db_instance_backup_enabled.py ...F                                                                                 [100%]</span>\n\n<span class=\"go\">================================================================ FAILURES =================================================================</span>\n<span class=\"go\">_______________________________________ test_rds_db_instance_backup_enabled[test-db] ________________________________________</span>\n\n<span class=\"go\">rds_db_instance = {'AllocatedStorage': 50, 'AutoMinorVersionUpgrade': True, 'AvailabilityZone': 'us-west-2c', 'BackupRetentionPeriod': 0, .</span>\n<span class=\"go\">..}</span>\n\n<span class=\"go\">    @pytest.mark.rds</span>\n<span class=\"go\">    @pytest.mark.parametrize('rds_db_instance',</span>\n<span class=\"go\">                             rds_db_instances(),</span>\n<span class=\"go\">                             ids=lambda db_instance: db_instance['DBInstanceIdentifier'])</span>\n<span class=\"go\">    def test_rds_db_instance_backup_enabled(rds_db_instance):</span>\n<span class=\"gp\">&gt;</span>       assert rds_db_instance<span class=\"o\">[</span><span class=\"s1\">'BackupRetentionPeriod'</span><span class=\"o\">]</span> &gt; <span class=\"m\">0</span>, <span class=\"se\">\\</span>\n            <span class=\"s1\">'Backups disabled for {}'</span>.format<span class=\"o\">(</span>rds_db_instance<span class=\"o\">[</span><span class=\"s1\">'DBInstanceIdentifier'</span><span class=\"o\">])</span>\n<span class=\"go\">E       AssertionError: Backups disabled for test-db</span>\n<span class=\"go\">E       assert 0 &gt; 0</span>\n\n<span class=\"go\">aws/rds/test_rds_db_instance_backup_enabled.py:12: AssertionError</span>\n<span class=\"go\">=========================================================== 72 tests deselected ===========================================================</span>\n<span class=\"go\">============================================ 1 failed, 3 passed, 72 deselected in 3.12 seconds ============================================</span>\n</pre>\n<h4>IAM Policy for pytest-services</h4>\n<p>The below policy will allow you to run all AWS tests in pytest-services against all resources in your account.</p>\n<pre><span class=\"p\">{</span>\n  <span class=\"nt\">\"Version\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2012-10-17\"</span><span class=\"p\">,</span>\n  <span class=\"nt\">\"Statement\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"nt\">\"Sid\"</span><span class=\"p\">:</span> <span class=\"s2\">\"PytestServicesReadOnly\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"Action\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"s2\">\"autoscaling:DescribeLaunchConfigurations\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"cloudtrail:DescribeTrails\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeFlowLogs\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeInstances\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeSecurityGroups\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeSnapshotAttribute\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeSnapshots\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeVolumes\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"ec2:DescribeVpcs\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"elasticache:DescribeCacheClusters\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"elasticloadbalancing:DescribeLoadBalancers\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"es:DescribeElasticsearchDomains\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"es:ListDomainNames\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:GenerateCredentialReport\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:GetCredentialReport\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:GetLoginProfile\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListAccessKeys\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListAttachedGroupPolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListAttachedRolePolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListAttachedUserPolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListGroupPolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListGroupsForUser\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListMFADevices\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListRolePolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListRoles\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListUserPolicies\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"iam:ListUsers\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"rds:DescribeDbInstances\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"rds:DescribeDbSecurityGroups\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"rds:DescribeDbSnapshotAttributes\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"rds:DescribeDbSnapshots\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"rds:ListTagsForResource\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"redshift:DescribeClusterSecurityGroups\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"redshift:DescribeClusters\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketAcl\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketCORS\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketLogging\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketPolicy\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketVersioning\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:GetBucketWebsite\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:ListAllMyBuckets\"</span><span class=\"p\">,</span>\n        <span class=\"s2\">\"s3:ListBucket\"</span>\n      <span class=\"p\">],</span>\n      <span class=\"nt\">\"Effect\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Allow\"</span><span class=\"p\">,</span>\n      <span class=\"nt\">\"Resource\"</span><span class=\"p\">:</span> <span class=\"s2\">\"*\"</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</pre>\n<h4>Setting up GCP tests</h4>\n<h5>Enabling required API's for your project</h5>\n<pre><code>gcloud [--project &lt;project name&gt;] services enable bigquery-json.googleapis.com\ngcloud [--project &lt;project name&gt;] services enable cloudresourcemanager.googleapis.com\ngcloud [--project &lt;project name&gt;] services enable compute.googleapis.com\ngcloud [--project &lt;project name&gt;] services enable sqladmin.googleapis.com\n</code></pre>\n<h4>Setting up GSuite tests</h4>\n<p>Make sure to have an OAuth2 app created and have the <code>client_secret.json</code> file in <code>~/.credentials</code> and then run:</p>\n<pre><code>make setup_gsuite\n</code></pre>\n<h3>Caching</h3>\n<p>The AWS client will use AWS API JSON responses when available and save them using AWS profile, region, service name, service method, <a href=\"http://botocore.readthedocs.io/\" rel=\"nofollow\">botocore</a> args and kwargs in the cache key to filenames with the format <code>.cache/v/pytest_aws:&lt;aws profile&gt;:&lt;aws region&gt;:&lt;aws service&gt;:&lt;service method&gt;:&lt;args&gt;:&lt;kwargs&gt;.json</code> e.g.</p>\n<pre><code>head .cache/v/pytest_aws:cloudservices-aws-stage:us-west-2:rds:describe_db_instances::.json\n{\n    \"DBInstances\": [\n        {\n            \"AllocatedStorage\": 5,\n            \"AutoMinorVersionUpgrade\": true,\n            \"AvailabilityZone\": \"us-west-2c\",\n            \"BackupRetentionPeriod\": 1,\n            \"CACertificateIdentifier\": \"rds-ca-2015\",\n            \"CopyTagsToSnapshot\": false,\n            \"DBInstanceArn\": \"arn:aws:rds:us-west-2:123456678901:db:test-db\",\n</code></pre>\n<p>These files can be removed individually or all at once with <a href=\"https://docs.pytest.org/en/latest/cache.html#usage\" rel=\"nofollow\">the pytest --cache-clear</a> option.</p>\n<h2>Custom Test Config</h2>\n<p>pytest-services adds a <code>--config</code> cli option for passing in a custom config file specific to tests within pytest-services.</p>\n<p>The example config in repo (<code>config.yaml.example</code>):</p>\n<pre><code>exemptions:\n  - test_name: test_ec2_instance_has_required_tags\n    test_param_id: i-0123456789f014c162\n    expiration_day: 2019-01-01\n    reason: ec2 instance has no owner\n  - test_name: test_ec2_security_group_opens_specific_ports_to_all\n    test_param_id: '*HoneyPot'\n    expiration_day: 2020-01-01\n    reason: purposefully insecure security group\nseverities:\n  - test_name: test_ec2_instance_has_required_tags\n    severity: INFO\n  - test_name: '*'\n    severity: ERROR\nregressions:\n  - test_name: test_ec2_security_group_opens_all_ports_to_all\n    test_param_id: '*mycustomgroup'\n    comment: this was remediated by ops team\naws:\n  admin_groups:\n    - \"Administrators\"\n  admin_policies:\n    - \"AWSAdminRequireMFA\"\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n    created_after:\n      weeks: 1\n  access_key_expires_after:\n    years: 1\n    months: 0\n  required_tags:\n    - Name\n    - Type\n    - App\n    - Env\n  required_amis:\n    - ami-00000000000000000\n    - ami-55555555555555555\n  whitelisted_ports_global:\n    - 25\n  whitelisted_ports:\n    - test_param_id: '*bastion'\n      ports:\n        - 22\n        - 2222\ngsuite:\n  domain: 'example.com'\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\npagerduty:\n  users_with_remote_access_monitoring: 'pd_users.json'\n  bastion_users: 'hierahash/*hierahash.json'\n  alternate_usernames: 'alternate_usernames.json'\n</code></pre>\n<h3>Test Exemptions</h3>\n<p>pytest-services custom config format adds support for\nmarking test and test resource IDs as expected failures.</p>\n<p>The keys for each exemption rule is:</p>\n<ul>\n<li>test_name - Name of the test</li>\n<li>test_param_id - test ID (usually an AWS resource ID) (prefix with <code>*</code> to turn into a regex matcher)</li>\n<li>expiration_day - exception expiration day (as YYYY-MM-DD)</li>\n<li>reason - exception reason</li>\n</ul>\n<p>The config looks like:</p>\n<pre><code>...\nexemptions:\n  - test_name: test_ec2_instance_has_required_tags\n    test_param_id: i-0123456789f014c162\n    expiration_day: 2019-01-01\n    reason: ec2 instance has no owner\n  - test_name: test_ec2_security_group_opens_specific_ports_to_all\n    test_param_id: '*HoneyPot'\n    expiration_day: 2020-01-01\n    reason: purposefully insecure security group\n...\n</code></pre>\n<h4>Enabling regex for test ID</h4>\n<p>You can prefix the test ID with a <code>*</code> to enable regex matching for the test ID. The <code>*</code> prefix will be stripped\noff, and the rest will be used as a regex.</p>\n<p>For example:</p>\n<ul>\n<li><code>*foobar</code> becomes <code>foobar</code></li>\n<li><code>*foo\\w+</code> becomes <code>foo\\w+</code></li>\n</ul>\n<p>For more information on Python's regex syntax see: <a href=\"https://docs.python.org/3.4/howto/regex.html#regex-howto\" rel=\"nofollow\">Regular Expression HOWTO</a>.</p>\n<p><strong>Note:</strong> All regex rules are applied first. As well, the ordering of both regex and non-regex rules is top to bottom and the first one wins.</p>\n<p>When a json report is generated, the exemptions will show up in the\njson metadata as serialized markers:</p>\n<pre><span class=\"err\">python</span> <span class=\"err\">-m</span> <span class=\"err\">json.tool</span> <span class=\"err\">report.json</span> <span class=\"err\">|</span> <span class=\"err\">grep</span> <span class=\"err\">-C</span> <span class=\"mi\">20</span> <span class=\"err\">xfail</span>\n<span class=\"err\">...</span>\n                        <span class=\"s2\">\"markers\"</span><span class=\"err\">:</span> <span class=\"p\">{</span>\n                            <span class=\"nt\">\"ec2\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"ec2\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"args\"</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n                                <span class=\"nt\">\"kwargs\"</span><span class=\"p\">:</span> <span class=\"p\">{}</span>\n                            <span class=\"p\">},</span>\n                            <span class=\"nt\">\"parametrize\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"parametrize\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"args\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                                    <span class=\"s2\">\"...skipped...\"</span>\n                                <span class=\"p\">],</span>\n                                <span class=\"nt\">\"kwargs\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                                    <span class=\"s2\">\"...skipped...\"</span>\n                                <span class=\"p\">]</span>\n                            <span class=\"p\">},</span>\n                            <span class=\"nt\">\"xfail\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"xfail\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"args\"</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n                                <span class=\"nt\">\"kwargs\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                    <span class=\"nt\">\"reason\"</span><span class=\"p\">:</span> <span class=\"s2\">\"ec2 instance has no owner\"</span><span class=\"p\">,</span>\n                                    <span class=\"nt\">\"strict\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n                                    <span class=\"nt\">\"expiration\"</span><span class=\"p\">:</span> <span class=\"s2\">\"2019-01-01\"</span>\n                                <span class=\"p\">}</span>\n                            <span class=\"p\">}</span>\n                        <span class=\"p\">}</span><span class=\"err\">,</span>\n<span class=\"err\">...</span>\n</pre>\n<h4>Test Severity</h4>\n<p>pytest-services custom config format adds support for marking the severity of a certain test. A severity can be <code>INFO</code>, <code>WARN</code>, or <code>ERROR</code>.</p>\n<p>These do not modify pytest results (pass, fail, xfail, skip, etc.).</p>\n<p>The config looks like:</p>\n<pre><code>...\nseverities:\n  - test_name: test_ec2_instance_has_required_tags\n    severity: INFO\n  - test_name: '*'\n    severity: ERROR\n...\n</code></pre>\n<p>And results in a severity and severity marker being included in the\njson metadata:</p>\n<pre><span class=\"go\">pytest --ignore aws/s3 --ignore aws/rds --ignore aws/iam -s --aws-profiles stage --aws-require-tags Name Type App Stack -k test_ec2_instance_has_required_tags --config config.yaml.example --json=report.json</span>\n<span class=\"go\">...</span>\n</pre>\n<pre><span class=\"err\">python</span> <span class=\"err\">-m</span> <span class=\"err\">json.tool</span> <span class=\"err\">report.json</span>\n<span class=\"p\">{</span>\n    <span class=\"nt\">\"report\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"nt\">\"environment\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"nt\">\"Python\"</span><span class=\"p\">:</span> <span class=\"s2\">\"3.6.2\"</span><span class=\"p\">,</span>\n            <span class=\"nt\">\"Platform\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Darwin-15.6.0-x86_64-i386-64bit\"</span>\n        <span class=\"p\">},</span>\n        <span class=\"nt\">\"tests\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n            <span class=\"p\">{</span>\n<span class=\"err\">...</span>\n                <span class=\"nt\">\"metadata\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                    <span class=\"p\">{</span>\n<span class=\"err\">...</span>\n                    <span class=\"nt\">\"markers\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n<span class=\"err\">...</span>\n                            <span class=\"nt\">\"severity\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                                <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"severity\"</span><span class=\"p\">,</span>\n                                <span class=\"nt\">\"args\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                                    <span class=\"s2\">\"INFO\"</span>\n                                <span class=\"p\">],</span>\n                                <span class=\"nt\">\"kwargs\"</span><span class=\"p\">:</span> <span class=\"p\">{}</span>\n                            <span class=\"p\">}</span>\n                        <span class=\"p\">},</span>\n<span class=\"err\">...</span>\n                        <span class=\"nt\">\"severity\"</span><span class=\"p\">:</span> <span class=\"s2\">\"INFO\"</span><span class=\"p\">,</span>\n                        <span class=\"nt\">\"unparametrized_name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"test_ec2_instance_has_required_tags\"</span>\n                    <span class=\"p\">}</span>\n<span class=\"err\">...</span>\n</pre>\n<h3>Test Regressions</h3>\n<p>pytest-services custom config format adds support for marking specific tests on specific resources as regressions.\nAs with <code>severity</code> this does not modify the pytest results, but rather adds a marker that can be used when analyzing the results.</p>\n<p>The config looks like:</p>\n<pre><code>...\nregressions:\n  - test_name: test_ec2_security_group_opens_all_ports_to_all\n    test_param_id: '*mycustomgroup'\n    comment: this was remediated by ops team\n...\n</code></pre>\n<h3>AWS Config</h3>\n<p>pytest-services has a suite of AWS tests. This section of the custom config includes configuration options specific\nto these tests.</p>\n<p>The config looks like:</p>\n<pre><code>...\naws:\n  # Relative time delta for test_iam_user_is_inactive. no_activity_since will be used as the failure marker,\n  # so in this example any user that hasn't had any activity for a year will be marked as a \"failure\". created_after\n  # is used as a grace period, so in this case any user that was created within the last week will be automatically\n  # pass this test.\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n    created_after:\n      weeks: 1\n  # Required tags used within the test_ec2_instance_has_required_tags test\n  required_tags:\n    - Name\n    - Type\n    - App\n    - Env\n  # Whitelsited ports for the test_ec2_security_group_opens_specific_ports_to_all\n  # test for all instances\n  whitelisted_ports_global:\n    - 25\n  # Whitelsited ports for the test_ec2_security_group_opens_specific_ports_to_all\n  # test for specific instances. In this example, we are whitelisting ports 22\n  # and 2222 for all security groups that include the word 'bastion' in them.\n  whitelisted_ports:\n    - test_param_id: '*bastion'\n      ports:\n        - 22\n        - 2222\n...\n</code></pre>\n<h3>GSuite Config</h3>\n<p>pytest-services has a suite of GSuite tests. This section of the\ncustom config includes configuration options specific to these tests.</p>\n<p><strong>Make sure to <a href=\"#setting-up-gsuite-tests\" rel=\"nofollow\">setup GSuite</a> before running GSuite tests</strong></p>\n<p>The config looks like:</p>\n<pre><code>gsuite:\n  # The specific GSuite domain to test.\n  domain: 'example.com'\n  # Relative time delta for test_admin_user_is_inactive. no_activity_since will be used as the failure marker,\n  # so in this example any user that hasn't had any activity for a year will be marked as a \"failure\".\n  user_is_inactive:\n    no_activity_since:\n      years: 1\n      months: 0\n</code></pre>\n<h3>Pagerduty Config</h3>\n<p>pytest-services does not query the pagerduty API, but can run tests against output from it.</p>\n<p>The config looks like:</p>\n<pre><code>pagerduty:\n  users_with_remote_access_monitoring: 'pd_users.json'\n  bastion_users: 'hierahash/*hierahash.json'\n  alternate_usernames: 'alternate_usernames.json'\n</code></pre>\n<p>Where <code>users_with_remote_access_monitoring</code> and <code>bastion_users</code> are\nglobs for multiple files relative to the current working directory and\n<code>alternate_usernames</code> is the path to a single file.</p>\n<p>The files have examples formats as follows:</p>\n<ul>\n<li><code>users_with_remote_access_monitoring</code>:</li>\n</ul>\n<pre><span class=\"p\">[</span>\n  <span class=\"p\">{</span>\n    <span class=\"nt\">\"avatar_url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"https://secure.gravatar.com/avatar/...\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"billed\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"color\"</span><span class=\"p\">:</span> <span class=\"s2\">\"sea-green\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"contact_methods\"</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n    <span class=\"nt\">\"description\"</span><span class=\"p\">:</span> <span class=\"kc\">null</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"email\"</span><span class=\"p\">:</span> <span class=\"s2\">\"example@example.com\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"html_url\"</span><span class=\"p\">:</span> <span class=\"s2\">\"https://example.pagerduty.com/users/AAA0999\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"AAA0999\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"invitation_sent\"</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"job_title\"</span><span class=\"p\">:</span> <span class=\"kc\">null</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"name\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Example Examplerton\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"notification_rules\"</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n    <span class=\"nt\">\"role\"</span><span class=\"p\">:</span> <span class=\"s2\">\"user\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"self_\"</span><span class=\"p\">:</span> <span class=\"s2\">\"https://api.pagerduty.com/users/AAA0999\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"summary\"</span><span class=\"p\">:</span> <span class=\"s2\">\"C. Hobbes\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"teams\"</span><span class=\"p\">:</span> <span class=\"p\">[],</span>\n    <span class=\"nt\">\"time_zone\"</span><span class=\"p\">:</span> <span class=\"s2\">\"America/New_York\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"user\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"err\">...</span>\n<span class=\"p\">]</span>\n</pre>\n<ul>\n<li><code>bastion_users</code>:</li>\n</ul>\n<pre><span class=\"p\">{</span>\n  <span class=\"nt\">\"chobbes\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"groups\"</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">\"\"</span><span class=\"p\">],</span>\n    <span class=\"nt\">\"root_ssh\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span>\n  <span class=\"p\">},</span>\n  <span class=\"nt\">\"movedon\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"nt\">\"ensure\"</span><span class=\"p\">:</span> <span class=\"s2\">\"absent\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"err\">...</span>\n<span class=\"p\">}</span>\n</pre>\n<ul>\n<li><code>alternate_usernames</code>:</li>\n</ul>\n<pre><span class=\"p\">{</span>\n  <span class=\"nt\">\"chobbes\"</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">\"calvin\"</span><span class=\"p\">,</span> <span class=\"s2\">\"spacemanspiff\"</span><span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</pre>\n<h3>Test Accuracy</h3>\n<p>There are two important things to note about <code>pytest-services</code> tests that may be different from your expectations.</p>\n<p>First, the focus is on \"actionable results\". This plays out as an attempt to reduce false\npositives by trying to filter out unused resources. An example of this can be seen by looking at\nany of the security group tests, where we are skipping any security groups that are not attached to a resource.</p>\n<p>Second, there are some tests that make naive assumptions instead of trying to capture the complexities\nof the system. The current best example of this is all IAM tests that relate to \"admin\" users. How we\nare determining what an user or role is an admin is based simply off substring matching on the policies\nattached. This obviously has a high chance of false negatives.</p>\n<h2>Development</h2>\n<h3>Goals</h3>\n<ol>\n<li>replace one-off scripts for each check</li>\n<li>share checks with other organizations</li>\n<li>consolidate bugs in one place (i.e. one thing to update)</li>\n<li>in pytest use a known existing framework for writing checks</li>\n<li>be vendor agnostic e.g. support checks across cloud providers or in hybrid environments or competing services</li>\n<li>cache and share responses to reduce third party API usage (i.e. lots of tests check AWS security groups so fetch them once)</li>\n<li>provide a way to run a single test or subset of tests</li>\n<li>focus on actionable results (see <a href=\"#test-accuracy\" rel=\"nofollow\">test accuracy</a> for more information)</li>\n</ol>\n<h3>Non-Goals</h3>\n<ol>\n<li>Invent a new DSL for writing expectations (use pytest conventions)</li>\n<li>Verify how third party services or their client libraries work\n(e.g. don't answer \"Does GET / on the CRUD1 API return 400 when\nquery param <code>q</code> is <code>$bad_value</code>?\")</li>\n</ol>\n<h3>Design</h3>\n<p>Currently this is a monolithic pytest package, but should eventually\n<a href=\"#3\" rel=\"nofollow\">be extracted into a pytest plugin</a> and with <a href=\"#4\" rel=\"nofollow\">separate dependent\npytest plugins for each service</a>.</p>\n<p>API responses should fit on disk and in memory (i.e. don't use this\nfor log processing or checking binaries for malware), and be safe to\ncache for minutes, hours, or days (i.e. probably don't use this for\nmonitoring a streaming API) (NB: <a href=\"#5\" rel=\"nofollow\">bug for specifying data\nfreshness</a>).</p>\n<p>Additionally we want:</p>\n<ul>\n<li>data fetching functions in a <code>resources.py</code></li>\n<li>data checking and test helpers in a <code>helpers.py</code></li>\n<li>prefix test files with <code>test_</code></li>\n<li>doctests for non test files (e.g. <code>helpers.py</code>, <code>resources.py</code>, <code>client.py</code>)\n<ul>\n<li>tests that depend on external IO or the runtime environment (env vars, file system, HTTP) to use the prefix <code>meta_test_</code> (and probably <code>mock</code> or <code>pytest.monkeypatch</code>)\n<ul>\n<li>JSON fixtures for anonymized cached http call in <code>example_cache/v/</code></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>tests to have pytest markers for any services they depend on for data</li>\n<li>HTTP clients should be read only and use read only credentials</li>\n<li>running a test should not modify services</li>\n</ul>\n<h4>File Layout</h4>\n<pre><span class=\"go\">pytest-services</span>\n<span class=\"go\">...</span>\n<span class=\"go\">\u251c\u2500\u2500 example_cache</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2514\u2500\u2500 v</span>\n<span class=\"go\">\u2502\u00a0\u00a0     \u251c\u2500\u2500 cache</span>\n<span class=\"go\">\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 lastfailed</span>\n<span class=\"go\">\u2502\u00a0\u00a0     \u251c\u2500\u2500 pytest_aws:example-account:us-east-1:ec2:describe_instances::.json</span>\n<span class=\"go\">\u2502\u00a0\u00a0     \u251c\u2500\u2500 pytest_aws:example-account:us-east-1:ec2:describe_security_groups::.json</span>\n<span class=\"go\">...</span>\n<span class=\"go\">\u251c\u2500\u2500 &lt;third party service A&gt;</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u251c\u2500\u2500 client.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u251c\u2500\u2500 meta_test_client.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u251c\u2500\u2500 &lt;subservice A (optional)&gt;</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 helpers.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 resources.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ...</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 test_ec2_security_group_all_ports.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u251c\u2500\u2500 &lt;subservice b (optional)&gt;</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 resources.py</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ...</span>\n<span class=\"go\">\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500 test_s3_bucket_web_hosting_disabled.py</span>\n<span class=\"go\">\u2514\u2500\u2500 &lt;third party service B&gt;</span>\n<span class=\"go\"> \u00a0\u00a0 \u251c\u2500\u2500 __init__.py</span>\n<span class=\"go\"> \u00a0\u00a0 \u251c\u2500\u2500 helpers.py</span>\n<span class=\"go\"> \u00a0\u00a0 \u251c\u2500\u2500 resources.py</span>\n<span class=\"go\"> \u00a0\u00a0 \u2514\u2500\u2500 test_user_has_escalation_policy.py</span>\n</pre>\n<h3>Adding an example test</h3>\n<p>Let's write a test to check that <a href=\"http://httpbin.org/ip\" rel=\"nofollow\">http://httpbin.org/ip</a> returns an AWS IP:</p>\n<ol>\n<li>create a file <code>httpbin/test_httpbin_ip.py</code> with the contents:</li>\n</ol>\n<pre><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n<span class=\"kn\">import</span> <span class=\"nn\">ipaddress</span>\n<span class=\"kn\">import</span> <span class=\"nn\">pytest</span>\n<span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">urllib.request</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_httpbin_ips</span><span class=\"p\">():</span>\n    <span class=\"c1\"># IPs we always want to test</span>\n    <span class=\"n\">ips</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n        <span class=\"s1\">'127.0.0.1'</span><span class=\"p\">,</span>\n        <span class=\"s1\">'13.58.0.0'</span><span class=\"p\">,</span>\n    <span class=\"p\">]</span>\n\n    <span class=\"n\">req</span> <span class=\"o\">=</span> <span class=\"n\">urllib</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">Request</span><span class=\"p\">(</span><span class=\"s1\">'http://httpbin.org/ip'</span><span class=\"p\">)</span>\n\n    <span class=\"k\">with</span> <span class=\"n\">urllib</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">urlopen</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">response</span><span class=\"p\">:</span>\n        <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s1\">'utf-8'</span><span class=\"p\">)</span>\n        <span class=\"n\">ips</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">'origin'</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">))</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">ips</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_aws_ips</span><span class=\"p\">():</span>\n    <span class=\"n\">req</span> <span class=\"o\">=</span> <span class=\"n\">urllib</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">Request</span><span class=\"p\">(</span><span class=\"s1\">'https://ip-ranges.amazonaws.com/ip-ranges.json'</span><span class=\"p\">)</span>\n\n    <span class=\"k\">with</span> <span class=\"n\">urllib</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">urlopen</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">response</span><span class=\"p\">:</span>\n        <span class=\"n\">body</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s1\">'utf-8'</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">)[</span><span class=\"s1\">'prefixes'</span><span class=\"p\">]</span>\n\n\n<span class=\"nd\">@pytest</span><span class=\"o\">.</span><span class=\"n\">mark</span><span class=\"o\">.</span><span class=\"n\">httpbin</span>\n<span class=\"nd\">@pytest</span><span class=\"o\">.</span><span class=\"n\">mark</span><span class=\"o\">.</span><span class=\"n\">aws_ip_ranges</span>\n<span class=\"nd\">@pytest</span><span class=\"o\">.</span><span class=\"n\">mark</span><span class=\"o\">.</span><span class=\"n\">parametrize</span><span class=\"p\">(</span>\n    <span class=\"p\">[</span><span class=\"s1\">'ip'</span><span class=\"p\">,</span> <span class=\"s1\">'aws_ip_ranges'</span><span class=\"p\">],</span>\n    <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"n\">get_httpbin_ips</span><span class=\"p\">(),</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">repeat</span><span class=\"p\">(</span><span class=\"n\">get_aws_ips</span><span class=\"p\">())))</span>\n<span class=\"k\">def</span> <span class=\"nf\">test_httpbin_ip_in_aws</span><span class=\"p\">(</span><span class=\"n\">ip</span><span class=\"p\">,</span> <span class=\"n\">aws_ip_ranges</span><span class=\"p\">):</span>\n    <span class=\"k\">for</span> <span class=\"n\">aws_ip_range</span> <span class=\"ow\">in</span> <span class=\"n\">aws_ip_ranges</span><span class=\"p\">:</span>\n        <span class=\"k\">assert</span> <span class=\"n\">ipaddress</span><span class=\"o\">.</span><span class=\"n\">IPv4Address</span><span class=\"p\">(</span><span class=\"n\">ip</span><span class=\"p\">)</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">ipaddress</span><span class=\"o\">.</span><span class=\"n\">ip_network</span><span class=\"p\">(</span><span class=\"n\">aws_ip_range</span><span class=\"p\">[</span><span class=\"s1\">'ip_prefix'</span><span class=\"p\">]),</span> \\\n          <span class=\"s2\">\"</span><span class=\"si\">{0}</span><span class=\"s2\"> is in AWS range </span><span class=\"si\">{1[ip_prefix]}</span><span class=\"s2\"> region </span><span class=\"si\">{1[region]}</span><span class=\"s2\"> service </span><span class=\"si\">{1[service]}</span><span class=\"s2\">\"</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">ip</span><span class=\"p\">,</span> <span class=\"n\">aws_ip_range</span><span class=\"p\">)</span>\n</pre>\n<p>Notes:</p>\n<ul>\n<li>we add two data fetching functions that return lists that we can zip into tuples for <a href=\"https://docs.pytest.org/en/latest/parametrize.html#pytest-mark-parametrize-parametrizing-test-functions\" rel=\"nofollow\">the pytest parametrize decorator</a></li>\n<li>we add markers for the services we're fetching data from</li>\n</ul>\n<ol>\n<li>Running it we see that one of the IPs is an AWS IP:</li>\n</ol>\n<pre><span class=\"go\">pytest --ignore aws/</span>\n<span class=\"go\">platform darwin -- Python 3.6.2, pytest-3.3.2, py-1.5.2, pluggy-0.6.0</span>\n<span class=\"go\">metadata: {'Python': '3.6.2', 'Platform': 'Darwin-15.6.0-x86_64-i386-64bit', 'Packages': {'pytest': '3.3.2', 'py': '1.5.2', 'pluggy': '0.6.0'}, 'Plugins': {'metadata': '1.5.1', 'json': '0.4.0', 'html': '1.16.1'}}</span>\n<span class=\"go\">rootdir: /Users/gguthe/mozilla-services/pytest-services, inifile:</span>\n<span class=\"go\">plugins: metadata-1.5.1, json-0.4.0, html-1.16.1</span>\n<span class=\"go\">collected 3 items</span>\n\n<span class=\"go\">httpbin/test_httpbin_ip_in_aws.py .F.                                                                                               [100%]</span>\n\n<span class=\"go\">================================================================ FAILURES =================================================================</span>\n<span class=\"go\">____________________________________________ test_httpbin_ip_in_aws[13.58.0.0-aws_ip_ranges1] _____________________________________________</span>\n\n<span class=\"go\">ip = '13.58.0.0'</span>\n<span class=\"go\">aws_ip_ranges = [{'ip_prefix': '13.32.0.0/15', 'region': 'GLOBAL', 'service': 'AMAZON'}, {'ip_prefix': '13.35.0.0/16', 'region': 'GLOB...on': 'us-west-1', 'service': 'AMAZON'}, {'ip_prefix': '13.57.0.0/16', 'region': 'us-west-1', 'service': 'AMAZON'}, ...]</span>\n\n<span class=\"go\">    @pytest.mark.httpbin</span>\n<span class=\"go\">    @pytest.mark.aws_ip_ranges</span>\n<span class=\"go\">    @pytest.mark.parametrize(</span>\n<span class=\"go\">        ['ip', 'aws_ip_ranges'],</span>\n<span class=\"go\">        zip(get_httpbin_ips(), itertools.repeat(get_aws_ips())),</span>\n<span class=\"gp\">        #</span> <span class=\"nv\">ids</span><span class=\"o\">=</span>lambda ip: ip\n<span class=\"go\">        )</span>\n<span class=\"go\">    def test_httpbin_ip_in_aws(ip, aws_ip_ranges):</span>\n<span class=\"go\">        for aws_ip_range in aws_ip_ranges:</span>\n<span class=\"gp\">&gt;</span>           assert ipaddress.IPv4Address<span class=\"o\">(</span>ip<span class=\"o\">)</span> not in ipaddress.ip_network<span class=\"o\">(</span>aws_ip_range<span class=\"o\">[</span><span class=\"s1\">'ip_prefix'</span><span class=\"o\">])</span>, <span class=\"se\">\\</span>\n              <span class=\"s2\">\"{0} is in AWS range {1[ip_prefix]} region {1[region]} service {1[service]}\"</span>.format<span class=\"o\">(</span>ip, aws_ip_range<span class=\"o\">)</span>\n<span class=\"go\">E           AssertionError: 13.58.0.0 is in AWS range 13.58.0.0/15 region us-east-2 service AMAZON</span>\n<span class=\"go\">E           assert IPv4Address('13.58.0.0') not in IPv4Network('13.58.0.0/15')</span>\n<span class=\"go\">E            +  where IPv4Address('13.58.0.0') = &lt;class 'ipaddress.IPv4Address'&gt;('13.58.0.0')</span>\n<span class=\"go\">E            +    where &lt;class 'ipaddress.IPv4Address'&gt; = ipaddress.IPv4Address</span>\n<span class=\"go\">E            +  and   IPv4Network('13.58.0.0/15') = &lt;function ip_network at 0x107cf66a8&gt;('13.58.0.0/15')</span>\n<span class=\"go\">E            +    where &lt;function ip_network at 0x107cf66a8&gt; = ipaddress.ip_network</span>\n\n<span class=\"go\">httpbin/test_httpbin_ip_in_aws.py:43: AssertionError</span>\n<span class=\"go\">=================================================== 1 failed, 2 passed in 15.69 seconds ===================================================</span>\n</pre>\n<p>Note: marking tests as expected failures with <code>@pytest.mark.xfail</code> can hide data fetching errors</p>\n<p>To improve this we could:</p>\n<ol>\n<li>Add parametrize ids so it's clearer which parametrize caused test failures</li>\n<li>Add directions about why it's an issue and how to fix it or what the associated risks are</li>\n</ol>\n<p>As we add more tests we can:</p>\n<ol>\n<li>Move the JSON fetching functions to <code>&lt;service name&gt;/resources.py</code> files and import them into the test</li>\n<li>Move the fetching logic to a shared library <code>&lt;service name&gt;/client.py</code> and save to the pytest cache</li>\n</ol>\n\n          </div>"}, "last_serial": 5805364, "releases": {"0.3.1": [{"comment_text": "", "digests": {"md5": "a809666651e63c75610999383188e670", "sha256": "d5f4a4539b6d484062f4efbaa7c6078b6ba61e8ddc9faec2514153c9baf705de"}, "downloads": -1, "filename": "frost-0.3.1-py3-none-any.whl", "has_sig": false, "md5_digest": "a809666651e63c75610999383188e670", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.6", "size": 65938, "upload_time": "2019-09-09T20:10:37", "upload_time_iso_8601": "2019-09-09T20:10:37.009678Z", "url": "https://files.pythonhosted.org/packages/06/87/b1558befdc0a1937f9fb1ded8e8d6b6cdb26c0a11429e2b5a9548caa2a15/frost-0.3.1-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "af94fa31fbb8c1141fde0b47e5018a4a", "sha256": "b9000141f380555c4f782cc6b432a6da1997bc526d5ee1d4d52df1738027c634"}, "downloads": -1, "filename": "frost-0.3.1.tar.gz", "has_sig": false, "md5_digest": "af94fa31fbb8c1141fde0b47e5018a4a", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 53249, "upload_time": "2019-09-09T20:10:26", "upload_time_iso_8601": "2019-09-09T20:10:26.611834Z", "url": "https://files.pythonhosted.org/packages/af/6f/0b6c60d24c13fba434eff859895cb8c454d039b9aa0e38b716650db66738/frost-0.3.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "a809666651e63c75610999383188e670", "sha256": "d5f4a4539b6d484062f4efbaa7c6078b6ba61e8ddc9faec2514153c9baf705de"}, "downloads": -1, "filename": "frost-0.3.1-py3-none-any.whl", "has_sig": false, "md5_digest": "a809666651e63c75610999383188e670", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.6", "size": 65938, "upload_time": "2019-09-09T20:10:37", "upload_time_iso_8601": "2019-09-09T20:10:37.009678Z", "url": "https://files.pythonhosted.org/packages/06/87/b1558befdc0a1937f9fb1ded8e8d6b6cdb26c0a11429e2b5a9548caa2a15/frost-0.3.1-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "af94fa31fbb8c1141fde0b47e5018a4a", "sha256": "b9000141f380555c4f782cc6b432a6da1997bc526d5ee1d4d52df1738027c634"}, "downloads": -1, "filename": "frost-0.3.1.tar.gz", "has_sig": false, "md5_digest": "af94fa31fbb8c1141fde0b47e5018a4a", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.6", "size": 53249, "upload_time": "2019-09-09T20:10:26", "upload_time_iso_8601": "2019-09-09T20:10:26.611834Z", "url": "https://files.pythonhosted.org/packages/af/6f/0b6c60d24c13fba434eff859895cb8c454d039b9aa0e38b716650db66738/frost-0.3.1.tar.gz", "yanked": false}], "timestamp": "Fri May  8 01:00:10 2020"}