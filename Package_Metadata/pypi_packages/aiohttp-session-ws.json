{"info": {"author": "Devin Fee", "author_email": "devin@devinfee.com", "bugtrack_url": null, "classifiers": ["Framework :: AsyncIO", "Intended Audience :: Developers", "License :: OSI Approved :: MIT License", "Programming Language :: Python", "Programming Language :: Python :: 3", "Programming Language :: Python :: 3.5", "Programming Language :: Python :: 3.6", "Programming Language :: Python :: 3.7", "Topic :: Internet :: WWW/HTTP"], "description": "====================\n`aiohttp_session_ws`\n====================\n\n.. image:: https://travis-ci.org/dfee/aiohttp_session_ws.svg?branch=master\n    :target: https://travis-ci.org/dfee/aiohttp_session_ws\n.. image:: https://coveralls.io/repos/github/dfee/aiohttp_session_ws/badge.svg?branch=master\n    :target: https://coveralls.io/github/dfee/aiohttp_session_ws?branch=master\n\n\nSimply put: associate your websockets with a user's session, and close those connections when you see fit.\n\nFor example, let's say you're using `aiohttp_security <https://pypi.org/project/aiohttp_security/>`_ and a user chooses to log in or log out.\nUsing ``aiohttp_session_ws`` you can disconnect the open websocket subscriptions associated with their session, and force them to re-connect and re-authorize thier websocket subscriptions.\n\n.. image:: demo/demo.gif\n\n\nBasic Example\n-------------\n\nThe pieces of code in this example are taken from the ``demo`` directory of this repository.\n\n.. code-block:: python\n\n    async def handle_root(request):\n        return web.Response(text='Hello world', content_type=\"text/html\")\n\n    async def handle_reset(request):\n        session_ws_id = await get_session_ws_id(request)\n        response = web.Response(\n            text=f\"Reset called on session {session_ws_id}!\",\n            content_type=\"text/plain\",\n        )\n        await schedule_close_all_session_ws(request, response)\n        await new_session_ws_id(request)\n        return response\n\n    async def handle_websocket(request):\n        async with session_ws(request) as wsr:\n            connected_at = datetime.now()\n            session_ws_id = await get_session_ws_id(request)\n            while True:\n                await wsr.send_str(\n                    f\"Websocket associated with session [{session_ws_id}] \"\n                    f\"connected for {(datetime.now() - connected_at).seconds}\"\n                )\n                await asyncio.sleep(1)\n            return wsr\n\n    def make_app():\n        app = web.Application(\n            middlewares=[\n                aiohttp_session.session_middleware(\n                    aiohttp_session.SimpleCookieStorage()\n                ),\n                session_ws_middleware,\n            ]\n        )\n        app.router.add_get(\"/\", handle_root)\n        app.router.add_get(\"/reset\", handle_reset)\n        app.router.add_get(\"/ws\", handle_websocket)\n\n        setup_session_websockets(app, SessionWSRegistry())\n        return app\n\nUse the code from the ``demo`` folder, which includes a simple template to interact with the websocket in your web-browser.\n\n\nNarrative API\n-------------\n\nThis package is designed to be straightforward and easy to use.\nThis lightweight documentation doesn't attempt to replace the need to read the code, so you're encouraged to go do exactly that.\n\nThere are a few moving pieces, but if (and when) you need to do something more complex, you can subclass away.\n\n\n``SessionWSRegistry``\n~~~~~~~~~~~~~~~~~~~~~\nThis is the core of ``aiohttp_session_ws``.\n\nIt's construction is noteworthy:\n\n``SessionWSRegistry(self, *, id_factory, session_key)``\n\n``id_factory`` generates a session-wide id that associates the websockets.\nThe default id_factory returns a UUID4, but you can supply your own callable (async callables are supported, too).\nthe function signature of ``id_factory`` is:\n\n``id_factory(request: aiohttp.web.Request) -> typing.Hashable``\n\nSo pretty much, return something that can be the key in a dictionary (strings, integers, etc.).\n\n``session_key`` is the name of the key in the session that maps to the session-wide websocket identifier.\nBy default it's a sensible ``aiohttp_session_ws_id``.\n\n\nHelpers\n~~~~~~~\n\nYou won't need to interact with ``SessionWSRegistry`` directly after you've created it, but know that it's available in your ``aiohttp.web.Application`` (access it like this: ``app['aiohttp_session_ws_registry']``).\n\nThe friendly global manipulators of this object are:\n\n- ``get_session_ws_id(request)``\n- ``new_session_ws_id(request)``\n- ``delete_session_ws_id(request)``\n- ``ensure_session_ws_id(request)``\n- ``schedule_close_all_session_ws(request, response)``\n\nThese methods are importable directly from ``aiohttp_session_ws``.\n\nNotice that ``schedule_close_all_session_ws`` takes a response object.\nThis allows us to end the ``keep-alive`` status of the response (via ``aiohttp.web.Response.force_close``).\nThis means that as soon as your user has finished receiveing the response, their outstanding websockets will close.\n\nThis also means that if you have users with re-connecting websockets, you should probably follow this pattern:\n\n.. code-block:: python\n\n    async def handle_logout(request):\n        response = web.HTTPFound('/')\n        await schedule_close_all_session_ws(request, response)\n        await aiohttp_session.new_session(request)\n        await new_session_ws_id(request)\n        return response\n\n\nsession_ws\n~~~~~~~~~~\n\nTo track the websockets, you'll use the async context manager ``session_ws``.\nThis context manager upgrades the request, and provides its ``aiothttp.web.WebSocketResponse`` counterpart.\nUse if like this:\n\n.. code-block:: python\n\n    async def handle_websocket(request):\n        async with session_ws(request) as wsr:\n            async for msg in wsr:\n                await wsr.send_str(f'Heard: {ws.data}')\n            return wsr\n\nThat's it. Pretty simple, right?\nIf you'd like to provide the ``aiohttp.web.WebSocketResponse`` with initialization options (for example, the supported websocket protocols), pass those along to ``session_ws`` as named arguments.\n\n.. code-block:: python\n\n    async def handle_websocket(request):\n        async with session_ws(request, protocols=('graphql-ws',)) as wsr:\n            async for msg in wsr:\n                await wsr.send_str(f'Heard: {ws.data}')\n            return wsr\n\n\nAs mentioned in the *Notes* below, it's important that your users have a ``session_ws id`` prior to attempting a websocket connection (hint: Safari).\n\nUse the ``session_ws_middleware`` to automatically add the key to your sessions.\nIt should be inside the call-stack of ``aiohttp_session.session_middleware``:\n\n.. code-block:: python\n\n    web.Application(\n        middlewares=[\n            aiohttp_session.session_middleware(\n                aiohttp_session.SimpleCookieStorage()\n            ),\n            session_ws_middleware,\n        ]\n    )\n\n\nFinally, to set all of this up, you'll want to use the ``setup`` method (feel encourged to import it as ``setup_session_ws``).\n\nBasic usage looks like this:\n\n.. code-block:: python\n\n    web.Application(\n        middlewares=[\n            aiohttp_session.session_middleware(\n                aiohttp_session.SimpleCookieStorage()\n            ),\n            session_ws_middleware,\n        ]\n    )\n    setup(app, SessionWSRegistry())  # <------\n    # etc...\n    return app\n\n\nNotes\n-----\n\nWhile ``session_ws`` generates an ``aiohttp_session_ws_id`` upon connect (if it's not present), some browsers don't respect ``Set-Cookie`` on a websocket upgrade (e.g. Safari).\n\nTherefore it's best if you ensure that an ``aiohttp_session_ws_id`` is present in the users session prior to attempting a websocket connection (if using ``aiohttp_session.SimpleCookieStorage`` or ``aiohttp_session.EncryptedCookieStorage``).\n\nIf you're using something more advanced that stores a reference to the session in the session cookie, and stores the actual value server-side (like ``aiohttp_session.RedisStorage``), then it's not important when ``aiohttp_session_ws_id`` is set on the cookie, but it is still important that the user has a session cookie prior to a connection attempt.\n\nIf you want to put the session-ws-id (usually ``aiohttp_session_ws_id``) somewhere else in the session, or derive it from the request, you can.\nSimply subclass ``SessionWSRegistry`` and revise the ``get_id``, ``set_id``, and ``delete_id`` methods.\n\nIf you have a cluster of webservers, you'll need to subclass ``SessionWSRegistry`` and revise the ``register`` and ``unregister`` functions so listen on a message broker (for example, using ``aioredis`` and its pubsub feature).", "description_content_type": "text/x-rst", "docs_url": null, "download_url": "", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://github.com/dfee/aiohttp_session_ws", "keywords": "aiohttp,websocket", "license": "", "maintainer": "Devin Fee", "maintainer_email": "devin@devinfee.com", "name": "aiohttp-session-ws", "package_url": "https://pypi.org/project/aiohttp-session-ws/", "platform": "", "project_url": "https://pypi.org/project/aiohttp-session-ws/", "project_urls": {"Homepage": "https://github.com/dfee/aiohttp_session_ws"}, "release_url": "https://pypi.org/project/aiohttp-session-ws/1.1.1/", "requires_dist": ["aiohttp (>=3.4,<4.0)", "aiohttp_session (>=2.5,<3.0)"], "requires_python": ">=3.5,<4.0", "summary": "session-managed websockets for aiohttp", "version": "1.1.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <a href=\"https://travis-ci.org/dfee/aiohttp_session_ws\" rel=\"nofollow\"><img alt=\"https://travis-ci.org/dfee/aiohttp_session_ws.svg?branch=master\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/59ff13436563438f136115cd2cc9aff9a2fbd32d/68747470733a2f2f7472617669732d63692e6f72672f646665652f61696f687474705f73657373696f6e5f77732e7376673f6272616e63683d6d6173746572\"></a>\n<a href=\"https://coveralls.io/github/dfee/aiohttp_session_ws?branch=master\" rel=\"nofollow\"><img alt=\"https://coveralls.io/repos/github/dfee/aiohttp_session_ws/badge.svg?branch=master\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/2c93f407166a0e3d6130c05ed1954a04ce8dbd05/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f646665652f61696f687474705f73657373696f6e5f77732f62616467652e7376673f6272616e63683d6d6173746572\"></a>\n<p>Simply put: associate your websockets with a user\u2019s session, and close those connections when you see fit.</p>\n<p>For example, let\u2019s say you\u2019re using <a href=\"https://pypi.org/project/aiohttp_security/\" rel=\"nofollow\">aiohttp_security</a> and a user chooses to log in or log out.\nUsing <tt>aiohttp_session_ws</tt> you can disconnect the open websocket subscriptions associated with their session, and force them to re-connect and re-authorize thier websocket subscriptions.</p>\n<img alt=\"demo/demo.gif\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/4d415d44053d71ac8e001482f5a5509cc496f26b/64656d6f2f64656d6f2e676966\">\n<div id=\"basic-example\">\n<h2>Basic Example</h2>\n<p>The pieces of code in this example are taken from the <tt>demo</tt> directory of this repository.</p>\n<pre><span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_root</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Response</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"o\">=</span><span class=\"s1\">'Hello world'</span><span class=\"p\">,</span> <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s2\">\"text/html\"</span><span class=\"p\">)</span>\n\n<span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_reset</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">session_ws_id</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"n\">get_session_ws_id</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Response</span><span class=\"p\">(</span>\n        <span class=\"n\">text</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s2\">\"Reset called on session </span><span class=\"si\">{</span><span class=\"n\">session_ws_id</span><span class=\"si\">}</span><span class=\"s2\">!\"</span><span class=\"p\">,</span>\n        <span class=\"n\">content_type</span><span class=\"o\">=</span><span class=\"s2\">\"text/plain\"</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">await</span> <span class=\"n\">schedule_close_all_session_ws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n    <span class=\"k\">await</span> <span class=\"n\">new_session_ws_id</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span>\n\n<span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_websocket</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">async</span> <span class=\"k\">with</span> <span class=\"n\">session_ws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">wsr</span><span class=\"p\">:</span>\n        <span class=\"n\">connected_at</span> <span class=\"o\">=</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n        <span class=\"n\">session_ws_id</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"n\">get_session_ws_id</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n            <span class=\"k\">await</span> <span class=\"n\">wsr</span><span class=\"o\">.</span><span class=\"n\">send_str</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">\"Websocket associated with session [</span><span class=\"si\">{</span><span class=\"n\">session_ws_id</span><span class=\"si\">}</span><span class=\"s2\">] \"</span>\n                <span class=\"sa\">f</span><span class=\"s2\">\"connected for </span><span class=\"si\">{</span><span class=\"p\">(</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"n\">connected_at</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">seconds</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">await</span> <span class=\"n\">asyncio</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">wsr</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">make_app</span><span class=\"p\">():</span>\n    <span class=\"n\">app</span> <span class=\"o\">=</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Application</span><span class=\"p\">(</span>\n        <span class=\"n\">middlewares</span><span class=\"o\">=</span><span class=\"p\">[</span>\n            <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">session_middleware</span><span class=\"p\">(</span>\n                <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">SimpleCookieStorage</span><span class=\"p\">()</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">session_ws_middleware</span><span class=\"p\">,</span>\n        <span class=\"p\">]</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">add_get</span><span class=\"p\">(</span><span class=\"s2\">\"/\"</span><span class=\"p\">,</span> <span class=\"n\">handle_root</span><span class=\"p\">)</span>\n    <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">add_get</span><span class=\"p\">(</span><span class=\"s2\">\"/reset\"</span><span class=\"p\">,</span> <span class=\"n\">handle_reset</span><span class=\"p\">)</span>\n    <span class=\"n\">app</span><span class=\"o\">.</span><span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">add_get</span><span class=\"p\">(</span><span class=\"s2\">\"/ws\"</span><span class=\"p\">,</span> <span class=\"n\">handle_websocket</span><span class=\"p\">)</span>\n\n    <span class=\"n\">setup_session_websockets</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">,</span> <span class=\"n\">SessionWSRegistry</span><span class=\"p\">())</span>\n    <span class=\"k\">return</span> <span class=\"n\">app</span>\n</pre>\n<p>Use the code from the <tt>demo</tt> folder, which includes a simple template to interact with the websocket in your web-browser.</p>\n</div>\n<div id=\"narrative-api\">\n<h2>Narrative API</h2>\n<p>This package is designed to be straightforward and easy to use.\nThis lightweight documentation doesn\u2019t attempt to replace the need to read the code, so you\u2019re encouraged to go do exactly that.</p>\n<p>There are a few moving pieces, but if (and when) you need to do something more complex, you can subclass away.</p>\n<div id=\"sessionwsregistry\">\n<h3><tt>SessionWSRegistry</tt></h3>\n<p>This is the core of <tt>aiohttp_session_ws</tt>.</p>\n<p>It\u2019s construction is noteworthy:</p>\n<p><tt>SessionWSRegistry(self, *, id_factory, session_key)</tt></p>\n<p><tt>id_factory</tt> generates a session-wide id that associates the websockets.\nThe default id_factory returns a UUID4, but you can supply your own callable (async callables are supported, too).\nthe function signature of <tt>id_factory</tt> is:</p>\n<p><tt>id_factory(request: aiohttp.web.Request) <span class=\"pre\">-&gt;</span> typing.Hashable</tt></p>\n<p>So pretty much, return something that can be the key in a dictionary (strings, integers, etc.).</p>\n<p><tt>session_key</tt> is the name of the key in the session that maps to the session-wide websocket identifier.\nBy default it\u2019s a sensible <tt>aiohttp_session_ws_id</tt>.</p>\n</div>\n<div id=\"helpers\">\n<h3>Helpers</h3>\n<p>You won\u2019t need to interact with <tt>SessionWSRegistry</tt> directly after you\u2019ve created it, but know that it\u2019s available in your <tt>aiohttp.web.Application</tt> (access it like this: <tt><span class=\"pre\">app['aiohttp_session_ws_registry']</span></tt>).</p>\n<p>The friendly global manipulators of this object are:</p>\n<ul>\n<li><tt>get_session_ws_id(request)</tt></li>\n<li><tt>new_session_ws_id(request)</tt></li>\n<li><tt>delete_session_ws_id(request)</tt></li>\n<li><tt>ensure_session_ws_id(request)</tt></li>\n<li><tt>schedule_close_all_session_ws(request, response)</tt></li>\n</ul>\n<p>These methods are importable directly from <tt>aiohttp_session_ws</tt>.</p>\n<p>Notice that <tt>schedule_close_all_session_ws</tt> takes a response object.\nThis allows us to end the <tt><span class=\"pre\">keep-alive</span></tt> status of the response (via <tt>aiohttp.web.Response.force_close</tt>).\nThis means that as soon as your user has finished receiveing the response, their outstanding websockets will close.</p>\n<p>This also means that if you have users with re-connecting websockets, you should probably follow this pattern:</p>\n<pre><span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_logout</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">HTTPFound</span><span class=\"p\">(</span><span class=\"s1\">'/'</span><span class=\"p\">)</span>\n    <span class=\"k\">await</span> <span class=\"n\">schedule_close_all_session_ws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n    <span class=\"k\">await</span> <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">new_session</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">await</span> <span class=\"n\">new_session_ws_id</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">response</span>\n</pre>\n</div>\n<div id=\"session-ws\">\n<h3>session_ws</h3>\n<p>To track the websockets, you\u2019ll use the async context manager <tt>session_ws</tt>.\nThis context manager upgrades the request, and provides its <tt>aiothttp.web.WebSocketResponse</tt> counterpart.\nUse if like this:</p>\n<pre><span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_websocket</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">async</span> <span class=\"k\">with</span> <span class=\"n\">session_ws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">wsr</span><span class=\"p\">:</span>\n        <span class=\"k\">async</span> <span class=\"k\">for</span> <span class=\"n\">msg</span> <span class=\"ow\">in</span> <span class=\"n\">wsr</span><span class=\"p\">:</span>\n            <span class=\"k\">await</span> <span class=\"n\">wsr</span><span class=\"o\">.</span><span class=\"n\">send_str</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">'Heard: </span><span class=\"si\">{</span><span class=\"n\">ws</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"si\">}</span><span class=\"s1\">'</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">wsr</span>\n</pre>\n<p>That\u2019s it. Pretty simple, right?\nIf you\u2019d like to provide the <tt>aiohttp.web.WebSocketResponse</tt> with initialization options (for example, the supported websocket protocols), pass those along to <tt>session_ws</tt> as named arguments.</p>\n<pre><span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">handle_websocket</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">):</span>\n    <span class=\"k\">async</span> <span class=\"k\">with</span> <span class=\"n\">session_ws</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">protocols</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"s1\">'graphql-ws'</span><span class=\"p\">,))</span> <span class=\"k\">as</span> <span class=\"n\">wsr</span><span class=\"p\">:</span>\n        <span class=\"k\">async</span> <span class=\"k\">for</span> <span class=\"n\">msg</span> <span class=\"ow\">in</span> <span class=\"n\">wsr</span><span class=\"p\">:</span>\n            <span class=\"k\">await</span> <span class=\"n\">wsr</span><span class=\"o\">.</span><span class=\"n\">send_str</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">'Heard: </span><span class=\"si\">{</span><span class=\"n\">ws</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"si\">}</span><span class=\"s1\">'</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">wsr</span>\n</pre>\n<p>As mentioned in the <em>Notes</em> below, it\u2019s important that your users have a <tt>session_ws id</tt> prior to attempting a websocket connection (hint: Safari).</p>\n<p>Use the <tt>session_ws_middleware</tt> to automatically add the key to your sessions.\nIt should be inside the call-stack of <tt>aiohttp_session.session_middleware</tt>:</p>\n<pre><span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Application</span><span class=\"p\">(</span>\n    <span class=\"n\">middlewares</span><span class=\"o\">=</span><span class=\"p\">[</span>\n        <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">session_middleware</span><span class=\"p\">(</span>\n            <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">SimpleCookieStorage</span><span class=\"p\">()</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">session_ws_middleware</span><span class=\"p\">,</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">)</span>\n</pre>\n<p>Finally, to set all of this up, you\u2019ll want to use the <tt>setup</tt> method (feel encourged to import it as <tt>setup_session_ws</tt>).</p>\n<p>Basic usage looks like this:</p>\n<pre><span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Application</span><span class=\"p\">(</span>\n    <span class=\"n\">middlewares</span><span class=\"o\">=</span><span class=\"p\">[</span>\n        <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">session_middleware</span><span class=\"p\">(</span>\n            <span class=\"n\">aiohttp_session</span><span class=\"o\">.</span><span class=\"n\">SimpleCookieStorage</span><span class=\"p\">()</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">session_ws_middleware</span><span class=\"p\">,</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">)</span>\n<span class=\"n\">setup</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">,</span> <span class=\"n\">SessionWSRegistry</span><span class=\"p\">())</span>  <span class=\"c1\"># &lt;------</span>\n<span class=\"c1\"># etc...</span>\n<span class=\"k\">return</span> <span class=\"n\">app</span>\n</pre>\n</div>\n</div>\n<div id=\"notes\">\n<h2>Notes</h2>\n<p>While <tt>session_ws</tt> generates an <tt>aiohttp_session_ws_id</tt> upon connect (if it\u2019s not present), some browsers don\u2019t respect <tt><span class=\"pre\">Set-Cookie</span></tt> on a websocket upgrade (e.g. Safari).</p>\n<p>Therefore it\u2019s best if you ensure that an <tt>aiohttp_session_ws_id</tt> is present in the users session prior to attempting a websocket connection (if using <tt>aiohttp_session.SimpleCookieStorage</tt> or <tt>aiohttp_session.EncryptedCookieStorage</tt>).</p>\n<p>If you\u2019re using something more advanced that stores a reference to the session in the session cookie, and stores the actual value server-side (like <tt>aiohttp_session.RedisStorage</tt>), then it\u2019s not important when <tt>aiohttp_session_ws_id</tt> is set on the cookie, but it is still important that the user has a session cookie prior to a connection attempt.</p>\n<p>If you want to put the session-ws-id (usually <tt>aiohttp_session_ws_id</tt>) somewhere else in the session, or derive it from the request, you can.\nSimply subclass <tt>SessionWSRegistry</tt> and revise the <tt>get_id</tt>, <tt>set_id</tt>, and <tt>delete_id</tt> methods.</p>\n<p>If you have a cluster of webservers, you\u2019ll need to subclass <tt>SessionWSRegistry</tt> and revise the <tt>register</tt> and <tt>unregister</tt> functions so listen on a message broker (for example, using <tt>aioredis</tt> and its pubsub feature).</p>\n</div>\n\n          </div>"}, "last_serial": 4290957, "releases": {"1.0.0": [{"comment_text": "", "digests": {"md5": "cf29e51f6ddf57077d8b257683ef69f0", "sha256": "6c2f1ed8c087b2197a5e840a164449240ce3f5a6c00f6de081266d5fd55b2bf9"}, "downloads": -1, "filename": "aiohttp_session_ws-1.0.0-py3-none-any.whl", "has_sig": false, "md5_digest": "cf29e51f6ddf57077d8b257683ef69f0", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.5,<4.0", "size": 8570, "upload_time": "2018-09-12T04:55:13", "upload_time_iso_8601": "2018-09-12T04:55:13.905575Z", "url": "https://files.pythonhosted.org/packages/60/56/c3bcf76001a8345b37b5a93b74b1818c7620ef80434835d7aa3d58d367f4/aiohttp_session_ws-1.0.0-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "d82c572a286757dfaae4129ada7151db", "sha256": "082d56c4412fe307abcbbb47531ca0b5efff046253de283c44e117d64314d043"}, "downloads": -1, "filename": "aiohttp_session_ws-1.0.0.tar.gz", "has_sig": false, "md5_digest": "d82c572a286757dfaae4129ada7151db", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.5,<4.0", "size": 2845, "upload_time": "2018-09-12T04:55:15", "upload_time_iso_8601": "2018-09-12T04:55:15.090575Z", "url": "https://files.pythonhosted.org/packages/b2/02/212915c792c712b4fd58414423662ea4be3bf6b313222a6a3164b3efb917/aiohttp_session_ws-1.0.0.tar.gz", "yanked": false}], "1.1.0": [{"comment_text": "", "digests": {"md5": "8e0ebf7e5bdf028f4b5b83787d5c0f9c", "sha256": "c7e34a34830da0f35ff8a84a077034975b0eb6b016c2ccff57403ee86a2aa790"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.0-py3-none-any.whl", "has_sig": false, "md5_digest": "8e0ebf7e5bdf028f4b5b83787d5c0f9c", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.5,<4.0", "size": 9110, "upload_time": "2018-09-20T02:03:35", "upload_time_iso_8601": "2018-09-20T02:03:35.118646Z", "url": "https://files.pythonhosted.org/packages/59/80/6cece5c02004d0b01b6e378a885d47f50dbf9304b4a47c484625a083cdb6/aiohttp_session_ws-1.1.0-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "28bdd0b9e722c9ca56779fbdfee8a888", "sha256": "8eb06c87a3d4970ca92617bda211cfdb9922735706289b796f80a30c9d1077cc"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.0.tar.gz", "has_sig": false, "md5_digest": "28bdd0b9e722c9ca56779fbdfee8a888", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.5,<4.0", "size": 2992, "upload_time": "2018-09-20T02:03:36", "upload_time_iso_8601": "2018-09-20T02:03:36.474900Z", "url": "https://files.pythonhosted.org/packages/d3/e9/9bd3a9f9e85bac1fa8391b77bbb45cf0ecc2f02bf99ab6b85c8422722f6d/aiohttp_session_ws-1.1.0.tar.gz", "yanked": false}], "1.1.1": [{"comment_text": "", "digests": {"md5": "89469fc8228802d5622cdc5b960985df", "sha256": "f3cb6ae9dc1c0c87e6426f922123f62b9c97b02bd727a64d1db8c70d28c0f8e8"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.1-py3-none-any.whl", "has_sig": false, "md5_digest": "89469fc8228802d5622cdc5b960985df", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.5,<4.0", "size": 13202, "upload_time": "2018-09-20T02:23:33", "upload_time_iso_8601": "2018-09-20T02:23:33.726354Z", "url": "https://files.pythonhosted.org/packages/a6/a3/70857e7b59fa7fbb85e2f3e2e64aa951d192f5aab597845203376856af24/aiohttp_session_ws-1.1.1-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "92a512cbb05dd1fd4e6d3b21f99d7a33", "sha256": "9c697a816205e46fcabca85d32712d2ed6092aad84ef7d3b8ccd12588d6c49a5"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.1.tar.gz", "has_sig": false, "md5_digest": "92a512cbb05dd1fd4e6d3b21f99d7a33", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.5,<4.0", "size": 7198, "upload_time": "2018-09-20T02:23:34", "upload_time_iso_8601": "2018-09-20T02:23:34.948811Z", "url": "https://files.pythonhosted.org/packages/21/d4/070169c88a7d5b6cd621242c7c255caa59546d0ad904f3527027d3281275/aiohttp_session_ws-1.1.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "89469fc8228802d5622cdc5b960985df", "sha256": "f3cb6ae9dc1c0c87e6426f922123f62b9c97b02bd727a64d1db8c70d28c0f8e8"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.1-py3-none-any.whl", "has_sig": false, "md5_digest": "89469fc8228802d5622cdc5b960985df", "packagetype": "bdist_wheel", "python_version": "py3", "requires_python": ">=3.5,<4.0", "size": 13202, "upload_time": "2018-09-20T02:23:33", "upload_time_iso_8601": "2018-09-20T02:23:33.726354Z", "url": "https://files.pythonhosted.org/packages/a6/a3/70857e7b59fa7fbb85e2f3e2e64aa951d192f5aab597845203376856af24/aiohttp_session_ws-1.1.1-py3-none-any.whl", "yanked": false}, {"comment_text": "", "digests": {"md5": "92a512cbb05dd1fd4e6d3b21f99d7a33", "sha256": "9c697a816205e46fcabca85d32712d2ed6092aad84ef7d3b8ccd12588d6c49a5"}, "downloads": -1, "filename": "aiohttp_session_ws-1.1.1.tar.gz", "has_sig": false, "md5_digest": "92a512cbb05dd1fd4e6d3b21f99d7a33", "packagetype": "sdist", "python_version": "source", "requires_python": ">=3.5,<4.0", "size": 7198, "upload_time": "2018-09-20T02:23:34", "upload_time_iso_8601": "2018-09-20T02:23:34.948811Z", "url": "https://files.pythonhosted.org/packages/21/d4/070169c88a7d5b6cd621242c7c255caa59546d0ad904f3527027d3281275/aiohttp_session_ws-1.1.1.tar.gz", "yanked": false}], "timestamp": "Thu May  7 16:21:15 2020"}