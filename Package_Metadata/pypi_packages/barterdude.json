{"info": {"author": "Olx", "author_email": "", "bugtrack_url": null, "classifiers": ["License :: OSI Approved :: Apache Software License", "Programming Language :: Python :: 3", "Topic :: Software Development :: Libraries :: Application Frameworks", "Topic :: Software Development :: Libraries :: Python Modules"], "description": "# BarterDude\n[![Build Status](https://travis-ci.com/olxbr/BarterDude.svg?branch=master)](https://travis-ci.com/olxbr/BarterDude)\n[![Coverage Status](https://coveralls.io/repos/github/olxbr/BarterDude/badge.svg?branch=master)](https://coveralls.io/github/olxbr/BarterDude?branch=master)\n\nMessage exchange engine to build pipelines using brokers like RabbitMQ. This project is build on top of the great [async-worker](https://github.com/b2wdigital/async-worker).\n\n![barter](https://github.com/olxbr/BarterDude/blob/master/barterdude.jpg)\n\n## Install\n\nUsing Python 3.6+\n\n```sh\npip install barterdude\n```\n\nif you want Prometheus integration, run the command:\n\n```sh\npip install barterdude[prometheus] # or pip install barterdude[all]\n```\n\n## Usage\n\nBuild your consumer with this complete example:\n\n```python\nimport logging\nfrom barterdude import BarterDude\nfrom barterdude.monitor import Monitor\nfrom barterdude.hooks.healthcheck import Healthcheck\nfrom barterdude.hooks.logging import Logging\nfrom barterdude.hooks.metrics.prometheus import Prometheus\nfrom barterdude.message import Message\nfrom barterdude.conf import getLogger\n\n# from my_project import MyHook # (you can build your own hooks)\n\n\n# configure RabbitMQ\nbarterdude = BarterDude(\n    hostname=\"localhost\",\n    username=\"guest\",\n    password=\"guest\",\n    prefetch=256,\n)\n\n# Prometheus labels for automatic metrics\nlabels = dict(\n    app_name=\"my_app\",\n    team_name=\"my_team\"\n)\nhealthcheck = Healthcheck(barterdude) # automatic and customizable healthcheck\nprometheus = Prometheus(barterdude, labels) # automatic and customizable Prometheus integration\n\nself.logger = getLogger(\"my_app\", logging.DEBUG) # automatic json log with barterdude namespace\n# BARTERDUDE_DEFAULT_LOG_NAME is an env var to control log namespace\n# BARTERDUDE_DEFAULT_LOG_LEVEL is an env var to control loglevel by number 0, 10, 20, etc...\n\nmonitor = Monitor(\n    healthcheck,\n    prometheus,\n    # MyHook(barterdude, \"/path\"), # (will make localhost:8080/path url)\n    Logging() # automatic and customizable logging\n)\n\nmy_metric = prometheus.metrics.counter(name=\"fail\", description=\"fail again\")  # It's the same as https://github.com/prometheus/client_python\n\n\n@barterdude.consume_amqp(\n    [\"queue1\", \"queue2\"],\n    monitor,\n    coroutines = 10,  # number of coroutines spawned to consume messages (1 per message)\n    bulk_flush_interval = 60.0,  #  max waiting time for messages to start process n_coroutines\n    requeue_on_fail = True  # should retry or not the message\n)\nasync def your_consumer(msg: Message): # you receive only one message and we parallelize processing for you\n    await barterdude.publish_amqp(\n        exchange=\"my_exchange\",\n        data=msg.body\n    )\n    if msg.body == \"fail\":\n    \n        my_metric.inc() # you can use prometheus metrics\n        healthcheck.force_fail() # you can use your hooks inside consumer too\n        msg.reject(requeue=False) # You can force to reject a message, exactly equal https://b2wdigital.github.io/async-worker/src/asyncworker/asyncworker.rabbitmq.html#asyncworker.rabbitmq.message.RabbitMQMessage\n\n    if msg.body == \"exception\":\n        raise Exception() # this will reject the message and requeue\n\n    # if everything is fine, than message automatically is accepted\n\n\nbarterdude.run() # you will start consume and start a server on http://localhost:8080\n# Change host and port with ASYNCWORKER_HTTP_HOST and ASYNCWORKER_HTTP_PORT env vars\n\n```\n\n### Build your own Hook\n\n#### Base Hook (Simple One)\n\nThese hooks are called when message retreive, have success and fail.\n\n```python\nfrom barterdude.hooks import BaseHook\nfrom asyncworker.rabbitmq.message import RabbitMQMessage\n\nclass MyCounterHook(BaseHook):\n    _consume = _fail = _success = 0\n\n    async def on_success(self, message: RabbitMQMessage):\n        self._success += 1\n\n    async def on_fail(self, message: RabbitMQMessage, error: Exception):\n        self._fail += 1\n\n    async def before_consume(self, message: RabbitMQMessage):\n        self._consume += 1\n\n```\n\n#### Http Hook (Open Route)\n\nThese hooks can do everything simple hook does, but responding to a route.\n\n```python\nfrom aiohttp import web\nfrom barterdude.hooks import HttpHook\nfrom asyncworker.rabbitmq.message import RabbitMQMessage\n\nclass MyCounterHttpHook(HttpHook):\n    _consume = _fail = _success = 0\n\n    async def __call__(self, req: web.Request):\n        return web.json_response(dict(\n            consumed=self._consume,\n            success=self._success,\n            fail=self._fail\n        ))\n\n    async def on_success(self, message: RabbitMQMessage):\n        self._success += 1\n\n    async def on_fail(self, message: RabbitMQMessage, error: Exception):\n        self._fail += 1\n\n    async def before_consume(self, message: RabbitMQMessage):\n        self._consume += 1\n\n\n```\n\n### Data Sharing\n\nFollowing the approach found in [async-worker](https://b2wdigital.github.io/async-worker/userguide/asyncworker-app/storage.html) and in [aiohttp](https://docs.aiohttp.org/en/stable/web_advanced.html#data-sharing-aka-no-singletons-please),\n`BarterDude` discourages the use of global variables, aka singletons.\n\nTo share data states globally in an application, `BarterDude` behaves like a `dict`.\nAs an example, one can save a global-like variable in a  `BarterDude` instance:\n\n```python\nfrom barterdude import BarterDude\n\nbarterdude = BarterDude()\nbaterdude[\"my_variable\"] = data\n```\n\nand get it back in a consumer\n\n```python\nasync def consumer_access_storage(msg):\n    data = baterdude[\"my_variable\"]\n```\n\n### Schema Validation\n\nConsumed messages can be validated by json schema draft-04:\n\n```python\n@barterdude.consume_amqp(\n    [\"queue1\", \"queue2\"],\n    monitor,\n    validation_schema={\n            \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n            \"$id\": \"http://example.com/example.json\",\n            \"type\": \"object\",\n            \"title\": \"Message Schema\",\n            \"description\": \"The root schema comprises the entire JSON document.\",\n            \"additionalProperties\": True,\n            \"required\": [\n                \"key\"\n            ],\n            \"properties\": {\n                \"key\": {\n                    \"$id\": \"#/properties/key\",\n                    \"type\": \"string\",\n                    \"title\": \"The Key Schema\",\n                    \"description\": \"An explanation about message.\",\n                    \"default\": \"\"\n                }\n            }\n        },\n    requeue_on_validation_fail=False # invalid messages are removed without requeue\n)\n```\n\nYou can still validate messages before produce them or when you want:\n\n```python\nfrom barterdude.message import MessageValidation\n\nvalidator = MessageValidation(json_schema)\nvalidator.validate(message)\n```\n\n\n### Testing\n\nTo test async consumers we recommend `asynctest` lib\n\n```python\nfrom asynctest import TestCase\n\n\nclass TestMain(TestCase):\n    def test_should_pass(self):\n        self.assertTrue(True)\n```\n\nWe hope you enjoy! :wink:\n\n## Contribute\n\nFor development and contributing, please follow [Contributing Guide](https://github.com/olxbr/BarterDude/blob/master/CONTRIBUTING.md) and **ALWAYS** respect the [Code of Conduct](https://github.com/olxbr/BarterDude/blob/master/CODE_OF_CONDUCT.md)", "description_content_type": "text/markdown", "docs_url": null, "download_url": "https://github.com/olxbr/BarterDude/archive/master.zip", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://github.com/olxbr/BarterDude/", "keywords": "", "license": "Apache 2", "maintainer": "", "maintainer_email": "", "name": "barterdude", "package_url": "https://pypi.org/project/barterdude/", "platform": "", "project_url": "https://pypi.org/project/barterdude/", "project_urls": {"Download": "https://github.com/olxbr/BarterDude/archive/master.zip", "Homepage": "https://github.com/olxbr/BarterDude/"}, "release_url": "https://pypi.org/project/barterdude/0.1.1/", "requires_dist": null, "requires_python": "", "summary": "Message exchange engine to build pipelines using brokers like RabbitMQ", "version": "0.1.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <h1>BarterDude</h1>\n<p><a href=\"https://travis-ci.com/olxbr/BarterDude\" rel=\"nofollow\"><img alt=\"Build Status\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/5d02f4160a58f5e92d4a5ba7d388ad4c9378f4aa/68747470733a2f2f7472617669732d63692e636f6d2f6f6c7862722f426172746572447564652e7376673f6272616e63683d6d6173746572\"></a>\n<a href=\"https://coveralls.io/github/olxbr/BarterDude?branch=master\" rel=\"nofollow\"><img alt=\"Coverage Status\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/d7e0ce9a2165caaf3c4b5b8c70fd62f50f61ad5a/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f6f6c7862722f426172746572447564652f62616467652e7376673f6272616e63683d6d6173746572\"></a></p>\n<p>Message exchange engine to build pipelines using brokers like RabbitMQ. This project is build on top of the great <a href=\"https://github.com/b2wdigital/async-worker\" rel=\"nofollow\">async-worker</a>.</p>\n<p><img alt=\"barter\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/f0e6d6add4d09cbbcd3de78178df6d483e4c5bce/68747470733a2f2f6769746875622e636f6d2f6f6c7862722f426172746572447564652f626c6f622f6d61737465722f626172746572647564652e6a7067\"></p>\n<h2>Install</h2>\n<p>Using Python 3.6+</p>\n<pre>pip install barterdude\n</pre>\n<p>if you want Prometheus integration, run the command:</p>\n<pre>pip install barterdude<span class=\"o\">[</span>prometheus<span class=\"o\">]</span> <span class=\"c1\"># or pip install barterdude[all]</span>\n</pre>\n<h2>Usage</h2>\n<p>Build your consumer with this complete example:</p>\n<pre><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude</span> <span class=\"kn\">import</span> <span class=\"n\">BarterDude</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.monitor</span> <span class=\"kn\">import</span> <span class=\"n\">Monitor</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.hooks.healthcheck</span> <span class=\"kn\">import</span> <span class=\"n\">Healthcheck</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.hooks.logging</span> <span class=\"kn\">import</span> <span class=\"n\">Logging</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.hooks.metrics.prometheus</span> <span class=\"kn\">import</span> <span class=\"n\">Prometheus</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.message</span> <span class=\"kn\">import</span> <span class=\"n\">Message</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.conf</span> <span class=\"kn\">import</span> <span class=\"n\">getLogger</span>\n\n<span class=\"c1\"># from my_project import MyHook # (you can build your own hooks)</span>\n\n\n<span class=\"c1\"># configure RabbitMQ</span>\n<span class=\"n\">barterdude</span> <span class=\"o\">=</span> <span class=\"n\">BarterDude</span><span class=\"p\">(</span>\n    <span class=\"n\">hostname</span><span class=\"o\">=</span><span class=\"s2\">\"localhost\"</span><span class=\"p\">,</span>\n    <span class=\"n\">username</span><span class=\"o\">=</span><span class=\"s2\">\"guest\"</span><span class=\"p\">,</span>\n    <span class=\"n\">password</span><span class=\"o\">=</span><span class=\"s2\">\"guest\"</span><span class=\"p\">,</span>\n    <span class=\"n\">prefetch</span><span class=\"o\">=</span><span class=\"mi\">256</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"c1\"># Prometheus labels for automatic metrics</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"nb\">dict</span><span class=\"p\">(</span>\n    <span class=\"n\">app_name</span><span class=\"o\">=</span><span class=\"s2\">\"my_app\"</span><span class=\"p\">,</span>\n    <span class=\"n\">team_name</span><span class=\"o\">=</span><span class=\"s2\">\"my_team\"</span>\n<span class=\"p\">)</span>\n<span class=\"n\">healthcheck</span> <span class=\"o\">=</span> <span class=\"n\">Healthcheck</span><span class=\"p\">(</span><span class=\"n\">barterdude</span><span class=\"p\">)</span> <span class=\"c1\"># automatic and customizable healthcheck</span>\n<span class=\"n\">prometheus</span> <span class=\"o\">=</span> <span class=\"n\">Prometheus</span><span class=\"p\">(</span><span class=\"n\">barterdude</span><span class=\"p\">,</span> <span class=\"n\">labels</span><span class=\"p\">)</span> <span class=\"c1\"># automatic and customizable Prometheus integration</span>\n\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"s2\">\"my_app\"</span><span class=\"p\">,</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">DEBUG</span><span class=\"p\">)</span> <span class=\"c1\"># automatic json log with barterdude namespace</span>\n<span class=\"c1\"># BARTERDUDE_DEFAULT_LOG_NAME is an env var to control log namespace</span>\n<span class=\"c1\"># BARTERDUDE_DEFAULT_LOG_LEVEL is an env var to control loglevel by number 0, 10, 20, etc...</span>\n\n<span class=\"n\">monitor</span> <span class=\"o\">=</span> <span class=\"n\">Monitor</span><span class=\"p\">(</span>\n    <span class=\"n\">healthcheck</span><span class=\"p\">,</span>\n    <span class=\"n\">prometheus</span><span class=\"p\">,</span>\n    <span class=\"c1\"># MyHook(barterdude, \"/path\"), # (will make localhost:8080/path url)</span>\n    <span class=\"n\">Logging</span><span class=\"p\">()</span> <span class=\"c1\"># automatic and customizable logging</span>\n<span class=\"p\">)</span>\n\n<span class=\"n\">my_metric</span> <span class=\"o\">=</span> <span class=\"n\">prometheus</span><span class=\"o\">.</span><span class=\"n\">metrics</span><span class=\"o\">.</span><span class=\"n\">counter</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">\"fail\"</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">\"fail again\"</span><span class=\"p\">)</span>  <span class=\"c1\"># It's the same as https://github.com/prometheus/client_python</span>\n\n\n<span class=\"nd\">@barterdude</span><span class=\"o\">.</span><span class=\"n\">consume_amqp</span><span class=\"p\">(</span>\n    <span class=\"p\">[</span><span class=\"s2\">\"queue1\"</span><span class=\"p\">,</span> <span class=\"s2\">\"queue2\"</span><span class=\"p\">],</span>\n    <span class=\"n\">monitor</span><span class=\"p\">,</span>\n    <span class=\"n\">coroutines</span> <span class=\"o\">=</span> <span class=\"mi\">10</span><span class=\"p\">,</span>  <span class=\"c1\"># number of coroutines spawned to consume messages (1 per message)</span>\n    <span class=\"n\">bulk_flush_interval</span> <span class=\"o\">=</span> <span class=\"mf\">60.0</span><span class=\"p\">,</span>  <span class=\"c1\">#  max waiting time for messages to start process n_coroutines</span>\n    <span class=\"n\">requeue_on_fail</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>  <span class=\"c1\"># should retry or not the message</span>\n<span class=\"p\">)</span>\n<span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">your_consumer</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">:</span> <span class=\"n\">Message</span><span class=\"p\">):</span> <span class=\"c1\"># you receive only one message and we parallelize processing for you</span>\n    <span class=\"k\">await</span> <span class=\"n\">barterdude</span><span class=\"o\">.</span><span class=\"n\">publish_amqp</span><span class=\"p\">(</span>\n        <span class=\"n\">exchange</span><span class=\"o\">=</span><span class=\"s2\">\"my_exchange\"</span><span class=\"p\">,</span>\n        <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">body</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">body</span> <span class=\"o\">==</span> <span class=\"s2\">\"fail\"</span><span class=\"p\">:</span>\n    \n        <span class=\"n\">my_metric</span><span class=\"o\">.</span><span class=\"n\">inc</span><span class=\"p\">()</span> <span class=\"c1\"># you can use prometheus metrics</span>\n        <span class=\"n\">healthcheck</span><span class=\"o\">.</span><span class=\"n\">force_fail</span><span class=\"p\">()</span> <span class=\"c1\"># you can use your hooks inside consumer too</span>\n        <span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">reject</span><span class=\"p\">(</span><span class=\"n\">requeue</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"c1\"># You can force to reject a message, exactly equal https://b2wdigital.github.io/async-worker/src/asyncworker/asyncworker.rabbitmq.html#asyncworker.rabbitmq.message.RabbitMQMessage</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">body</span> <span class=\"o\">==</span> <span class=\"s2\">\"exception\"</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">Exception</span><span class=\"p\">()</span> <span class=\"c1\"># this will reject the message and requeue</span>\n\n    <span class=\"c1\"># if everything is fine, than message automatically is accepted</span>\n\n\n<span class=\"n\">barterdude</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">()</span> <span class=\"c1\"># you will start consume and start a server on http://localhost:8080</span>\n<span class=\"c1\"># Change host and port with ASYNCWORKER_HTTP_HOST and ASYNCWORKER_HTTP_PORT env vars</span>\n</pre>\n<h3>Build your own Hook</h3>\n<h4>Base Hook (Simple One)</h4>\n<p>These hooks are called when message retreive, have success and fail.</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">barterdude.hooks</span> <span class=\"kn\">import</span> <span class=\"n\">BaseHook</span>\n<span class=\"kn\">from</span> <span class=\"nn\">asyncworker.rabbitmq.message</span> <span class=\"kn\">import</span> <span class=\"n\">RabbitMQMessage</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">MyCounterHook</span><span class=\"p\">(</span><span class=\"n\">BaseHook</span><span class=\"p\">):</span>\n    <span class=\"n\">_consume</span> <span class=\"o\">=</span> <span class=\"n\">_fail</span> <span class=\"o\">=</span> <span class=\"n\">_success</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">on_success</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_success</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">on_fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"p\">:</span> <span class=\"ne\">Exception</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fail</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">before_consume</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_consume</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n</pre>\n<h4>Http Hook (Open Route)</h4>\n<p>These hooks can do everything simple hook does, but responding to a route.</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">aiohttp</span> <span class=\"kn\">import</span> <span class=\"n\">web</span>\n<span class=\"kn\">from</span> <span class=\"nn\">barterdude.hooks</span> <span class=\"kn\">import</span> <span class=\"n\">HttpHook</span>\n<span class=\"kn\">from</span> <span class=\"nn\">asyncworker.rabbitmq.message</span> <span class=\"kn\">import</span> <span class=\"n\">RabbitMQMessage</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">MyCounterHttpHook</span><span class=\"p\">(</span><span class=\"n\">HttpHook</span><span class=\"p\">):</span>\n    <span class=\"n\">_consume</span> <span class=\"o\">=</span> <span class=\"n\">_fail</span> <span class=\"o\">=</span> <span class=\"n\">_success</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">req</span><span class=\"p\">:</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">Request</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">web</span><span class=\"o\">.</span><span class=\"n\">json_response</span><span class=\"p\">(</span><span class=\"nb\">dict</span><span class=\"p\">(</span>\n            <span class=\"n\">consumed</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_consume</span><span class=\"p\">,</span>\n            <span class=\"n\">success</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_success</span><span class=\"p\">,</span>\n            <span class=\"n\">fail</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fail</span>\n        <span class=\"p\">))</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">on_success</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_success</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">on_fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"p\">:</span> <span class=\"ne\">Exception</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fail</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">before_consume</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"n\">RabbitMQMessage</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_consume</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n</pre>\n<h3>Data Sharing</h3>\n<p>Following the approach found in <a href=\"https://b2wdigital.github.io/async-worker/userguide/asyncworker-app/storage.html\" rel=\"nofollow\">async-worker</a> and in <a href=\"https://docs.aiohttp.org/en/stable/web_advanced.html#data-sharing-aka-no-singletons-please\" rel=\"nofollow\">aiohttp</a>,\n<code>BarterDude</code> discourages the use of global variables, aka singletons.</p>\n<p>To share data states globally in an application, <code>BarterDude</code> behaves like a <code>dict</code>.\nAs an example, one can save a global-like variable in a  <code>BarterDude</code> instance:</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">barterdude</span> <span class=\"kn\">import</span> <span class=\"n\">BarterDude</span>\n\n<span class=\"n\">barterdude</span> <span class=\"o\">=</span> <span class=\"n\">BarterDude</span><span class=\"p\">()</span>\n<span class=\"n\">baterdude</span><span class=\"p\">[</span><span class=\"s2\">\"my_variable\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span>\n</pre>\n<p>and get it back in a consumer</p>\n<pre><span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">consumer_access_storage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">):</span>\n    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">baterdude</span><span class=\"p\">[</span><span class=\"s2\">\"my_variable\"</span><span class=\"p\">]</span>\n</pre>\n<h3>Schema Validation</h3>\n<p>Consumed messages can be validated by json schema draft-04:</p>\n<pre><span class=\"nd\">@barterdude</span><span class=\"o\">.</span><span class=\"n\">consume_amqp</span><span class=\"p\">(</span>\n    <span class=\"p\">[</span><span class=\"s2\">\"queue1\"</span><span class=\"p\">,</span> <span class=\"s2\">\"queue2\"</span><span class=\"p\">],</span>\n    <span class=\"n\">monitor</span><span class=\"p\">,</span>\n    <span class=\"n\">validation_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n            <span class=\"s2\">\"$schema\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://json-schema.org/draft-04/schema#\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"$id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"http://example.com/example.json\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"object\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"title\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Message Schema\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"description\"</span><span class=\"p\">:</span> <span class=\"s2\">\"The root schema comprises the entire JSON document.\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"additionalProperties\"</span><span class=\"p\">:</span> <span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"required\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"s2\">\"key\"</span>\n            <span class=\"p\">],</span>\n            <span class=\"s2\">\"properties\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                <span class=\"s2\">\"key\"</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">\"$id\"</span><span class=\"p\">:</span> <span class=\"s2\">\"#/properties/key\"</span><span class=\"p\">,</span>\n                    <span class=\"s2\">\"type\"</span><span class=\"p\">:</span> <span class=\"s2\">\"string\"</span><span class=\"p\">,</span>\n                    <span class=\"s2\">\"title\"</span><span class=\"p\">:</span> <span class=\"s2\">\"The Key Schema\"</span><span class=\"p\">,</span>\n                    <span class=\"s2\">\"description\"</span><span class=\"p\">:</span> <span class=\"s2\">\"An explanation about message.\"</span><span class=\"p\">,</span>\n                    <span class=\"s2\">\"default\"</span><span class=\"p\">:</span> <span class=\"s2\">\"\"</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">},</span>\n    <span class=\"n\">requeue_on_validation_fail</span><span class=\"o\">=</span><span class=\"kc\">False</span> <span class=\"c1\"># invalid messages are removed without requeue</span>\n<span class=\"p\">)</span>\n</pre>\n<p>You can still validate messages before produce them or when you want:</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">barterdude.message</span> <span class=\"kn\">import</span> <span class=\"n\">MessageValidation</span>\n\n<span class=\"n\">validator</span> <span class=\"o\">=</span> <span class=\"n\">MessageValidation</span><span class=\"p\">(</span><span class=\"n\">json_schema</span><span class=\"p\">)</span>\n<span class=\"n\">validator</span><span class=\"o\">.</span><span class=\"n\">validate</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</pre>\n<h3>Testing</h3>\n<p>To test async consumers we recommend <code>asynctest</code> lib</p>\n<pre><span class=\"kn\">from</span> <span class=\"nn\">asynctest</span> <span class=\"kn\">import</span> <span class=\"n\">TestCase</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">TestMain</span><span class=\"p\">(</span><span class=\"n\">TestCase</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">test_should_pass</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertTrue</span><span class=\"p\">(</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</pre>\n<p>We hope you enjoy! :wink:</p>\n<h2>Contribute</h2>\n<p>For development and contributing, please follow <a href=\"https://github.com/olxbr/BarterDude/blob/master/CONTRIBUTING.md\" rel=\"nofollow\">Contributing Guide</a> and <strong>ALWAYS</strong> respect the <a href=\"https://github.com/olxbr/BarterDude/blob/master/CODE_OF_CONDUCT.md\" rel=\"nofollow\">Code of Conduct</a></p>\n\n          </div>"}, "last_serial": 7141123, "releases": {"0.0.10": [{"comment_text": "", "digests": {"md5": "6aa83331cc7a7e8ebd2fd644cdc1c2e3", "sha256": "2e0d99bec7558c87625d1dfe0d2aea8e99c3a29c9b7dde97b9241423ebb9a643"}, "downloads": -1, "filename": "barterdude-0.0.10.tar.gz", "has_sig": false, "md5_digest": "6aa83331cc7a7e8ebd2fd644cdc1c2e3", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 14444, "upload_time": "2020-02-17T21:54:14", "upload_time_iso_8601": "2020-02-17T21:54:14.049368Z", "url": "https://files.pythonhosted.org/packages/e7/6a/1a9047d737d6da100ba118e5fe936e35c00f8a4ee3896e80002848399aec/barterdude-0.0.10.tar.gz", "yanked": false}], "0.0.11": [{"comment_text": "", "digests": {"md5": "c6bb45b9c57c24bf0befb5721292fdfe", "sha256": "4dd9fb006d0dec28818202adf41efc0d3302b3e862990b54a9a382faa6e430fb"}, "downloads": -1, "filename": "barterdude-0.0.11.tar.gz", "has_sig": false, "md5_digest": "c6bb45b9c57c24bf0befb5721292fdfe", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 14365, "upload_time": "2020-02-20T17:47:46", "upload_time_iso_8601": "2020-02-20T17:47:46.233477Z", "url": "https://files.pythonhosted.org/packages/c0/e5/117cbfa2cffe0541b525e08142a01638493a00e70e06eea89f5ef5b1a4e8/barterdude-0.0.11.tar.gz", "yanked": false}], "0.0.12": [{"comment_text": "", "digests": {"md5": "c273643caa078d2d95e787330afef9d5", "sha256": "363ff0762f2036ec1b2cfa21da8de89a4e22d1f692b66ea268b941f11a7c29c6"}, "downloads": -1, "filename": "barterdude-0.0.12.tar.gz", "has_sig": false, "md5_digest": "c273643caa078d2d95e787330afef9d5", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 14825, "upload_time": "2020-02-27T20:57:42", "upload_time_iso_8601": "2020-02-27T20:57:42.480606Z", "url": "https://files.pythonhosted.org/packages/c8/44/4e953cac182e4f1d50199270f0c7182fd0ce1b5c825e0ddf98d1abb67700/barterdude-0.0.12.tar.gz", "yanked": false}], "0.0.13": [{"comment_text": "", "digests": {"md5": "719eb78d3aece043e1d85d57b01f48ac", "sha256": "ade528cea953af8a1efa0d8999de5e4c48607c647659c62038e4b056e1f903c6"}, "downloads": -1, "filename": "barterdude-0.0.13.tar.gz", "has_sig": false, "md5_digest": "719eb78d3aece043e1d85d57b01f48ac", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 15486, "upload_time": "2020-03-02T14:54:32", "upload_time_iso_8601": "2020-03-02T14:54:32.829904Z", "url": "https://files.pythonhosted.org/packages/a6/db/99c3e088d94c42686cd704b7560e480fd0cbae6b5edde4f40a346b64b0dc/barterdude-0.0.13.tar.gz", "yanked": false}], "0.0.14": [{"comment_text": "", "digests": {"md5": "6a8d510081ff7261fe4d223d28b2ea7f", "sha256": "f42b6a04666450d5f8efcc997de907d2d82c68fe48e15d7afe62d0c8b227d1fb"}, "downloads": -1, "filename": "barterdude-0.0.14.tar.gz", "has_sig": false, "md5_digest": "6a8d510081ff7261fe4d223d28b2ea7f", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 17036, "upload_time": "2020-03-20T19:16:14", "upload_time_iso_8601": "2020-03-20T19:16:14.933500Z", "url": "https://files.pythonhosted.org/packages/e2/c2/f1396ceeeccd7a85977c024ba6ebf365de4b8db152ee3bfefe9840045e50/barterdude-0.0.14.tar.gz", "yanked": false}], "0.0.15": [{"comment_text": "", "digests": {"md5": "411f455957351aeaea76576bc147507d", "sha256": "1948ef77fc0b0f1881651ac1788110dcccd63f8fb340f5f2fba09bc5586773e3"}, "downloads": -1, "filename": "barterdude-0.0.15.tar.gz", "has_sig": false, "md5_digest": "411f455957351aeaea76576bc147507d", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 17580, "upload_time": "2020-04-29T16:16:01", "upload_time_iso_8601": "2020-04-29T16:16:01.850363Z", "url": "https://files.pythonhosted.org/packages/e4/c7/493d5aebaed86cc782ce980b10900b1f8642fb61ee9ebc6e0a39f240e4db/barterdude-0.0.15.tar.gz", "yanked": false}], "0.0.2": [{"comment_text": "", "digests": {"md5": "d174d546872238e9131ffbe458621856", "sha256": "bdd8a06c1e0e41230f0daab8051a836ee02be565ca19bccd2903815cf765ff6b"}, "downloads": -1, "filename": "barterdude-0.0.2.tar.gz", "has_sig": false, "md5_digest": "d174d546872238e9131ffbe458621856", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 3687, "upload_time": "2020-02-12T21:29:44", "upload_time_iso_8601": "2020-02-12T21:29:44.415193Z", "url": "https://files.pythonhosted.org/packages/10/9a/fe5673d5fbe8c4f5ca2ee251d04af008b3b288983263197bbd2d95c61788/barterdude-0.0.2.tar.gz", "yanked": false}], "0.0.3": [{"comment_text": "", "digests": {"md5": "3a78eb9cbf1ba0c2177b10687fbdf6e4", "sha256": "06ea5b842cd283675fd1faa4aa8ed72726060b600a84ad49e8895ae5639817c6"}, "downloads": -1, "filename": "barterdude-0.0.3.tar.gz", "has_sig": false, "md5_digest": "3a78eb9cbf1ba0c2177b10687fbdf6e4", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 3909, "upload_time": "2020-02-12T21:38:24", "upload_time_iso_8601": "2020-02-12T21:38:24.093228Z", "url": "https://files.pythonhosted.org/packages/31/26/c8a28077cc15250467faf80ed426dce1f82b640d6fecae59730e2b7d182e/barterdude-0.0.3.tar.gz", "yanked": false}], "0.0.4": [{"comment_text": "", "digests": {"md5": "e9f83228b709003ddbe7de4e6834835b", "sha256": "747974a16653d1c30ee41fbc8ef1fe8ff71274f2107b2235caa6e5eabb98bfc8"}, "downloads": -1, "filename": "barterdude-0.0.4.tar.gz", "has_sig": false, "md5_digest": "e9f83228b709003ddbe7de4e6834835b", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 11761, "upload_time": "2020-02-12T21:48:42", "upload_time_iso_8601": "2020-02-12T21:48:42.039168Z", "url": "https://files.pythonhosted.org/packages/47/9e/2e71979384bb6d1c6e276a72c9e43db737e27bcf083b7702f05ad505927d/barterdude-0.0.4.tar.gz", "yanked": false}], "0.0.5": [{"comment_text": "", "digests": {"md5": "d5d4cdf0e000eeb74e3fff47ccfcfb9c", "sha256": "5e98d64e7f14595e930da959f660194c98ac0cfbd4aa266da754a1a917d9ceeb"}, "downloads": -1, "filename": "barterdude-0.0.5.tar.gz", "has_sig": false, "md5_digest": "d5d4cdf0e000eeb74e3fff47ccfcfb9c", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 11882, "upload_time": "2020-02-12T22:02:12", "upload_time_iso_8601": "2020-02-12T22:02:12.843599Z", "url": "https://files.pythonhosted.org/packages/29/ec/c99d6f8a03f68879b6d90643e13a38f15c2ffeed01758cf20924627d632f/barterdude-0.0.5.tar.gz", "yanked": false}], "0.0.6": [{"comment_text": "", "digests": {"md5": "7a5299cdb2a41e708b13864e274d3274", "sha256": "bd8d9dcd226d9fa0c53f600b1cd337f3b008304ad0b3a0a44978f2b54ae24500"}, "downloads": -1, "filename": "barterdude-0.0.6.tar.gz", "has_sig": false, "md5_digest": "7a5299cdb2a41e708b13864e274d3274", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 11905, "upload_time": "2020-02-12T23:04:18", "upload_time_iso_8601": "2020-02-12T23:04:18.258947Z", "url": "https://files.pythonhosted.org/packages/5f/eb/3b2413445a66edd1841b9546484967b342f0cac50a771db1eb80d3bbbd14/barterdude-0.0.6.tar.gz", "yanked": false}], "0.0.7": [{"comment_text": "", "digests": {"md5": "2204e3897697ed4bc09d3d6396239c74", "sha256": "6915e21d4b376d3a15bca790a3528601b05ade29ad02d0eb0abf4e752af09d36"}, "downloads": -1, "filename": "barterdude-0.0.7.tar.gz", "has_sig": false, "md5_digest": "2204e3897697ed4bc09d3d6396239c74", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 11901, "upload_time": "2020-02-12T23:06:43", "upload_time_iso_8601": "2020-02-12T23:06:43.986802Z", "url": "https://files.pythonhosted.org/packages/e6/77/b3100248b5f81d0109b44a02ba70a829afff45aaaff09b8fd007d0682277/barterdude-0.0.7.tar.gz", "yanked": false}], "0.0.8": [{"comment_text": "", "digests": {"md5": "3e12315c74b829f685377e3eb097012e", "sha256": "695885bfb545cfd2ae4460373f2e105ff8c90d15f525df6b5e6cd6ddc3db09f8"}, "downloads": -1, "filename": "barterdude-0.0.8.tar.gz", "has_sig": false, "md5_digest": "3e12315c74b829f685377e3eb097012e", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 11937, "upload_time": "2020-02-12T23:15:49", "upload_time_iso_8601": "2020-02-12T23:15:49.132314Z", "url": "https://files.pythonhosted.org/packages/84/2b/e4a78c626a96ae73a205100518abd4c723c5050e4d9370fafa2685004321/barterdude-0.0.8.tar.gz", "yanked": false}], "0.0.9": [{"comment_text": "", "digests": {"md5": "4236907d3d7da203688ed1e4e117e3da", "sha256": "5c92fdf66c73ba5d42e658abe631cb765b32f46f615170c8341dab45ab97ff93"}, "downloads": -1, "filename": "barterdude-0.0.9.tar.gz", "has_sig": false, "md5_digest": "4236907d3d7da203688ed1e4e117e3da", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 14358, "upload_time": "2020-02-14T20:14:35", "upload_time_iso_8601": "2020-02-14T20:14:35.157022Z", "url": "https://files.pythonhosted.org/packages/f3/b5/d99a2ab1e8b46ff245c01d9a1a169fb2727030a0d12eb7dbf2b6c51937dc/barterdude-0.0.9.tar.gz", "yanked": false}], "0.1.0": [{"comment_text": "", "digests": {"md5": "272b12ec615bf3f439bb2aecf8ca7d51", "sha256": "a9b3f0e3a368751d8c277d15801fa6804cffb22d9a1201ee34d880fe8eeb88c4"}, "downloads": -1, "filename": "barterdude-0.1.0.tar.gz", "has_sig": false, "md5_digest": "272b12ec615bf3f439bb2aecf8ca7d51", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 24202, "upload_time": "2020-04-30T20:55:07", "upload_time_iso_8601": "2020-04-30T20:55:07.734967Z", "url": "https://files.pythonhosted.org/packages/79/29/b0bf9846967c1da0e90664fcd8e6d531498090f8ae38ecc375cbd25ce8ea/barterdude-0.1.0.tar.gz", "yanked": false}], "0.1.1": [{"comment_text": "", "digests": {"md5": "b3e06b30496308bf28bfbc9a9891fef7", "sha256": "840d231706614cf82ad2a7874fbd87f3e054de7743fe201e870362053da38707"}, "downloads": -1, "filename": "barterdude-0.1.1.tar.gz", "has_sig": false, "md5_digest": "b3e06b30496308bf28bfbc9a9891fef7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 24536, "upload_time": "2020-04-30T21:52:17", "upload_time_iso_8601": "2020-04-30T21:52:17.550074Z", "url": "https://files.pythonhosted.org/packages/09/15/9d69d6969dbb6835f90669e09d3b0d656d86b5ebacbc58892764172f3273/barterdude-0.1.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "b3e06b30496308bf28bfbc9a9891fef7", "sha256": "840d231706614cf82ad2a7874fbd87f3e054de7743fe201e870362053da38707"}, "downloads": -1, "filename": "barterdude-0.1.1.tar.gz", "has_sig": false, "md5_digest": "b3e06b30496308bf28bfbc9a9891fef7", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 24536, "upload_time": "2020-04-30T21:52:17", "upload_time_iso_8601": "2020-04-30T21:52:17.550074Z", "url": "https://files.pythonhosted.org/packages/09/15/9d69d6969dbb6835f90669e09d3b0d656d86b5ebacbc58892764172f3273/barterdude-0.1.1.tar.gz", "yanked": false}], "timestamp": "Thu May  7 18:14:51 2020"}