{"info": {"author": "Pavlos Parissis", "author_email": "pavlos.parissis@gmail.com", "bugtrack_url": null, "classifiers": ["Development Status :: 5 - Production/Stable", "Environment :: Console", "Intended Audience :: Information Technology", "Intended Audience :: System Administrators", "Natural Language :: English", "Operating System :: POSIX", "Programming Language :: Python :: 3.4", "Topic :: Utilities"], "description": ".. README.rst\n\n============\nhaproxystats\n============\n\n    *A HAProxy statistics collection program*\n\n.. contents::\n\nIntroduction\n------------\n\n**haproxystats** is a statistics collector for `HAProxy`_ load balancer which\nprocesses various statistics and pushes them to graphing systems (Graphite).\nIt is designed to satisfy the following requirements:\n\n#. Fast and configurable processing of HAProxy statistics\n#. Perform aggregation when HAProxy runs in multiprocess (nbproc > 1)\n#. Pull statistics at very low intervals (10secs)\n#. Flexible dispatching of statistics to different systems (Graphite,  kafka)\n\nThe main design characteristic is the split between pulling the statistics and\nprocessing them. This provides the ability to pull data as frequently\nas possible without worrying about the impact on processing time. It also\nreduces the risk of losing data in case of trouble during the processing phase.\n\nIt runs locally on each load balancer node, offering a decentralized setup for\nthe processing phase, but it can be easily extended in the future to have a\ncentralized setup for the processing phase. In that centralized setup it will\nbe possible to perform aggregation on a cluster level as well.\nUntil then users can deploy `carbon-c-relay`_ for aggregation.\n\nBecause of this design haproxystats comes with two programs:\n**haproxystats-pull** and **haproxystats-process**. The former pulls\nstatistics from HAProxy via `stats socket`_ and it uses the `asyncio`_ framework\nfrom Python to achieve high concurrency and low footprint. The latter\nprocesses the statistics and pushes them to various destinations. It utilizes\n`Pandas`_ for data analysis and the multiprocess framework from Python.\n\nhaproxystats requires Python 3.4, docopt and Pandas to be available in the\nsystem.\n\nHow haproxystats works\n----------------------\n\n\n.. image:: haproxystats-architecture.png\n\n\nhaproxystats-pull sends `info`_ and `stat`_ commands to all haproxy processes\nin order to collect statistics for the daemon and for all\nfrontends/backends/servers. Data returned from each process and for each\ncommand is stored in individual files which are saved under one directory. The\ntime (seconds since the epoch) of retrieval is used to name that directory.\nhaproxystats-process watches for changes on the parent directory and when a\ndirectory is created it adds its full path to the queue. Multiple workers pick\nup items (directories) from the queue and process statistics from those\ndirectories.\n\nhaproxystats-pull\n#################\n\nhaproxystats-pull leverages the `asyncio`_ framework from Python by utilizing\ncoroutines to multiplex I/O access over several `stats socket`_, which are\nsimple UNIX and TCP sockets.\n\nThe actual task of storing the data to the file system is off-loaded to a very\nlight `pool of threads`_ in order to avoid blocking the coroutines during the\ndisk IO phase.\n\nhaproxystats-pull manages the *incoming* directory and makes sure directories\nare created with correct names. It also suspends the collection when the number\nof directories under the *incoming* directory exceeds a threshold. This avoids\nfilling up the disk when haproxystats-process is unavailable for sometime.\nThis an example of directory structure:\n\n.. code-block:: bash\n\n    incoming\n    \u251c\u2500\u2500 1457298067\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin1.sock_info\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin1.sock_stat\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin2.sock_info\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin2.sock_stat\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin3.sock_info\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin3.sock_stat\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 admin4.sock_info\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 admin4.sock_stat\n    \u2514\u2500\u2500 1457298072\n        \u251c\u2500\u2500 admin1.sock_info\n        \u251c\u2500\u2500 admin1.sock_stat\n        \u251c\u2500\u2500 admin2.sock_info\n        \u251c\u2500\u2500 admin2.sock_stat\n        \u251c\u2500\u2500 admin3.sock_info\n        \u251c\u2500\u2500 admin3.sock_stat\n        \u251c\u2500\u2500 admin4.sock_info\n        \u2514\u2500\u2500 admin4.sock_stat\n\nhaproxystats-process\n####################\n\nhaproxystats-process is a multiprocess program. The parent process uses the\nLinux kernel's `inotify`_ API to watch for changes in *incoming* directory.\n\nIt receives an event when a directory is either created or moved in *incoming*\ndirectory. The event contains the absolute path name of that directory. It\nmaintains an internal queue in which it puts directory names. Multiple child\nprocesses pick directory names from the queue and process the data.\n\nIts worker dispatches statistics to various destinations. The directories are\nremoved from *incoming* directory when all statistics are successfully\nprocessed.\n\nWhen haproxystats-process starts it scans the *incoming* directory\nfor new directories and processes them instantly, so you don't lose statistics\nif haproxystats-process is unavailable for sometime.\n\nDispatchers\n###########\n\nhaproxystats-process currently supports 2 different dispatchers.\n\n1. **Graphite**\n\nPushes statistics to a Graphite system via a local or remote carbon-relay.\nThe recommended method is to use `carbon-c-relay`_. It is very fast and capable\nof handling millions of metrics per second. This dispatcher utilizes an internal\nqueue to store metrics which are failed to be sent to Graphite.\n\nAn example of graphite namespace::\n\n    <loadbalancers>.<lb-01>.haproxy.frontend.<frontendname>.\n    <loadbalancers>.<lb-01>.haproxy.backend.<backendname>.\n    <loadbalancers>.<lb-01>.haproxy.backend.<backendname>.server.<servername>\n    <loadbalancers>.<lb-01>.haproxy.server.<servername>.\n    <loadbalancers>.<lb-01>.haproxy.daemon.\n    <loadbalancers>.<lb-01>.haproxy.haproxystats.<metric names>.\n\n2. **local-store**\n\nStores statistics in the local disk. Use it only for debugging purposes.\n\nStatistics for HAProxy\n######################\n\nIn addition the statistics that are exposed by HAProxy, haproxystats provides\nthe following statistics.\n\nHAProxy process\n~~~~~~~~~~~~~~~\n\nHAProxy exposes Idle_pct and haproxystats-process converts it to CPU\nutilization without removing Idle_pct metric. This avoids the usage of\nscale(-1) and offset(100) functions on graphite::\n\n    CpuUsagePct  CPU utilization in percentage\n\nThe following metrics are calculated only when HAProxy is configured with more\nthan 1 processes (nbproc > 1)::\n\n    25PercentileCpuUsagePct 25th percentile of CpuUsagePct across all processes\n    50PercentileCpuUsagePct 50th percentile              -//-\n    75PercentileCpuUsagePct 75th percentile              -//-\n    95PercentileCpuUsagePct 95th percentile              -//-\n    99PercentileCpuUsagePct 99th percentile              -//-\n    StdCpuUsagePct          standard deviation           -//-\n\nQueuing system\n##############\n\nThe *incoming* directory together with the inotify API provides a simple\nqueueing system which is used as a communication channel between\nhaproxystats-pull and haproxystats-process programs.\n\nThere isn't any feedback mechanism in place, thus haproxystats-pull monitors\nthe number of directories before it pulls data from HAProxy and suspends its\njob when the number of directories exceeds a threshold.\n\nSee **queue-size** parameter of **pull** section.\n\nStatistics for haproxystats\n###########################\n\n**haproxystats** provides statistics for the time it takes to process,\ncalculate and send HAProxy metrics. By default provides the following list\nof metric names with values in seconds::\n\n    loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeHAProxy\n    loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeFrontends\n    loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeBackends\n    loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeServers\n    loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeAllStats\n\nIt also provides the number of metrics which are send to graphite::\n\n    loadbalancers.lb-01.haproxy.haproxystats.MetricsHAProxy\n    loadbalancers.lb-01.haproxy.haproxystats.MetricsFrontend\n    loadbalancers.lb-01.haproxy.haproxystats.MetricsBackend\n    loadbalancers.lb-01.haproxy.haproxystats.MetricsServer\n\nConfiguration\n-------------\n\nhaproxystats uses the popular `INI`_ format for its configuration file.\nThis is an example configuration file (/etc/haproxystats.conf)::\n\n\n    [DEFAULT]\n    loglevel = info\n    retries  = 2\n    timeout  = 1\n    interval = 2\n\n    [paths]\n    base-dir = /var/lib/haproxystats\n\n    [pull]\n    loglevel        = info\n    socket-dir      = /run/haproxy\n    retries         = 1\n    timeout         = 0.1\n    interval        = 0.5\n    pull-timeout    = 2\n    pull-interval   = 10\n    dst-dir         = ${paths:base-dir}/incoming\n    tmp-dst-dir     = ${paths:base-dir}/incoming.tmp\n    workers         = 8\n    queue-size      = 360\n\n    [process]\n    src-dir             = ${paths:base-dir}/incoming\n    workers             = 4\n    per-process-metrics = false\n\n    [graphite]\n    server          = 127.0.0.1\n    port            = 3002\n    retries         = 3\n    interval        = 1.8\n    connect-timeout = 1.0\n    write-timeout   = 1.0\n    delay           = 10\n    backoff         = 2\n    namespace       = loadbalancers\n    prefix-hostname = true\n    fqdn            = true\n    queue-size      = 1000000\n\n    #[local-store]\n    #dir = ${paths:base-dir}/local-store\n\nAll the above settings are optional as haproxystats comes with default values\nfor all of them. Thus, both programs can be started without supplying any\nconfiguration.\n\nDEFAULT section\n###############\n\nSettings in this section can be overwritten in other sections.\n\n* **loglevel** Defaults to **info**\n\nLog level to use, possible values are: debug, info, warning, error, critical\n\n* **retries** Defaults to **2**\n\nNumber of times to retry a connection after a failure. Used by haproxystats-pull\nand haproxystats-process when they open a connection to a UNIX/TCP socket and\nGraphite respectively.\n\n* **timeout** Defaults to **1** (seconds)\n\nTime to wait for establishing a connection. Used by haproxystats-pull and\nhaproxystats-process when they open a connection to a UNIX/TCP socket and Graphite\nrespectively.\n\n* **interval** Defaults to **2**\n\nTime to wait before trying to open a connection. Used by haproxystats-pull and\nhaproxystats-process when they retry a connection to a UNIX/TCP socket and Graphite\nrespectively.\n\npaths section\n#############\n\n* **base-dir** Defaults to **/var/lib/haproxystats**\n\nThe directory to use as the base of the directory structure.\n\npull section\n############\n\n* **socket-dir** Unset by default\n\nA directory with HAProxy socket files.\n\n* **servers** Unset by default\n\nA list of servers to pull statistics from. You define a server by passing a URL,\nhere some examples::\n\n    tcp://127.0.0.1:5555\n    tcp://foo.bar.com:4444\n    tcp://[fe80::3f2f:46b3:ef0c:a420]:4444\n    unix:///run/haproxy.sock\n\nOnly TCP and UNIX schemes are supported and the port for TCP servers **must**\nbe set. For UNIX scheme you can only pass a file and not a directory, but\n**socket-dir** option can be set as well, so you can use a directory and UNIX\nsocket files at the same time. You can use comma as separator to pass multiple\nservers::\n\n    servers = unix:///run/haproxy.sock,tcp://127.0.0.1:555,tcp://127.0.0.1:556\n\n* **buffer-limit** Defaults to **6291456** (bytes)\n\nAt most size bytes are read and returned from the sockets. Setting too low and\nit will slow down the retrieval of statistics.\nOnly values greater than or equal to 1 are accepted.\n\n* **retries** Defaults to **1**\n\nNumber of times to reconnect to UNIX/TCP socket after a failure.\n\n* **timeout** Defaults to **0.1** (seconds)\n\nTime to wait for establishing a connection to UNIX/TCP socket. There is no need to\nset it higher than few ms as haproxy accepts a connection within 1-2ms.\n\n* **interval** Defaults to **0.5** (seconds)\n\nTime to wait before trying to reconnect to UNIX/TCP socket after a failure. Tune it\nbased on the duration of the reload process of haproxy. haproxy reloads within\nfew ms but in some environments with hundreds different SSL certificates it can\ntake a bit more.\n\n* **pull-interval** Defaults to **10** (seconds)\n\nHow often to pull statistics from HAProxy. A value of *1* second can overload\nthe haproxy processes in environments with thousands backends/servers.\n\n* **pull-timeout** Defaults to **2** (seconds)\n\nTotal time to wait for the pull process to finish. Should be always less than\n**pull-interval**.\n\n* **dst-dir** Defaults **/var/lib/haproxystats/incoming**\n\nA directory to store statistics retrieved by HAProxy.\n\n* **tmp-dst-dir** Defaults **/var/lib/haproxystats/incoming.tmp**\n\nA directory to use as temporary storage location before directories are moved\nto **dst-dir**.  haproxystats-pull stores statistics for each process under\nthat directory and only when data from all haproxy processes are successfully\nretrieved they are moved to **dst-dir**. Make sure **dst-dir** and\n**tmp-dst-dir** are on the same file system, so the move of the directories\nbecome a rename which is a quick and atomic operation.\n\n* **workers**  Defaults to **8**\n\nNumber of threads to use for writing statistics to disk. These are very\nlight threads and don't consume a lot of resources. Shouldn't be set higher\nthan the number of haproxy processes.\n\n* **queue-size** Defaults to **360**\n\nSuspend the pulling of statistics when the number of directories in **dst-dir**\nexceeds this limit.\n\nprocess section\n###############\n\n* **src-dir** Defaults **/var/lib/haproxystats/incoming**\n\n\nA directory to watch for changes. It should point to the same directory as\nthe **dst-dir** option from *pull* section.\n\n* **workers** Defaults to **4**\n\nNumber of workers to use for processing statistics. These are real processes\nwhich can consume a fair bit of CPU.\n\n* **frontend-metrics** Unset by default\n\nA list of frontend metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.\n\nhaproxystats-process emits an error and refuses to start if metrics aren't\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n`management`_ documentation of HAProxy.\n\n* **backend-metrics** Unset by default\n\nA list of backend metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.\n\nhaproxystats-process emits an error and refuses to start if metrics aren't\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n`management`_ documentation of HAProxy.\n\n* **server-metrics** Unset by default\n\nA list of server metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.\n\nhaproxystats-process emits an error and refuses to start if metrics aren't\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n`management`_ documentation of HAProxy.\n\n* **aggr-server-metrics** Defaults to **false**\n\nAggregates server's statistics across all backends.\n\n* **exclude-frontends** Unset by default\n\nA file which contains one frontend name per line for which processing is\nskipped.\n\n* **exclude-backends** Unset by default\n\nA file which contains one backend name per line for which processing is\nskipped.\n\n* **per-process-metrics** Defaults to **false**\n\nHAProxy daemon provides statistics and by default **haproxystat-process**\naggregates those statistics when HAProxy runs in multiprocess mode\n(nbproc > 1).\n\nSet this to **true** to get those statistics also per process as well.\nThis is quite useful for monitoring purposes where someone wants to monitor\nsessions per process in order to see if traffic is evenly distributed to all\nprocesses by the kernel.\n\nIt is also useful in setups where configuration for frontends and backends is\nunevenly spread across all processes, for instance processes 1-4 manage SSL\nfrontends and processes 5-7 manage noSSL frontends.\n\nThis adds another path in Graphite under haproxy space::\n\n    loadbalancers.lb-01.haproxy.daemon.process.<process_num>.<metric>\n\n* **calculate-percentages** Defaults to **false**\n\nCalculates percentages for a selection of metrics for HAProxy daemon. When\n**per-process-metrics** is set to **true** the calculation happens also per\nHAProxy process. This adds the following metric names::\n\n    ConnPercentage\n    ConnRatePercentage\n    SslRatePercentage\n    SslConnPercentage\n\nThose metrics can be used for alerting when the current usage on connections\nis very close the configured limit.\n\n* **liveness-check-interval** Defaults to **10** (seconds)\n\nHow often to check if all workers are alive and trigger a termination if at\nleast one is dead.\n\ngraphite section\n################\n\nThis dispatcher **is enabled** by default and it can't be disabled.\n\n* **server** Defaults to **127.0.0.1**\n\nGraphite server to connect to.\n\n* **port**  Defaults to **3002**\n\nGraphite port to connect to.\n\n* **retries** Defaults to **3**\n\nNumber of times to reconnect to Graphite after a failure.\n\n* **interval** Defaults to **1.8** (seconds)\n\nTime to wait before trying to reconnect to Graphite after a failure.\n\n* **connect-timeout** Defaults to **1** (seconds)\n\nTime to wait for establishing a connection to Graphite relay.\n\n* **write-timeout** Defaults to **1** (seconds)\n\nTime to wait on sending data to Graphite relay.\n\n* **delay** Defaults to **10** (seconds)\n\nHow long to wait before trying to connect again after number of retries has\nexceeded the threshold set in **retries**. During the delay period metrics are\nstored in the queue of the dispatcher, see **queue-size**.\n\n* **backoff** Defaults to **2**\n\nA simple exponential backoff to apply for each retry.\n\n* **namespace** Defaults to **loadbalancers**\n\nA top level graphite namespace.\n\n* **prefix-hostname** Defaults to **true**\n\nInsert the hostname of the load balancer in the Graphite namespace, example::\n\n    loadbalancers.lb-01.haproxy.\n\n* **fqdn** Defaults to **true**\n\nUse FQDN or short name in the graphite namespace\n\n* **queue-size**  Defaults to **1000000**\n\nhaproxystats-process uses a queue to store metrics which failed to be sent due\nto a connection error/timeout. This is a First In First Out queueing system.\nWhen the queue reaches the limit, the oldest items are removed to free space.\n\n* **group-namespace** Unset by default.\n\ngroup graphite metrics by patterns. When a frontend, backend or server matches a\ngiven pattern, the metric will be prefixed by this namespace, plus a\nconfigurable group name which must be specified in the **frontend-groups**,\n**backend-groups** or **server-groups** sections. These sections consist of\ngroup names and their corresponding regular expression that will be matched\nagainst frontend, backend or server names (depending on the section).\n\nFor example:\n\nLet's assume our metrics look something like::\n\n    loadbalancers.lb-01.haproxy.frontend.foo-001.<metric>\n    loadbalancers.lb-01.haproxy.frontend.foo-002.<metric>\n    ...\n    loadbalancers.lb-01.haproxy.frontend.bar-001.<metric>\n    loadbalancers.lb-01.haproxy.frontend.bar-002.<metric>\n    ...\n\nAnd we want them to be grouped to like this::\n\n    loadbalancers.lb-01.haproxy.flavor.abc.frontend.foo-001.<metric>\n    loadbalancers.lb-01.haproxy.flavor.abc.frontend.foo-002.<metric>\n    ...\n    loadbalancers.lb-01.haproxy.flavor.xyz.frontend.bar-001.<metric>\n    loadbalancers.lb-01.haproxy.flavor.xyz.frontend.bar-002.<metric>\n    ...\n\nThe configuration should contain these settings::\n\n    [graphite]\n    group-namespace = flavor\n\n    [frontend-groups]\n    abc = ^foo-\n    xyz = ^bar-\n\nNote that if the **group-namespace** setting is specified, then at least one of\n**frontend-groups**, **backend-groups** or **server-groups** sections must be\nspecified as well.\n\nAlso note that if frontend, backend or server names contain dots, these will be\nconverted to underscores for graphite -- because dots are graphite's namespace\nseparator. The patterns will have to take this into account.\n\n* **group-namespace-double-writes** Unset by default.\n\nBoolean; required only if **group-namespace** is specified. If True, send to\ngraphite the original metric as well as the grouped metrics. If False, send\nonly the grouped metrics. (See **group-namespace**.)\n\nfrontend-groups, backend-groups, and server-groups sections\n###########################################################\n\nSpecify the patterns to match against frontend, backend and/or server names, to\ngroup graphite metrics and give them a variable prefix. See **group-namespace**.\n\nThese sections are optional, unless **group-namespace** is set.\n\nlocal-store section\n###################\n\nThis dispatcher **isn't** enabled by default.\n\nThe primarily use of local-store dispatcher is to debug/troubleshoot possible\nproblems with the processing or/and with Graphite. There isn't any clean-up\nprocess in place, thus you need remove the files after they are created.\nDon't leave it enabled for more than 1 hour as it can easily fill up the disk\nin environments with hundreds frontends/backends and thousands servers.\n\n* **dir** Defaults to **/var/lib/haproxystats/local-store**\n\nA directory to stores statistics after they have been processed. The current\nformat is compatible with Graphite.\n\nSystemd integration\n-------------------\n\nhaproxystats-pull and haproxystats-process are simple programs which are not\ndaemonized and they output logging messages to stdout. This is by design as it\nsimplifies the code. The daemonization and logging is off-loaded to systemd\nwhich has everything we need for that job.\n\nUnder contrib/systend directory there are service files for both programs.\nThese are functional systemd Unit files which are used in production.\n\nThe order in which these 2 programs start doesn't matter and there isn't any\nsoft or hard dependency between them.\n\nFurthermore, these programs don't need to run as root. It highly recommended to\ncreate a dedicated user to run them. You need to add that user to the group of\n*haproxy* and adjust socket configuration of haproxy to allow write for the\ngroup, see below an example configuration::\n\n    stats socket /run/haproxy/sock1 user haproxy group haproxy mode 660 level admin process 1\n    stats socket /run/haproxy/sock2 user haproxy group haproxy mode 660 level admin process 2\n    stats socket /run/haproxy/sock3 user haproxy group haproxy mode 660 level admin process 3\n\nsystemd Unit files use haproxystats user which has to be created prior running\nhaproxystats programs.\n\nGraceful shutdown\n-----------------\n\nIn an effort to reduce the loss of statistics both programs support graceful\nshutdown. When *SIGHUP* or *SIGTERM* signals are sent they perform a clean exit.\nWhen a signal is sent to haproxystats-process it may take some time for the\nprogram to exit, as it waits for all workers to empty the queue.\n\nPuppet module\n-------------\n\nA puppet module is available under contrib directory which provides classes for\nconfiguring both programs.\n\nBecause haproxystats-process is CPU bound program, CPU Affinity is configured\nusing systemd. By default it pins the workers to the last CPUs.\n\nYou should take care of pinning haproxy processes to other CPUs in order to\navoid haproxystats-process *stealing* CPU cycles from haproxy. In production\nservers you usually pin the first 80% of CPUs to haproxy processes and you\nleave the rest of CPUs for other processes. The default template of puppet\nmodule enforces this logic.\n\nhaproxystats-pull is a single threaded program which doesn't use a lot of CPU\ncycles and by default is assigned to the last CPU.\n\nAnsible Playbook\n----------------\n\nA Ansible playbook is available under contrib directory. For installation\ninstruction of the playbook please read Installation chapter of this document.\n\nNagios checks\n-------------\n\nSeveral nagios checks are provided for monitoring purposes, they can be found\nunder contrib/nagios directory.\n\n* check_haproxystats_process_number_of_procs.sh\n\nMonitor the number of processes of haproxystats-process program. Systemd\nmonitors only the parent process and this check helps to detect cases where\nsome worker(s) die unexpectedly\n\n* check_haproxystats_process.sh\n\nA wrapper around systemctl tool to detect a dead parent process.\n\n* check_haproxystats_pull.sh\n\nA wrapper around systemctl tool to a check if haproxystats-pull is running.\n\n* check_haproxystats_queue_size.py\n\nChecks the size of the *incoming* directory queue which is consumed by\nhaproxystats-process and alert when exceeds a threshold.\n\n\nStarting the programs\n---------------------\n\n::\n\n    haproxystats-pull -f ./haproxystats.conf\n\n::\n\n    haproxystats-process -f ./haproxystats.conf\n\nUsage::\n\n    % haproxystats-pull -h\n    Pulls statistics from HAProxy daemon over UNIX socket(s)\n\n    Usage:\n        haproxystats-pull [-f <file>] [-p | -P]\n\n    Options:\n        -f, --file <file>  configuration file with settings\n                           [default: /etc/haproxystats.conf]\n        -p, --print        show default settings\n        -P, --print-conf   show configuration\n        -h, --help         show this screen\n        -v, --version      show version\n\n\n    % haproxystats-process -h\n    Processes statistics from HAProxy and pushes them to Graphite\n\n    Usage:\n        haproxystats-process [-f <file>] [-d <dir>] [-p | -P]\n\n    Options:\n        -f, --file <file>  configuration file with settings\n                           [default: /etc/haproxystats.conf]\n        -d, --dir <dir>    directory with additional configuration files\n        -p, --print        show default settings\n        -P, --print-conf   show configuration\n        -h, --help         show this screen\n        -v, --version      show version\n\n\nDevelopment\n-----------\nI would love to hear what other people think about **haproxystats** and provide\nfeedback. Please post your comments, bug reports and wishes on my `issues page\n<https://github.com/unixsurfer/haproxystats/issues>`_.\n\nHow to setup a development environment\n######################################\n\nInstall HAProxy::\n\n    % sudo apt-get install haproxy\n\nUse a basic HAProxy configuration in multiprocess mode::\n\n    global\n        log 127.0.0.1 len 2048 local2\n        chroot /var/lib/haproxy\n        stats socket /run/haproxy/admin1.sock mode 666 level admin process 1\n        stats socket /run/haproxy/admin2.sock mode 666 level admin process 2\n        stats socket /run/haproxy/admin3.sock mode 666 level admin process 3\n        stats socket /run/haproxy/admin4.sock mode 666 level admin process 4\n        # allow read/write access to anyone----------^\n        stats timeout 30s\n        user haproxy\n        group haproxy\n        daemon\n        nbproc 4\n        cpu-map 1 0\n        cpu-map 2 1\n        cpu-map 3 1\n        cpu-map 4 0\n\n    defaults\n        log global\n        mode    http\n        timeout connect 5000\n        timeout client  50000\n        timeout server  50000\n\n    frontend frontend_proc1\n        bind 0.0.0.0:81 process 1\n        default_backend backend_proc1\n\n    frontend frontend_proc2\n        bind 0.0.0.0:82 process 2\n        default_backend backend_proc1\n\n    frontend frontend1_proc34\n        bind :83 process 3\n        bind :83 process 4\n        default_backend backend1_proc34\n\n    backend backend_proc1\n        bind-process 1\n        default-server inter 1000s\n        option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n        server member1_proc1 10.189.224.169:80 weight 100 check fall 2 rise 3\n        server member2_proc1 10.196.70.109:80 weight 100 check fall 2 rise 3\n        server bck_all_srv1 10.196.70.109:88 weight 100 check fall 2 rise 3\n\n    backend backend1_proc34\n        bind-process 3,4\n        default-server inter 1000s\n        option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n        server bck1_proc34_srv1 10.196.70.109:80 check fall 2 inter 5s rise 3\n        server bck1_proc34_srv2 10.196.70.109:80 check fall 2 inter 5s rise 3\n        server bck_all_srv1 10.196.70.109:80 check fall 2 inter 5s rise 3\n\n    backend backend_proc2\n        bind-process 2\n        default-server inter 1000s\n        option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n        server bck_proc2_srv1_proc2 127.0.0.1:8001 check fall 2 inter 5s rise 3\n        server bck_proc2_srv2_proc2 127.0.0.1:8002 check fall 2 inter 5s rise 3\n        server bck_proc2_srv3_proc2 127.0.0.1:8003 check fall 2 inter 5s rise 3\n        server bck_proc2_srv4_proc2 127.0.0.1:8004 check fall 2 inter 5s rise 3\n\nStart HAProxy and check it is up::\n\n    sudo systemctl start haproxy.service;systemctl status -l haproxy.service\n\nCreate a python virtual environment using virtualenvwrapper tool::\n\n    mkvirtualenv --python=`which python3` haproxystats-dev\n\n**Do not** exit the *haproxystats-dev* virtual environment.\n\nClone the project, if you are planning to contribute then you should fork it on\nGitHub and clone that project instead::\n\n    mkdir ~/repo;cd ~/repo\n    git clone https://github.com/unixsurfer/haproxystats\n\nInstall necessary libraries::\n\n    cd haproxystats\n    pip install -U pbr setuptools\n    pip install -r ./requirements.txt\n\nStart a TCP server which acts a Graphite relay and listens on 127.0.0.1:39991::\n\n    python3 ./contrib/tcp_server.py\n\nInstall haproxystats::\n\n    python setup.py install\n\nCreate necessary directory structure::\n\n    mkdir -p ./var/var/lib/haproxystats\n    mkdir -p ./var/etc\n    mkdir -p ./var/etc/haproxystats.d\n\nAdjust the following configuration and save it in ./var/etc/haproxystats.conf::\n\n    [DEFAULT]\n    loglevel = debug\n    retries  = 2\n    timeout  = 1\n    interval = 2\n\n    [paths]\n    base-dir = /home/<username>/repo/haproxystats/var/var/lib/haproxystats\n\n    [pull]\n    socket-dir    = /run/haproxy\n    retries       = 1\n    timeout       = 0.1\n    interval      = 0.5\n    pull-timeout  = 10\n    pull-interval = 10\n    dst-dir       = ${paths:base-dir}/incoming\n    tmp-dst-dir   = ${paths:base-dir}/incoming.tmp\n    workers       = 8\n\n    [process]\n    src-dir               = ${paths:base-dir}/incoming\n    workers               = 2\n    calculate-percentages = true\n    per-process-metrics   = true\n\n    [graphite]\n    server          = 127.0.0.1\n    port            = 39991\n    retries         = 3\n    interval        = 0.8\n    timeout         = 0.9\n    delay           = 10\n    backoff         = 2\n    namespace       = loadbalancers\n    prefix_hostname = true\n    fqdn            = true\n    queue-size      = 1000\n\n    [local-store]\n    dir = ${paths:base-dir}/local-store\n\nStart haproxystats-pull and haproxystats-process on 2 different terminals::\n\n    haproxystats-pull -f var/etc/haproxystats.conf\n    haproxystats-process -f var/etc/haproxystats.conf\n\nExit from *haproxystats-dev* virtual environment::\n\n    deactivate\n\n**Start hacking and don't forget to make a Pull Request**\n\nInstallation\n------------\n\nUse pip::\n\n    pip install haproxystats\n\nFrom Source::\n\n   sudo python setup.py install\n\nBuild (source) RPMs::\n\n   python setup.py clean --all; python setup.py bdist_rpm\n\nBuild a source archive for manual installation::\n\n   python setup.py sdist\n\nUse Ansible Playbook:\n\nTo deploy haproxystats By Ansible Playbook go to contrib/ansible-playbook\ndirectory::\n\n   cd contrib/ansible-playbook\n\nThen enter your haproxy server IP address in hosts file::\n\n   vi hosts\n\nAfter that set information of your environment in variable file::\n\n   vi group_vars/all\n\nNow for run Ansible Playbook use this command::\n\n   ansible-playbook -i hosts main-playbook.yml\n\nWhen Ansible Playbook run successful completely, you can take control haproxystats-pull and haproxystats-process by systemd::\n\n   systemctl start haproxystats-pull.service\n\n   systemctl start haproxystats-process.service\n\n\nHow to make a release\n---------------------\n\n#. Bump version in haproxystats/__init__.py\n\n#. Commit above change with::\n\n      git commit -av -m'RELEASE 0.1.3 version'\n\n#. Create a signed tag, pbr will use this for the version number::\n\n      git tag -s 0.1.3 -m 'bump release'\n\n#. Create the source distribution archive (the archive will be placed in the\n   **dist** directory)::\n\n      python setup.py sdist\n\n#. pbr updates ChangeLog file and we want to squeeze this change to the\n   previous commit, thus run::\n\n      git commit -av --amend\n\n#. Move current tag to the last commit::\n\n      git tag -fs 0.1.3 -m 'bump release'\n\n#. Push changes::\n\n      git push;git push --tags\n\n#. Upload to Python Package Index::\n\n      twine upload -s -p  dist/*\n\n\nContributors\n------------\n\nThe following people have contributed to project with feedback and code reviews\n\n- K\u00e1roly Nagy https://github.com/charlesnagy\n\n- Dan Achim https://github.com/danakim\n\nLicensing\n---------\n\nApache 2.0\n\nAcknowledgement\n---------------\nThis program was originally developed for Booking.com.  With approval\nfrom Booking.com, the code was generalised and published as Open Source\non github, for which the author would like to express his gratitude.\n\nContacts\n--------\n\n**Project website**: https://github.com/unixsurfer/haproxystats\n\n**Author**: Pavlos Parissis <pavlos.parissis@gmail.com>\n\n.. _HAProxy: http://www.haproxy.org/\n.. _stats socket: http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.2\n.. _carbon-c-relay: https://github.com/grobian/carbon-c-relay\n.. _Pandas: http://pandas.pydata.org/\n.. _asyncio: https://docs.python.org/3/library/asyncio.html\n.. _inotify: http://linux.die.net/man/7/inotify\n.. _stat: http://cbonte.github.io/haproxy-dconv/1.6/management.html#show%20stat\n.. _info: http://cbonte.github.io/haproxy-dconv/1.6/management.html#show%20info\n.. _pool of threads: https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor\n.. _INI: https://en.wikipedia.org/wiki/INI_file\n.. _carbon-c-relay: https://github.com/grobian/carbon-c-relay\n.. _management: http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.1", "description_content_type": "", "docs_url": null, "download_url": "", "downloads": {"last_day": -1, "last_month": -1, "last_week": -1}, "home_page": "https://github.com/unixsurfer/haproxystats", "keywords": "haproxystats haproxy stats collector statistics", "license": "Apache 2.0", "maintainer": "Pavlos Parissis", "maintainer_email": "pavlos.parissis@gmail.com", "name": "haproxystats", "package_url": "https://pypi.org/project/haproxystats/", "platform": "", "project_url": "https://pypi.org/project/haproxystats/", "project_urls": {"Homepage": "https://github.com/unixsurfer/haproxystats"}, "release_url": "https://pypi.org/project/haproxystats/0.5.1/", "requires_dist": null, "requires_python": "", "summary": "A HAProxy statistics collection program", "version": "0.5.1", "yanked": false, "html_description": "<div class=\"project-description\">\n            <blockquote>\n<em>A HAProxy statistics collection program</em></blockquote>\n<div id=\"contents\">\n<p>Contents</p>\n<ul>\n<li><a href=\"#introduction\" id=\"id2\" rel=\"nofollow\">Introduction</a></li>\n<li><a href=\"#how-haproxystats-works\" id=\"id3\" rel=\"nofollow\">How haproxystats works</a><ul>\n<li><a href=\"#haproxystats-pull\" id=\"id4\" rel=\"nofollow\">haproxystats-pull</a></li>\n<li><a href=\"#haproxystats-process\" id=\"id5\" rel=\"nofollow\">haproxystats-process</a></li>\n<li><a href=\"#dispatchers\" id=\"id6\" rel=\"nofollow\">Dispatchers</a></li>\n<li><a href=\"#statistics-for-haproxy\" id=\"id7\" rel=\"nofollow\">Statistics for HAProxy</a><ul>\n<li><a href=\"#haproxy-process\" id=\"id8\" rel=\"nofollow\">HAProxy process</a></li>\n</ul>\n</li>\n<li><a href=\"#queuing-system\" id=\"id9\" rel=\"nofollow\">Queuing system</a></li>\n<li><a href=\"#statistics-for-haproxystats\" id=\"id10\" rel=\"nofollow\">Statistics for haproxystats</a></li>\n</ul>\n</li>\n<li><a href=\"#configuration\" id=\"id11\" rel=\"nofollow\">Configuration</a><ul>\n<li><a href=\"#default-section\" id=\"id12\" rel=\"nofollow\">DEFAULT section</a></li>\n<li><a href=\"#paths-section\" id=\"id13\" rel=\"nofollow\">paths section</a></li>\n<li><a href=\"#pull-section\" id=\"id14\" rel=\"nofollow\">pull section</a></li>\n<li><a href=\"#process-section\" id=\"id15\" rel=\"nofollow\">process section</a></li>\n<li><a href=\"#graphite-section\" id=\"id16\" rel=\"nofollow\">graphite section</a></li>\n<li><a href=\"#frontend-groups-backend-groups-and-server-groups-sections\" id=\"id17\" rel=\"nofollow\">frontend-groups, backend-groups, and server-groups sections</a></li>\n<li><a href=\"#local-store-section\" id=\"id18\" rel=\"nofollow\">local-store section</a></li>\n</ul>\n</li>\n<li><a href=\"#systemd-integration\" id=\"id19\" rel=\"nofollow\">Systemd integration</a></li>\n<li><a href=\"#graceful-shutdown\" id=\"id20\" rel=\"nofollow\">Graceful shutdown</a></li>\n<li><a href=\"#puppet-module\" id=\"id21\" rel=\"nofollow\">Puppet module</a></li>\n<li><a href=\"#ansible-playbook\" id=\"id22\" rel=\"nofollow\">Ansible Playbook</a></li>\n<li><a href=\"#nagios-checks\" id=\"id23\" rel=\"nofollow\">Nagios checks</a></li>\n<li><a href=\"#starting-the-programs\" id=\"id24\" rel=\"nofollow\">Starting the programs</a></li>\n<li><a href=\"#development\" id=\"id25\" rel=\"nofollow\">Development</a><ul>\n<li><a href=\"#how-to-setup-a-development-environment\" id=\"id26\" rel=\"nofollow\">How to setup a development environment</a></li>\n</ul>\n</li>\n<li><a href=\"#installation\" id=\"id27\" rel=\"nofollow\">Installation</a></li>\n<li><a href=\"#how-to-make-a-release\" id=\"id28\" rel=\"nofollow\">How to make a release</a></li>\n<li><a href=\"#contributors\" id=\"id29\" rel=\"nofollow\">Contributors</a></li>\n<li><a href=\"#licensing\" id=\"id30\" rel=\"nofollow\">Licensing</a></li>\n<li><a href=\"#acknowledgement\" id=\"id31\" rel=\"nofollow\">Acknowledgement</a></li>\n<li><a href=\"#contacts\" id=\"id32\" rel=\"nofollow\">Contacts</a></li>\n</ul>\n</div>\n<div id=\"introduction\">\n<h2><a href=\"#id2\" rel=\"nofollow\">Introduction</a></h2>\n<p><strong>haproxystats</strong> is a statistics collector for <a href=\"http://www.haproxy.org/\" rel=\"nofollow\">HAProxy</a> load balancer which\nprocesses various statistics and pushes them to graphing systems (Graphite).\nIt is designed to satisfy the following requirements:</p>\n<ol>\n<li>Fast and configurable processing of HAProxy statistics</li>\n<li>Perform aggregation when HAProxy runs in multiprocess (nbproc &gt; 1)</li>\n<li>Pull statistics at very low intervals (10secs)</li>\n<li>Flexible dispatching of statistics to different systems (Graphite,  kafka)</li>\n</ol>\n<p>The main design characteristic is the split between pulling the statistics and\nprocessing them. This provides the ability to pull data as frequently\nas possible without worrying about the impact on processing time. It also\nreduces the risk of losing data in case of trouble during the processing phase.</p>\n<p>It runs locally on each load balancer node, offering a decentralized setup for\nthe processing phase, but it can be easily extended in the future to have a\ncentralized setup for the processing phase. In that centralized setup it will\nbe possible to perform aggregation on a cluster level as well.\nUntil then users can deploy <a href=\"https://github.com/grobian/carbon-c-relay\" rel=\"nofollow\">carbon-c-relay</a> for aggregation.</p>\n<p>Because of this design haproxystats comes with two programs:\n<strong>haproxystats-pull</strong> and <strong>haproxystats-process</strong>. The former pulls\nstatistics from HAProxy via <a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.2\" rel=\"nofollow\">stats socket</a> and it uses the <a href=\"https://docs.python.org/3/library/asyncio.html\" rel=\"nofollow\">asyncio</a> framework\nfrom Python to achieve high concurrency and low footprint. The latter\nprocesses the statistics and pushes them to various destinations. It utilizes\n<a href=\"http://pandas.pydata.org/\" rel=\"nofollow\">Pandas</a> for data analysis and the multiprocess framework from Python.</p>\n<p>haproxystats requires Python 3.4, docopt and Pandas to be available in the\nsystem.</p>\n</div>\n<div id=\"how-haproxystats-works\">\n<h2><a href=\"#id3\" rel=\"nofollow\">How haproxystats works</a></h2>\n<img alt=\"haproxystats-architecture.png\" src=\"https://warehouse-camo.ingress.cmh1.psfhosted.org/466aa465650f32957239644010f5d3f3e111da11/686170726f787973746174732d6172636869746563747572652e706e67\">\n<p>haproxystats-pull sends <a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#show%20info\" rel=\"nofollow\">info</a> and <a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#show%20stat\" rel=\"nofollow\">stat</a> commands to all haproxy processes\nin order to collect statistics for the daemon and for all\nfrontends/backends/servers. Data returned from each process and for each\ncommand is stored in individual files which are saved under one directory. The\ntime (seconds since the epoch) of retrieval is used to name that directory.\nhaproxystats-process watches for changes on the parent directory and when a\ndirectory is created it adds its full path to the queue. Multiple workers pick\nup items (directories) from the queue and process statistics from those\ndirectories.</p>\n<div id=\"haproxystats-pull\">\n<h3><a href=\"#id4\" rel=\"nofollow\">haproxystats-pull</a></h3>\n<p>haproxystats-pull leverages the <a href=\"https://docs.python.org/3/library/asyncio.html\" rel=\"nofollow\">asyncio</a> framework from Python by utilizing\ncoroutines to multiplex I/O access over several <a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.2\" rel=\"nofollow\">stats socket</a>, which are\nsimple UNIX and TCP sockets.</p>\n<p>The actual task of storing the data to the file system is off-loaded to a very\nlight <a href=\"https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor\" rel=\"nofollow\">pool of threads</a> in order to avoid blocking the coroutines during the\ndisk IO phase.</p>\n<p>haproxystats-pull manages the <em>incoming</em> directory and makes sure directories\nare created with correct names. It also suspends the collection when the number\nof directories under the <em>incoming</em> directory exceeds a threshold. This avoids\nfilling up the disk when haproxystats-process is unavailable for sometime.\nThis an example of directory structure:</p>\n<pre>incoming\n\u251c\u2500\u2500 <span class=\"m\">1457298067</span>\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin1.sock_info\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin1.sock_stat\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin2.sock_info\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin2.sock_stat\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin3.sock_info\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin3.sock_stat\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 admin4.sock_info\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 admin4.sock_stat\n\u2514\u2500\u2500 <span class=\"m\">1457298072</span>\n    \u251c\u2500\u2500 admin1.sock_info\n    \u251c\u2500\u2500 admin1.sock_stat\n    \u251c\u2500\u2500 admin2.sock_info\n    \u251c\u2500\u2500 admin2.sock_stat\n    \u251c\u2500\u2500 admin3.sock_info\n    \u251c\u2500\u2500 admin3.sock_stat\n    \u251c\u2500\u2500 admin4.sock_info\n    \u2514\u2500\u2500 admin4.sock_stat\n</pre>\n</div>\n<div id=\"haproxystats-process\">\n<h3><a href=\"#id5\" rel=\"nofollow\">haproxystats-process</a></h3>\n<p>haproxystats-process is a multiprocess program. The parent process uses the\nLinux kernel\u2019s <a href=\"http://linux.die.net/man/7/inotify\" rel=\"nofollow\">inotify</a> API to watch for changes in <em>incoming</em> directory.</p>\n<p>It receives an event when a directory is either created or moved in <em>incoming</em>\ndirectory. The event contains the absolute path name of that directory. It\nmaintains an internal queue in which it puts directory names. Multiple child\nprocesses pick directory names from the queue and process the data.</p>\n<p>Its worker dispatches statistics to various destinations. The directories are\nremoved from <em>incoming</em> directory when all statistics are successfully\nprocessed.</p>\n<p>When haproxystats-process starts it scans the <em>incoming</em> directory\nfor new directories and processes them instantly, so you don\u2019t lose statistics\nif haproxystats-process is unavailable for sometime.</p>\n</div>\n<div id=\"dispatchers\">\n<h3><a href=\"#id6\" rel=\"nofollow\">Dispatchers</a></h3>\n<p>haproxystats-process currently supports 2 different dispatchers.</p>\n<ol>\n<li><strong>Graphite</strong></li>\n</ol>\n<p>Pushes statistics to a Graphite system via a local or remote carbon-relay.\nThe recommended method is to use <a href=\"https://github.com/grobian/carbon-c-relay\" rel=\"nofollow\">carbon-c-relay</a>. It is very fast and capable\nof handling millions of metrics per second. This dispatcher utilizes an internal\nqueue to store metrics which are failed to be sent to Graphite.</p>\n<p>An example of graphite namespace:</p>\n<pre>&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.frontend.&lt;frontendname&gt;.\n&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.backend.&lt;backendname&gt;.\n&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.backend.&lt;backendname&gt;.server.&lt;servername&gt;\n&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.server.&lt;servername&gt;.\n&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.daemon.\n&lt;loadbalancers&gt;.&lt;lb-01&gt;.haproxy.haproxystats.&lt;metric names&gt;.\n</pre>\n<ol>\n<li><strong>local-store</strong></li>\n</ol>\n<p>Stores statistics in the local disk. Use it only for debugging purposes.</p>\n</div>\n<div id=\"statistics-for-haproxy\">\n<h3><a href=\"#id7\" rel=\"nofollow\">Statistics for HAProxy</a></h3>\n<p>In addition the statistics that are exposed by HAProxy, haproxystats provides\nthe following statistics.</p>\n<div id=\"haproxy-process\">\n<h4><a href=\"#id8\" rel=\"nofollow\">HAProxy process</a></h4>\n<p>HAProxy exposes Idle_pct and haproxystats-process converts it to CPU\nutilization without removing Idle_pct metric. This avoids the usage of\nscale(-1) and offset(100) functions on graphite:</p>\n<pre>CpuUsagePct  CPU utilization in percentage\n</pre>\n<p>The following metrics are calculated only when HAProxy is configured with more\nthan 1 processes (nbproc &gt; 1):</p>\n<pre>25PercentileCpuUsagePct 25th percentile of CpuUsagePct across all processes\n50PercentileCpuUsagePct 50th percentile              -//-\n75PercentileCpuUsagePct 75th percentile              -//-\n95PercentileCpuUsagePct 95th percentile              -//-\n99PercentileCpuUsagePct 99th percentile              -//-\nStdCpuUsagePct          standard deviation           -//-\n</pre>\n</div>\n</div>\n<div id=\"queuing-system\">\n<h3><a href=\"#id9\" rel=\"nofollow\">Queuing system</a></h3>\n<p>The <em>incoming</em> directory together with the inotify API provides a simple\nqueueing system which is used as a communication channel between\nhaproxystats-pull and haproxystats-process programs.</p>\n<p>There isn\u2019t any feedback mechanism in place, thus haproxystats-pull monitors\nthe number of directories before it pulls data from HAProxy and suspends its\njob when the number of directories exceeds a threshold.</p>\n<p>See <strong>queue-size</strong> parameter of <strong>pull</strong> section.</p>\n</div>\n<div id=\"statistics-for-haproxystats\">\n<h3><a href=\"#id10\" rel=\"nofollow\">Statistics for haproxystats</a></h3>\n<p><strong>haproxystats</strong> provides statistics for the time it takes to process,\ncalculate and send HAProxy metrics. By default provides the following list\nof metric names with values in seconds:</p>\n<pre>loadbalancers.lb-01.haproxy.haproxystats.WallClockTimeHAProxy\nloadbalancers.lb-01.haproxy.haproxystats.WallClockTimeFrontends\nloadbalancers.lb-01.haproxy.haproxystats.WallClockTimeBackends\nloadbalancers.lb-01.haproxy.haproxystats.WallClockTimeServers\nloadbalancers.lb-01.haproxy.haproxystats.WallClockTimeAllStats\n</pre>\n<p>It also provides the number of metrics which are send to graphite:</p>\n<pre>loadbalancers.lb-01.haproxy.haproxystats.MetricsHAProxy\nloadbalancers.lb-01.haproxy.haproxystats.MetricsFrontend\nloadbalancers.lb-01.haproxy.haproxystats.MetricsBackend\nloadbalancers.lb-01.haproxy.haproxystats.MetricsServer\n</pre>\n</div>\n</div>\n<div id=\"configuration\">\n<h2><a href=\"#id11\" rel=\"nofollow\">Configuration</a></h2>\n<p>haproxystats uses the popular <a href=\"https://en.wikipedia.org/wiki/INI_file\" rel=\"nofollow\">INI</a> format for its configuration file.\nThis is an example configuration file (/etc/haproxystats.conf):</p>\n<pre>[DEFAULT]\nloglevel = info\nretries  = 2\ntimeout  = 1\ninterval = 2\n\n[paths]\nbase-dir = /var/lib/haproxystats\n\n[pull]\nloglevel        = info\nsocket-dir      = /run/haproxy\nretries         = 1\ntimeout         = 0.1\ninterval        = 0.5\npull-timeout    = 2\npull-interval   = 10\ndst-dir         = ${paths:base-dir}/incoming\ntmp-dst-dir     = ${paths:base-dir}/incoming.tmp\nworkers         = 8\nqueue-size      = 360\n\n[process]\nsrc-dir             = ${paths:base-dir}/incoming\nworkers             = 4\nper-process-metrics = false\n\n[graphite]\nserver          = 127.0.0.1\nport            = 3002\nretries         = 3\ninterval        = 1.8\nconnect-timeout = 1.0\nwrite-timeout   = 1.0\ndelay           = 10\nbackoff         = 2\nnamespace       = loadbalancers\nprefix-hostname = true\nfqdn            = true\nqueue-size      = 1000000\n\n#[local-store]\n#dir = ${paths:base-dir}/local-store\n</pre>\n<p>All the above settings are optional as haproxystats comes with default values\nfor all of them. Thus, both programs can be started without supplying any\nconfiguration.</p>\n<div id=\"default-section\">\n<h3><a href=\"#id12\" rel=\"nofollow\">DEFAULT section</a></h3>\n<p>Settings in this section can be overwritten in other sections.</p>\n<ul>\n<li><strong>loglevel</strong> Defaults to <strong>info</strong></li>\n</ul>\n<p>Log level to use, possible values are: debug, info, warning, error, critical</p>\n<ul>\n<li><strong>retries</strong> Defaults to <strong>2</strong></li>\n</ul>\n<p>Number of times to retry a connection after a failure. Used by haproxystats-pull\nand haproxystats-process when they open a connection to a UNIX/TCP socket and\nGraphite respectively.</p>\n<ul>\n<li><strong>timeout</strong> Defaults to <strong>1</strong> (seconds)</li>\n</ul>\n<p>Time to wait for establishing a connection. Used by haproxystats-pull and\nhaproxystats-process when they open a connection to a UNIX/TCP socket and Graphite\nrespectively.</p>\n<ul>\n<li><strong>interval</strong> Defaults to <strong>2</strong></li>\n</ul>\n<p>Time to wait before trying to open a connection. Used by haproxystats-pull and\nhaproxystats-process when they retry a connection to a UNIX/TCP socket and Graphite\nrespectively.</p>\n</div>\n<div id=\"paths-section\">\n<h3><a href=\"#id13\" rel=\"nofollow\">paths section</a></h3>\n<ul>\n<li><strong>base-dir</strong> Defaults to <strong>/var/lib/haproxystats</strong></li>\n</ul>\n<p>The directory to use as the base of the directory structure.</p>\n</div>\n<div id=\"pull-section\">\n<h3><a href=\"#id14\" rel=\"nofollow\">pull section</a></h3>\n<ul>\n<li><strong>socket-dir</strong> Unset by default</li>\n</ul>\n<p>A directory with HAProxy socket files.</p>\n<ul>\n<li><strong>servers</strong> Unset by default</li>\n</ul>\n<p>A list of servers to pull statistics from. You define a server by passing a URL,\nhere some examples:</p>\n<pre>tcp://127.0.0.1:5555\ntcp://foo.bar.com:4444\ntcp://[fe80::3f2f:46b3:ef0c:a420]:4444\nunix:///run/haproxy.sock\n</pre>\n<p>Only TCP and UNIX schemes are supported and the port for TCP servers <strong>must</strong>\nbe set. For UNIX scheme you can only pass a file and not a directory, but\n<strong>socket-dir</strong> option can be set as well, so you can use a directory and UNIX\nsocket files at the same time. You can use comma as separator to pass multiple\nservers:</p>\n<pre>servers = unix:///run/haproxy.sock,tcp://127.0.0.1:555,tcp://127.0.0.1:556\n</pre>\n<ul>\n<li><strong>buffer-limit</strong> Defaults to <strong>6291456</strong> (bytes)</li>\n</ul>\n<p>At most size bytes are read and returned from the sockets. Setting too low and\nit will slow down the retrieval of statistics.\nOnly values greater than or equal to 1 are accepted.</p>\n<ul>\n<li><strong>retries</strong> Defaults to <strong>1</strong></li>\n</ul>\n<p>Number of times to reconnect to UNIX/TCP socket after a failure.</p>\n<ul>\n<li><strong>timeout</strong> Defaults to <strong>0.1</strong> (seconds)</li>\n</ul>\n<p>Time to wait for establishing a connection to UNIX/TCP socket. There is no need to\nset it higher than few ms as haproxy accepts a connection within 1-2ms.</p>\n<ul>\n<li><strong>interval</strong> Defaults to <strong>0.5</strong> (seconds)</li>\n</ul>\n<p>Time to wait before trying to reconnect to UNIX/TCP socket after a failure. Tune it\nbased on the duration of the reload process of haproxy. haproxy reloads within\nfew ms but in some environments with hundreds different SSL certificates it can\ntake a bit more.</p>\n<ul>\n<li><strong>pull-interval</strong> Defaults to <strong>10</strong> (seconds)</li>\n</ul>\n<p>How often to pull statistics from HAProxy. A value of <em>1</em> second can overload\nthe haproxy processes in environments with thousands backends/servers.</p>\n<ul>\n<li><strong>pull-timeout</strong> Defaults to <strong>2</strong> (seconds)</li>\n</ul>\n<p>Total time to wait for the pull process to finish. Should be always less than\n<strong>pull-interval</strong>.</p>\n<ul>\n<li><strong>dst-dir</strong> Defaults <strong>/var/lib/haproxystats/incoming</strong></li>\n</ul>\n<p>A directory to store statistics retrieved by HAProxy.</p>\n<ul>\n<li><strong>tmp-dst-dir</strong> Defaults <strong>/var/lib/haproxystats/incoming.tmp</strong></li>\n</ul>\n<p>A directory to use as temporary storage location before directories are moved\nto <strong>dst-dir</strong>.  haproxystats-pull stores statistics for each process under\nthat directory and only when data from all haproxy processes are successfully\nretrieved they are moved to <strong>dst-dir</strong>. Make sure <strong>dst-dir</strong> and\n<strong>tmp-dst-dir</strong> are on the same file system, so the move of the directories\nbecome a rename which is a quick and atomic operation.</p>\n<ul>\n<li><strong>workers</strong>  Defaults to <strong>8</strong></li>\n</ul>\n<p>Number of threads to use for writing statistics to disk. These are very\nlight threads and don\u2019t consume a lot of resources. Shouldn\u2019t be set higher\nthan the number of haproxy processes.</p>\n<ul>\n<li><strong>queue-size</strong> Defaults to <strong>360</strong></li>\n</ul>\n<p>Suspend the pulling of statistics when the number of directories in <strong>dst-dir</strong>\nexceeds this limit.</p>\n</div>\n<div id=\"process-section\">\n<h3><a href=\"#id15\" rel=\"nofollow\">process section</a></h3>\n<ul>\n<li><strong>src-dir</strong> Defaults <strong>/var/lib/haproxystats/incoming</strong></li>\n</ul>\n<p>A directory to watch for changes. It should point to the same directory as\nthe <strong>dst-dir</strong> option from <em>pull</em> section.</p>\n<ul>\n<li><strong>workers</strong> Defaults to <strong>4</strong></li>\n</ul>\n<p>Number of workers to use for processing statistics. These are real processes\nwhich can consume a fair bit of CPU.</p>\n<ul>\n<li><strong>frontend-metrics</strong> Unset by default</li>\n</ul>\n<p>A list of frontend metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.</p>\n<p>haproxystats-process emits an error and refuses to start if metrics aren\u2019t\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n<a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.1\" rel=\"nofollow\">management</a> documentation of HAProxy.</p>\n<ul>\n<li><strong>backend-metrics</strong> Unset by default</li>\n</ul>\n<p>A list of backend metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.</p>\n<p>haproxystats-process emits an error and refuses to start if metrics aren\u2019t\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n<a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.1\" rel=\"nofollow\">management</a> documentation of HAProxy.</p>\n<ul>\n<li><strong>server-metrics</strong> Unset by default</li>\n</ul>\n<p>A list of server metric names separated by space to process. By default all\nstatistics are processed and this overwrites the default selection.</p>\n<p>haproxystats-process emits an error and refuses to start if metrics aren\u2019t\nvalid HAProxy metrics. Check the list of valid metrics in Chapter 9.1 of\n<a href=\"http://cbonte.github.io/haproxy-dconv/1.6/management.html#9.1\" rel=\"nofollow\">management</a> documentation of HAProxy.</p>\n<ul>\n<li><strong>aggr-server-metrics</strong> Defaults to <strong>false</strong></li>\n</ul>\n<p>Aggregates server\u2019s statistics across all backends.</p>\n<ul>\n<li><strong>exclude-frontends</strong> Unset by default</li>\n</ul>\n<p>A file which contains one frontend name per line for which processing is\nskipped.</p>\n<ul>\n<li><strong>exclude-backends</strong> Unset by default</li>\n</ul>\n<p>A file which contains one backend name per line for which processing is\nskipped.</p>\n<ul>\n<li><strong>per-process-metrics</strong> Defaults to <strong>false</strong></li>\n</ul>\n<p>HAProxy daemon provides statistics and by default <strong>haproxystat-process</strong>\naggregates those statistics when HAProxy runs in multiprocess mode\n(nbproc &gt; 1).</p>\n<p>Set this to <strong>true</strong> to get those statistics also per process as well.\nThis is quite useful for monitoring purposes where someone wants to monitor\nsessions per process in order to see if traffic is evenly distributed to all\nprocesses by the kernel.</p>\n<p>It is also useful in setups where configuration for frontends and backends is\nunevenly spread across all processes, for instance processes 1-4 manage SSL\nfrontends and processes 5-7 manage noSSL frontends.</p>\n<p>This adds another path in Graphite under haproxy space:</p>\n<pre>loadbalancers.lb-01.haproxy.daemon.process.&lt;process_num&gt;.&lt;metric&gt;\n</pre>\n<ul>\n<li><strong>calculate-percentages</strong> Defaults to <strong>false</strong></li>\n</ul>\n<p>Calculates percentages for a selection of metrics for HAProxy daemon. When\n<strong>per-process-metrics</strong> is set to <strong>true</strong> the calculation happens also per\nHAProxy process. This adds the following metric names:</p>\n<pre>ConnPercentage\nConnRatePercentage\nSslRatePercentage\nSslConnPercentage\n</pre>\n<p>Those metrics can be used for alerting when the current usage on connections\nis very close the configured limit.</p>\n<ul>\n<li><strong>liveness-check-interval</strong> Defaults to <strong>10</strong> (seconds)</li>\n</ul>\n<p>How often to check if all workers are alive and trigger a termination if at\nleast one is dead.</p>\n</div>\n<div id=\"graphite-section\">\n<h3><a href=\"#id16\" rel=\"nofollow\">graphite section</a></h3>\n<p>This dispatcher <strong>is enabled</strong> by default and it can\u2019t be disabled.</p>\n<ul>\n<li><strong>server</strong> Defaults to <strong>127.0.0.1</strong></li>\n</ul>\n<p>Graphite server to connect to.</p>\n<ul>\n<li><strong>port</strong>  Defaults to <strong>3002</strong></li>\n</ul>\n<p>Graphite port to connect to.</p>\n<ul>\n<li><strong>retries</strong> Defaults to <strong>3</strong></li>\n</ul>\n<p>Number of times to reconnect to Graphite after a failure.</p>\n<ul>\n<li><strong>interval</strong> Defaults to <strong>1.8</strong> (seconds)</li>\n</ul>\n<p>Time to wait before trying to reconnect to Graphite after a failure.</p>\n<ul>\n<li><strong>connect-timeout</strong> Defaults to <strong>1</strong> (seconds)</li>\n</ul>\n<p>Time to wait for establishing a connection to Graphite relay.</p>\n<ul>\n<li><strong>write-timeout</strong> Defaults to <strong>1</strong> (seconds)</li>\n</ul>\n<p>Time to wait on sending data to Graphite relay.</p>\n<ul>\n<li><strong>delay</strong> Defaults to <strong>10</strong> (seconds)</li>\n</ul>\n<p>How long to wait before trying to connect again after number of retries has\nexceeded the threshold set in <strong>retries</strong>. During the delay period metrics are\nstored in the queue of the dispatcher, see <strong>queue-size</strong>.</p>\n<ul>\n<li><strong>backoff</strong> Defaults to <strong>2</strong></li>\n</ul>\n<p>A simple exponential backoff to apply for each retry.</p>\n<ul>\n<li><strong>namespace</strong> Defaults to <strong>loadbalancers</strong></li>\n</ul>\n<p>A top level graphite namespace.</p>\n<ul>\n<li><strong>prefix-hostname</strong> Defaults to <strong>true</strong></li>\n</ul>\n<p>Insert the hostname of the load balancer in the Graphite namespace, example:</p>\n<pre>loadbalancers.lb-01.haproxy.\n</pre>\n<ul>\n<li><strong>fqdn</strong> Defaults to <strong>true</strong></li>\n</ul>\n<p>Use FQDN or short name in the graphite namespace</p>\n<ul>\n<li><strong>queue-size</strong>  Defaults to <strong>1000000</strong></li>\n</ul>\n<p>haproxystats-process uses a queue to store metrics which failed to be sent due\nto a connection error/timeout. This is a First In First Out queueing system.\nWhen the queue reaches the limit, the oldest items are removed to free space.</p>\n<ul>\n<li><strong>group-namespace</strong> Unset by default.</li>\n</ul>\n<p>group graphite metrics by patterns. When a frontend, backend or server matches a\ngiven pattern, the metric will be prefixed by this namespace, plus a\nconfigurable group name which must be specified in the <strong>frontend-groups</strong>,\n<strong>backend-groups</strong> or <strong>server-groups</strong> sections. These sections consist of\ngroup names and their corresponding regular expression that will be matched\nagainst frontend, backend or server names (depending on the section).</p>\n<p>For example:</p>\n<p>Let\u2019s assume our metrics look something like:</p>\n<pre>loadbalancers.lb-01.haproxy.frontend.foo-001.&lt;metric&gt;\nloadbalancers.lb-01.haproxy.frontend.foo-002.&lt;metric&gt;\n...\nloadbalancers.lb-01.haproxy.frontend.bar-001.&lt;metric&gt;\nloadbalancers.lb-01.haproxy.frontend.bar-002.&lt;metric&gt;\n...\n</pre>\n<p>And we want them to be grouped to like this:</p>\n<pre>loadbalancers.lb-01.haproxy.flavor.abc.frontend.foo-001.&lt;metric&gt;\nloadbalancers.lb-01.haproxy.flavor.abc.frontend.foo-002.&lt;metric&gt;\n...\nloadbalancers.lb-01.haproxy.flavor.xyz.frontend.bar-001.&lt;metric&gt;\nloadbalancers.lb-01.haproxy.flavor.xyz.frontend.bar-002.&lt;metric&gt;\n...\n</pre>\n<p>The configuration should contain these settings:</p>\n<pre>[graphite]\ngroup-namespace = flavor\n\n[frontend-groups]\nabc = ^foo-\nxyz = ^bar-\n</pre>\n<p>Note that if the <strong>group-namespace</strong> setting is specified, then at least one of\n<strong>frontend-groups</strong>, <strong>backend-groups</strong> or <strong>server-groups</strong> sections must be\nspecified as well.</p>\n<p>Also note that if frontend, backend or server names contain dots, these will be\nconverted to underscores for graphite \u2013 because dots are graphite\u2019s namespace\nseparator. The patterns will have to take this into account.</p>\n<ul>\n<li><strong>group-namespace-double-writes</strong> Unset by default.</li>\n</ul>\n<p>Boolean; required only if <strong>group-namespace</strong> is specified. If True, send to\ngraphite the original metric as well as the grouped metrics. If False, send\nonly the grouped metrics. (See <strong>group-namespace</strong>.)</p>\n</div>\n<div id=\"frontend-groups-backend-groups-and-server-groups-sections\">\n<h3><a href=\"#id17\" rel=\"nofollow\">frontend-groups, backend-groups, and server-groups sections</a></h3>\n<p>Specify the patterns to match against frontend, backend and/or server names, to\ngroup graphite metrics and give them a variable prefix. See <strong>group-namespace</strong>.</p>\n<p>These sections are optional, unless <strong>group-namespace</strong> is set.</p>\n</div>\n<div id=\"local-store-section\">\n<h3><a href=\"#id18\" rel=\"nofollow\">local-store section</a></h3>\n<p>This dispatcher <strong>isn\u2019t</strong> enabled by default.</p>\n<p>The primarily use of local-store dispatcher is to debug/troubleshoot possible\nproblems with the processing or/and with Graphite. There isn\u2019t any clean-up\nprocess in place, thus you need remove the files after they are created.\nDon\u2019t leave it enabled for more than 1 hour as it can easily fill up the disk\nin environments with hundreds frontends/backends and thousands servers.</p>\n<ul>\n<li><strong>dir</strong> Defaults to <strong>/var/lib/haproxystats/local-store</strong></li>\n</ul>\n<p>A directory to stores statistics after they have been processed. The current\nformat is compatible with Graphite.</p>\n</div>\n</div>\n<div id=\"systemd-integration\">\n<h2><a href=\"#id19\" rel=\"nofollow\">Systemd integration</a></h2>\n<p>haproxystats-pull and haproxystats-process are simple programs which are not\ndaemonized and they output logging messages to stdout. This is by design as it\nsimplifies the code. The daemonization and logging is off-loaded to systemd\nwhich has everything we need for that job.</p>\n<p>Under contrib/systend directory there are service files for both programs.\nThese are functional systemd Unit files which are used in production.</p>\n<p>The order in which these 2 programs start doesn\u2019t matter and there isn\u2019t any\nsoft or hard dependency between them.</p>\n<p>Furthermore, these programs don\u2019t need to run as root. It highly recommended to\ncreate a dedicated user to run them. You need to add that user to the group of\n<em>haproxy</em> and adjust socket configuration of haproxy to allow write for the\ngroup, see below an example configuration:</p>\n<pre>stats socket /run/haproxy/sock1 user haproxy group haproxy mode 660 level admin process 1\nstats socket /run/haproxy/sock2 user haproxy group haproxy mode 660 level admin process 2\nstats socket /run/haproxy/sock3 user haproxy group haproxy mode 660 level admin process 3\n</pre>\n<p>systemd Unit files use haproxystats user which has to be created prior running\nhaproxystats programs.</p>\n</div>\n<div id=\"graceful-shutdown\">\n<h2><a href=\"#id20\" rel=\"nofollow\">Graceful shutdown</a></h2>\n<p>In an effort to reduce the loss of statistics both programs support graceful\nshutdown. When <em>SIGHUP</em> or <em>SIGTERM</em> signals are sent they perform a clean exit.\nWhen a signal is sent to haproxystats-process it may take some time for the\nprogram to exit, as it waits for all workers to empty the queue.</p>\n</div>\n<div id=\"puppet-module\">\n<h2><a href=\"#id21\" rel=\"nofollow\">Puppet module</a></h2>\n<p>A puppet module is available under contrib directory which provides classes for\nconfiguring both programs.</p>\n<p>Because haproxystats-process is CPU bound program, CPU Affinity is configured\nusing systemd. By default it pins the workers to the last CPUs.</p>\n<p>You should take care of pinning haproxy processes to other CPUs in order to\navoid haproxystats-process <em>stealing</em> CPU cycles from haproxy. In production\nservers you usually pin the first 80% of CPUs to haproxy processes and you\nleave the rest of CPUs for other processes. The default template of puppet\nmodule enforces this logic.</p>\n<p>haproxystats-pull is a single threaded program which doesn\u2019t use a lot of CPU\ncycles and by default is assigned to the last CPU.</p>\n</div>\n<div id=\"ansible-playbook\">\n<h2><a href=\"#id22\" rel=\"nofollow\">Ansible Playbook</a></h2>\n<p>A Ansible playbook is available under contrib directory. For installation\ninstruction of the playbook please read Installation chapter of this document.</p>\n</div>\n<div id=\"nagios-checks\">\n<h2><a href=\"#id23\" rel=\"nofollow\">Nagios checks</a></h2>\n<p>Several nagios checks are provided for monitoring purposes, they can be found\nunder contrib/nagios directory.</p>\n<ul>\n<li>check_haproxystats_process_number_of_procs.sh</li>\n</ul>\n<p>Monitor the number of processes of haproxystats-process program. Systemd\nmonitors only the parent process and this check helps to detect cases where\nsome worker(s) die unexpectedly</p>\n<ul>\n<li>check_haproxystats_process.sh</li>\n</ul>\n<p>A wrapper around systemctl tool to detect a dead parent process.</p>\n<ul>\n<li>check_haproxystats_pull.sh</li>\n</ul>\n<p>A wrapper around systemctl tool to a check if haproxystats-pull is running.</p>\n<ul>\n<li>check_haproxystats_queue_size.py</li>\n</ul>\n<p>Checks the size of the <em>incoming</em> directory queue which is consumed by\nhaproxystats-process and alert when exceeds a threshold.</p>\n</div>\n<div id=\"starting-the-programs\">\n<h2><a href=\"#id24\" rel=\"nofollow\">Starting the programs</a></h2>\n<pre>haproxystats-pull -f ./haproxystats.conf\n</pre>\n<pre>haproxystats-process -f ./haproxystats.conf\n</pre>\n<p>Usage:</p>\n<pre>% haproxystats-pull -h\nPulls statistics from HAProxy daemon over UNIX socket(s)\n\nUsage:\n    haproxystats-pull [-f &lt;file&gt;] [-p | -P]\n\nOptions:\n    -f, --file &lt;file&gt;  configuration file with settings\n                       [default: /etc/haproxystats.conf]\n    -p, --print        show default settings\n    -P, --print-conf   show configuration\n    -h, --help         show this screen\n    -v, --version      show version\n\n\n% haproxystats-process -h\nProcesses statistics from HAProxy and pushes them to Graphite\n\nUsage:\n    haproxystats-process [-f &lt;file&gt;] [-d &lt;dir&gt;] [-p | -P]\n\nOptions:\n    -f, --file &lt;file&gt;  configuration file with settings\n                       [default: /etc/haproxystats.conf]\n    -d, --dir &lt;dir&gt;    directory with additional configuration files\n    -p, --print        show default settings\n    -P, --print-conf   show configuration\n    -h, --help         show this screen\n    -v, --version      show version\n</pre>\n</div>\n<div id=\"development\">\n<h2><a href=\"#id25\" rel=\"nofollow\">Development</a></h2>\n<p>I would love to hear what other people think about <strong>haproxystats</strong> and provide\nfeedback. Please post your comments, bug reports and wishes on my <a href=\"https://github.com/unixsurfer/haproxystats/issues\" rel=\"nofollow\">issues page</a>.</p>\n<div id=\"how-to-setup-a-development-environment\">\n<h3><a href=\"#id26\" rel=\"nofollow\">How to setup a development environment</a></h3>\n<p>Install HAProxy:</p>\n<pre>% sudo apt-get install haproxy\n</pre>\n<p>Use a basic HAProxy configuration in multiprocess mode:</p>\n<pre>global\n    log 127.0.0.1 len 2048 local2\n    chroot /var/lib/haproxy\n    stats socket /run/haproxy/admin1.sock mode 666 level admin process 1\n    stats socket /run/haproxy/admin2.sock mode 666 level admin process 2\n    stats socket /run/haproxy/admin3.sock mode 666 level admin process 3\n    stats socket /run/haproxy/admin4.sock mode 666 level admin process 4\n    # allow read/write access to anyone----------^\n    stats timeout 30s\n    user haproxy\n    group haproxy\n    daemon\n    nbproc 4\n    cpu-map 1 0\n    cpu-map 2 1\n    cpu-map 3 1\n    cpu-map 4 0\n\ndefaults\n    log global\n    mode    http\n    timeout connect 5000\n    timeout client  50000\n    timeout server  50000\n\nfrontend frontend_proc1\n    bind 0.0.0.0:81 process 1\n    default_backend backend_proc1\n\nfrontend frontend_proc2\n    bind 0.0.0.0:82 process 2\n    default_backend backend_proc1\n\nfrontend frontend1_proc34\n    bind :83 process 3\n    bind :83 process 4\n    default_backend backend1_proc34\n\nbackend backend_proc1\n    bind-process 1\n    default-server inter 1000s\n    option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n    server member1_proc1 10.189.224.169:80 weight 100 check fall 2 rise 3\n    server member2_proc1 10.196.70.109:80 weight 100 check fall 2 rise 3\n    server bck_all_srv1 10.196.70.109:88 weight 100 check fall 2 rise 3\n\nbackend backend1_proc34\n    bind-process 3,4\n    default-server inter 1000s\n    option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n    server bck1_proc34_srv1 10.196.70.109:80 check fall 2 inter 5s rise 3\n    server bck1_proc34_srv2 10.196.70.109:80 check fall 2 inter 5s rise 3\n    server bck_all_srv1 10.196.70.109:80 check fall 2 inter 5s rise 3\n\nbackend backend_proc2\n    bind-process 2\n    default-server inter 1000s\n    option httpchk GET / HTTP/1.1\\r\\nHost:\\ .com\\r\\nUser-Agent:\\ HAProxy\n    server bck_proc2_srv1_proc2 127.0.0.1:8001 check fall 2 inter 5s rise 3\n    server bck_proc2_srv2_proc2 127.0.0.1:8002 check fall 2 inter 5s rise 3\n    server bck_proc2_srv3_proc2 127.0.0.1:8003 check fall 2 inter 5s rise 3\n    server bck_proc2_srv4_proc2 127.0.0.1:8004 check fall 2 inter 5s rise 3\n</pre>\n<p>Start HAProxy and check it is up:</p>\n<pre>sudo systemctl start haproxy.service;systemctl status -l haproxy.service\n</pre>\n<p>Create a python virtual environment using virtualenvwrapper tool:</p>\n<pre>mkvirtualenv --python=`which python3` haproxystats-dev\n</pre>\n<p><strong>Do not</strong> exit the <em>haproxystats-dev</em> virtual environment.</p>\n<p>Clone the project, if you are planning to contribute then you should fork it on\nGitHub and clone that project instead:</p>\n<pre>mkdir ~/repo;cd ~/repo\ngit clone https://github.com/unixsurfer/haproxystats\n</pre>\n<p>Install necessary libraries:</p>\n<pre>cd haproxystats\npip install -U pbr setuptools\npip install -r ./requirements.txt\n</pre>\n<p>Start a TCP server which acts a Graphite relay and listens on 127.0.0.1:39991:</p>\n<pre>python3 ./contrib/tcp_server.py\n</pre>\n<p>Install haproxystats:</p>\n<pre>python setup.py install\n</pre>\n<p>Create necessary directory structure:</p>\n<pre>mkdir -p ./var/var/lib/haproxystats\nmkdir -p ./var/etc\nmkdir -p ./var/etc/haproxystats.d\n</pre>\n<p>Adjust the following configuration and save it in ./var/etc/haproxystats.conf:</p>\n<pre>[DEFAULT]\nloglevel = debug\nretries  = 2\ntimeout  = 1\ninterval = 2\n\n[paths]\nbase-dir = /home/&lt;username&gt;/repo/haproxystats/var/var/lib/haproxystats\n\n[pull]\nsocket-dir    = /run/haproxy\nretries       = 1\ntimeout       = 0.1\ninterval      = 0.5\npull-timeout  = 10\npull-interval = 10\ndst-dir       = ${paths:base-dir}/incoming\ntmp-dst-dir   = ${paths:base-dir}/incoming.tmp\nworkers       = 8\n\n[process]\nsrc-dir               = ${paths:base-dir}/incoming\nworkers               = 2\ncalculate-percentages = true\nper-process-metrics   = true\n\n[graphite]\nserver          = 127.0.0.1\nport            = 39991\nretries         = 3\ninterval        = 0.8\ntimeout         = 0.9\ndelay           = 10\nbackoff         = 2\nnamespace       = loadbalancers\nprefix_hostname = true\nfqdn            = true\nqueue-size      = 1000\n\n[local-store]\ndir = ${paths:base-dir}/local-store\n</pre>\n<p>Start haproxystats-pull and haproxystats-process on 2 different terminals:</p>\n<pre>haproxystats-pull -f var/etc/haproxystats.conf\nhaproxystats-process -f var/etc/haproxystats.conf\n</pre>\n<p>Exit from <em>haproxystats-dev</em> virtual environment:</p>\n<pre>deactivate\n</pre>\n<p><strong>Start hacking and don\u2019t forget to make a Pull Request</strong></p>\n</div>\n</div>\n<div id=\"installation\">\n<h2><a href=\"#id27\" rel=\"nofollow\">Installation</a></h2>\n<p>Use pip:</p>\n<pre>pip install haproxystats\n</pre>\n<p>From Source:</p>\n<pre>sudo python setup.py install\n</pre>\n<p>Build (source) RPMs:</p>\n<pre>python setup.py clean --all; python setup.py bdist_rpm\n</pre>\n<p>Build a source archive for manual installation:</p>\n<pre>python setup.py sdist\n</pre>\n<p>Use Ansible Playbook:</p>\n<p>To deploy haproxystats By Ansible Playbook go to contrib/ansible-playbook\ndirectory:</p>\n<pre>cd contrib/ansible-playbook\n</pre>\n<p>Then enter your haproxy server IP address in hosts file:</p>\n<pre>vi hosts\n</pre>\n<p>After that set information of your environment in variable file:</p>\n<pre>vi group_vars/all\n</pre>\n<p>Now for run Ansible Playbook use this command:</p>\n<pre>ansible-playbook -i hosts main-playbook.yml\n</pre>\n<p>When Ansible Playbook run successful completely, you can take control haproxystats-pull and haproxystats-process by systemd:</p>\n<pre>systemctl start haproxystats-pull.service\n\nsystemctl start haproxystats-process.service\n</pre>\n</div>\n<div id=\"how-to-make-a-release\">\n<h2><a href=\"#id28\" rel=\"nofollow\">How to make a release</a></h2>\n<ol>\n<li><p>Bump version in haproxystats/__init__.py</p>\n</li>\n<li><p>Commit above change with:</p>\n<pre>git commit -av -m'RELEASE 0.1.3 version'\n</pre>\n</li>\n<li><p>Create a signed tag, pbr will use this for the version number:</p>\n<pre>git tag -s 0.1.3 -m 'bump release'\n</pre>\n</li>\n<li><p>Create the source distribution archive (the archive will be placed in the\n<strong>dist</strong> directory):</p>\n<pre>python setup.py sdist\n</pre>\n</li>\n<li><p>pbr updates ChangeLog file and we want to squeeze this change to the\nprevious commit, thus run:</p>\n<pre>git commit -av --amend\n</pre>\n</li>\n<li><p>Move current tag to the last commit:</p>\n<pre>git tag -fs 0.1.3 -m 'bump release'\n</pre>\n</li>\n<li><p>Push changes:</p>\n<pre>git push;git push --tags\n</pre>\n</li>\n<li><p>Upload to Python Package Index:</p>\n<pre>twine upload -s -p  dist/*\n</pre>\n</li>\n</ol>\n</div>\n<div id=\"contributors\">\n<h2><a href=\"#id29\" rel=\"nofollow\">Contributors</a></h2>\n<p>The following people have contributed to project with feedback and code reviews</p>\n<ul>\n<li>K\u00e1roly Nagy <a href=\"https://github.com/charlesnagy\" rel=\"nofollow\">https://github.com/charlesnagy</a></li>\n<li>Dan Achim <a href=\"https://github.com/danakim\" rel=\"nofollow\">https://github.com/danakim</a></li>\n</ul>\n</div>\n<div id=\"licensing\">\n<h2><a href=\"#id30\" rel=\"nofollow\">Licensing</a></h2>\n<p>Apache 2.0</p>\n</div>\n<div id=\"acknowledgement\">\n<h2><a href=\"#id31\" rel=\"nofollow\">Acknowledgement</a></h2>\n<p>This program was originally developed for Booking.com.  With approval\nfrom Booking.com, the code was generalised and published as Open Source\non github, for which the author would like to express his gratitude.</p>\n</div>\n<div id=\"contacts\">\n<h2><a href=\"#id32\" rel=\"nofollow\">Contacts</a></h2>\n<p><strong>Project website</strong>: <a href=\"https://github.com/unixsurfer/haproxystats\" rel=\"nofollow\">https://github.com/unixsurfer/haproxystats</a></p>\n<p><strong>Author</strong>: Pavlos Parissis &lt;<a href=\"mailto:pavlos.parissis%40gmail.com\">pavlos<span>.</span>parissis<span>@</span>gmail<span>.</span>com</a>&gt;</p>\n</div>\n\n          </div>"}, "last_serial": 5419714, "releases": {"0.3.10": [{"comment_text": "", "digests": {"md5": "572022bb9fb8b3f68907b05819a27529", "sha256": "540dc00cb587612c3e1e435ad1f12e2a346060dffd789c4d73140f306a4febe3"}, "downloads": -1, "filename": "haproxystats-0.3.10.tar.gz", "has_sig": true, "md5_digest": "572022bb9fb8b3f68907b05819a27529", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 120007, "upload_time": "2016-07-17T00:12:50", "upload_time_iso_8601": "2016-07-17T00:12:50.497444Z", "url": "https://files.pythonhosted.org/packages/03/0a/cbad508bb80322a82d6857f55b8fc8ee387208540505fab54b8f855fd729/haproxystats-0.3.10.tar.gz", "yanked": false}], "0.3.12": [{"comment_text": "", "digests": {"md5": "332067b2daacaa1b97553892cf28a1dd", "sha256": "d37c96eab1ac5c16b6171cde011e57f3b4dc5497afa2fc1b66c0accd9ae335ba"}, "downloads": -1, "filename": "haproxystats-0.3.12.tar.gz", "has_sig": true, "md5_digest": "332067b2daacaa1b97553892cf28a1dd", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 121393, "upload_time": "2016-09-28T23:21:50", "upload_time_iso_8601": "2016-09-28T23:21:50.414071Z", "url": "https://files.pythonhosted.org/packages/c1/1f/d3e3fa0fed928da50c81c0189d9115c9b8f28a91909b6d70bbc018fa384a/haproxystats-0.3.12.tar.gz", "yanked": false}], "0.3.14": [{"comment_text": "", "digests": {"md5": "89fb8db186beef226837f9c5281e428e", "sha256": "6a06612a595f035391e835ccd9d26e47c86df573e994293a0b5021cd8bbf02f2"}, "downloads": -1, "filename": "haproxystats-0.3.14.tar.gz", "has_sig": true, "md5_digest": "89fb8db186beef226837f9c5281e428e", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 121753, "upload_time": "2016-10-30T14:48:24", "upload_time_iso_8601": "2016-10-30T14:48:24.172916Z", "url": "https://files.pythonhosted.org/packages/ab/02/02b62e38ea02f1623183f0d7953941e6526ae94b6ac62feebd4f1f55405d/haproxystats-0.3.14.tar.gz", "yanked": false}], "0.3.15": [{"comment_text": "", "digests": {"md5": "d1c31cf58da7feb7a99934f77934918a", "sha256": "7398ab86d644c505faf6b9133e2a432450114697c96e006ed0554df4e4f5e8ae"}, "downloads": -1, "filename": "haproxystats-0.3.15.tar.gz", "has_sig": true, "md5_digest": "d1c31cf58da7feb7a99934f77934918a", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 125352, "upload_time": "2017-10-04T20:48:39", "upload_time_iso_8601": "2017-10-04T20:48:39.251820Z", "url": "https://files.pythonhosted.org/packages/16/35/9c9f3184064a490acea83971df91e109cfc56c009a1806257c428bf6b9a2/haproxystats-0.3.15.tar.gz", "yanked": false}], "0.3.8": [{"comment_text": "", "digests": {"md5": "bd127dffe899417e05b297228624234f", "sha256": "87e067cf3dcda6adaccbee8deabe7f9c7e92f902946b112f4956ad49cb7ccdb8"}, "downloads": -1, "filename": "haproxystats-0.3.8.tar.gz", "has_sig": true, "md5_digest": "bd127dffe899417e05b297228624234f", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 119874, "upload_time": "2016-05-07T18:21:44", "upload_time_iso_8601": "2016-05-07T18:21:44.699640Z", "url": "https://files.pythonhosted.org/packages/bf/82/ae644e92f9d0bb51858238c0ef8150e112f63940485cd1e9233fc32925db/haproxystats-0.3.8.tar.gz", "yanked": false}], "0.4.0": [{"comment_text": "", "digests": {"md5": "a5e4354491ee927ad11dc0effc047bc3", "sha256": "fbfe5566516af1e07e20cd5f95aa5550fb32d2114540ed83cd049d341d04b807"}, "downloads": -1, "filename": "haproxystats-0.4.0.tar.gz", "has_sig": false, "md5_digest": "a5e4354491ee927ad11dc0effc047bc3", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 127046, "upload_time": "2018-10-05T09:31:07", "upload_time_iso_8601": "2018-10-05T09:31:07.077831Z", "url": "https://files.pythonhosted.org/packages/3a/40/9e1b86191ea61c77419154f337e4c30d79b880dafe6fab2956f9b55327d7/haproxystats-0.4.0.tar.gz", "yanked": false}], "0.4.1": [{"comment_text": "", "digests": {"md5": "58a6c17a60627dc3b23f18626601185b", "sha256": "7956fa2bb5990fed544d4c3d0ce804e7272c6fcf291bfb0dba07d22e7f5bae27"}, "downloads": -1, "filename": "haproxystats-0.4.1.tar.gz", "has_sig": false, "md5_digest": "58a6c17a60627dc3b23f18626601185b", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 127294, "upload_time": "2018-11-20T21:23:39", "upload_time_iso_8601": "2018-11-20T21:23:39.919138Z", "url": "https://files.pythonhosted.org/packages/50/38/5783584d3f885d3bc935374de0677cb10ccc8eb3da590fc070cfb4667397/haproxystats-0.4.1.tar.gz", "yanked": false}], "0.4.2": [{"comment_text": "", "digests": {"md5": "0e84d635d685de1e094e92d47c385923", "sha256": "5df25b6994207e6e7927a4e384439328589a52c026f3f11dfd4e67a26fb5a961"}, "downloads": -1, "filename": "haproxystats-0.4.2.tar.gz", "has_sig": false, "md5_digest": "0e84d635d685de1e094e92d47c385923", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 127307, "upload_time": "2018-11-22T21:37:57", "upload_time_iso_8601": "2018-11-22T21:37:57.050612Z", "url": "https://files.pythonhosted.org/packages/31/3b/dcb34a27968a255424bf87d1dd8433c52cdabd25792a5362fd58d5f2524a/haproxystats-0.4.2.tar.gz", "yanked": false}], "0.5.1": [{"comment_text": "", "digests": {"md5": "b291c60e46d2cf1ce3919d7804df38a0", "sha256": "17e9db6d6b6321360bde7f9c700f00746ece929010699fe66ee4de884fbc389c"}, "downloads": -1, "filename": "haproxystats-0.5.1.tar.gz", "has_sig": false, "md5_digest": "b291c60e46d2cf1ce3919d7804df38a0", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 131273, "upload_time": "2019-06-19T10:52:37", "upload_time_iso_8601": "2019-06-19T10:52:37.865725Z", "url": "https://files.pythonhosted.org/packages/19/5d/2960fd0df575e2c131f6d3b16a9997d39ba5c1a3fd183a1ac51af8ad6299/haproxystats-0.5.1.tar.gz", "yanked": false}]}, "urls": [{"comment_text": "", "digests": {"md5": "b291c60e46d2cf1ce3919d7804df38a0", "sha256": "17e9db6d6b6321360bde7f9c700f00746ece929010699fe66ee4de884fbc389c"}, "downloads": -1, "filename": "haproxystats-0.5.1.tar.gz", "has_sig": false, "md5_digest": "b291c60e46d2cf1ce3919d7804df38a0", "packagetype": "sdist", "python_version": "source", "requires_python": null, "size": 131273, "upload_time": "2019-06-19T10:52:37", "upload_time_iso_8601": "2019-06-19T10:52:37.865725Z", "url": "https://files.pythonhosted.org/packages/19/5d/2960fd0df575e2c131f6d3b16a9997d39ba5c1a3fd183a1ac51af8ad6299/haproxystats-0.5.1.tar.gz", "yanked": false}], "timestamp": "Fri May  8 00:52:29 2020"}